<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Music Classes Manager (Pro)</title>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#4f46e5">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="icon-192.png">

    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Hind+Siliguri:wght@300;400;600&family=Noto+Serif+Bengali:wght@700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        :root {
            /* Light Theme Variables (Default) */
            --primary: #4f46e5; --primary-dark: #4338ca; --secondary: #64748b;
            --success: #10b981; --danger: #ef4444; --warning: #f59e0b;
            --info: #3b82f6; --pink: #ec4899; 
            --bg-body: #f3f4f6;
            --bg-card: #ffffff; 
            --bg-input: #f9fafb;
            --text-main: #1f2937; 
            --text-muted: #6b7280;
            --border-color: #e2e8f0;
            --radius: 12px; --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --nav-height: 70px;
        }

        /* Dark Theme Variables */
        [data-theme="dark"] {
            --primary: #6366f1; --primary-dark: #4f46e5; --secondary: #94a3b8;
            --bg-body: #0f172a;
            --bg-card: #1e293b;
            --bg-input: #334155;
            --text-main: #f1f5f9;
            --text-muted: #cbd5e1;
            --border-color: #334155;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
        }

        body { 
            font-family: 'Poppins', sans-serif; background-color: var(--bg-body); 
            color: var(--text-main); margin: 0; padding: 0; 
            padding-bottom: calc(var(--nav-height) + 20px);
            -webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        ul::-webkit-scrollbar { width: 4px; }
        ul::-webkit-scrollbar-track { background: var(--bg-body); }
        ul::-webkit-scrollbar-thumb { background: var(--secondary); border-radius: 4px; }

        header { 
            background: var(--bg-card); padding: 10px 20px;
            position: sticky; top: 0; z-index: 100;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            display: flex; align-items: center; justify-content: space-between;
            height: 60px;
            transition: background 0.3s ease;
        }
        .header-content { display: flex; align-items: center; gap: 12px; }
        #headerLogo { height: 40px; width: auto; border-radius: 6px; display: none; }
        header h1 { margin: 0; font-size: 16px; font-weight: 600; color: var(--primary); line-height: 1.2; }
        #liveClock { font-size: 10px; color: var(--text-muted); font-weight: 500; text-align: right; }

        .container { width: 95%; max-width: 800px; margin: 15px auto; }

        .bottom-nav {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background: var(--bg-card); height: var(--nav-height);
            display: flex; justify-content: space-around; align-items: center;
            box-shadow: 0 -2px 15px rgba(0,0,0,0.08);
            z-index: 990; border-top-left-radius: 15px; border-top-right-radius: 15px;
            transition: background 0.3s ease;
        }
        .nav-item {
            border: none; background: none; display: flex; flex-direction: column;
            align-items: center; color: var(--text-muted); font-size: 8px; font-weight: 500;
            padding: 5px; flex-grow: 1; transition: 0.2s; cursor: pointer;
        }
        .nav-item i { font-size: 16px; margin-bottom: 4px; }
        .nav-item.active { color: var(--primary); }
        .nav-item.active i { transform: translateY(-2px); }
        .tab-buttons { display: none; } 
        
        .tab-content { display: none; animation: fadeIn 0.3s ease; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        .dashboard-grid { display: grid; grid-template-columns: 1fr; gap: 15px; margin-top: 15px; }
        @media (min-width: 768px) { .dashboard-grid { grid-template-columns: repeat(2, 1fr); } }

        .dashboard-card {
            background: var(--bg-card); border-radius: var(--radius);
            padding: 20px; box-shadow: var(--shadow);
            border-top: 4px solid var(--primary); margin-bottom: 15px;
            transition: background 0.3s ease;
        }
        h3 { margin-top: 0; font-size: 16px; margin-bottom: 15px; color: var(--text-main); border-bottom: 1px solid var(--border-color); padding-bottom: 10px; }
        
        .summary-box { display: flex; justify-content: space-between; background: var(--bg-input); padding: 15px; border-radius: var(--radius); margin-top: 10px; gap: 10px; border: 1px solid var(--border-color); }
        .summary-box > div { flex: 1; text-align: center; border-right: 1px solid var(--border-color); cursor: pointer; }
        .summary-box > div:last-child { border-right: none; }
        .summary-box h4 { font-size: 11px; color: var(--text-muted); text-transform: uppercase; margin: 0 0 5px 0; }
        .summary-box p { font-size: 18px; font-weight: 700; margin: 0; color: var(--text-main); }
        
        .clickable-stat { cursor: pointer; } 
        .clickable-stat:active { opacity: 0.7; }
        
        .summary-collected { color: var(--success) !important; } .summary-due { color: var(--danger) !important; }

        .comparison-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px; }
        .comp-card { background: var(--bg-input); padding: 10px; border-radius: 8px; text-align: center; border: 1px solid var(--border-color); }
        .comp-card strong { color: var(--text-main); }
        .comp-diff { font-size: 12px; font-weight: bold; margin-top: 5px; }
        .diff-up { color: var(--success); } .diff-down { color: var(--danger); }

        .form-group { margin-bottom: 15px; }
        .form-grid { display: grid; grid-template-columns: 1fr; gap: 15px; }
        label { font-size: 13px; font-weight: 500; color: var(--text-muted); margin-bottom: 6px; display: block; }
        input, select, textarea { width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 14px; background: var(--bg-input); color: var(--text-main); box-sizing: border-box; }
        input:focus { outline: none; border-color: var(--primary); }

        button, .btn-like {
            padding: 10px 16px; border-radius: 8px; border: none; font-size: 14px; font-weight: 500;
            cursor: pointer; display: inline-flex; align-items: center; justify-content: center; gap: 8px;
            color: white; text-decoration: none; font-family: 'Poppins', sans-serif;
        }
        .btn-primary { background: var(--primary); } .btn-success { background: var(--success); }
        .btn-danger { background: var(--danger); } .btn-warning { background: var(--warning); color: white; }
        .btn-info { background: var(--info); } .btn-secondary { background: var(--secondary); }
        .btn-whatsapp, .btn-call, .btn-sms, .btn-mail, .btn-receipt, .btn-welcome { font-size: 11px !important; padding: 6px 10px !important; border-radius: 4px; margin: 2px; }
        .btn-whatsapp { background: #25D366; } .btn-call { background: #059669; }
        .btn-sms { background: #d97706; } .btn-mail { background: #2563eb; } .btn-receipt { background: #7c3aed; }
        .btn-welcome { background: #6a1b9a; }

        table { width: 100%; border-collapse: separate; border-spacing: 0; }
        @media (max-width: 768px) {
            thead { display: none; } 
            tr { display: block; background: var(--bg-card); border-radius: 12px; padding: 15px; margin-bottom: 15px; box-shadow: var(--shadow); border: 1px solid var(--border-color); }
            td { display: block; padding: 5px 0; border: none; text-align: left; color: var(--text-main); }
            td.action-buttons { margin-top: 10px; display: flex; flex-wrap: wrap; gap: 5px; }
        }
        @media (min-width: 769px) { th { background: var(--bg-input); padding: 12px; text-align: left; color: var(--text-muted); font-size: 12px; border-bottom: 1px solid var(--border-color); } td { padding: 12px; border-bottom: 1px solid var(--border-color); color: var(--text-main); } }

        /* Status Colors */
        .paid { border-left: 5px solid var(--success) !important; background-color: rgba(16, 185, 129, 0.1) !important; }
        .unpaid { border-left: 5px solid var(--danger) !important; background-color: rgba(239, 68, 68, 0.1) !important; }
        .pending { border-left: 5px solid var(--warning) !important; }
        .has-dues-alert { background-color: rgba(220, 38, 38, 0.1) !important; border-left: 5px solid #dc2626 !important; }
        .inactive-student { opacity: 0.8; filter: grayscale(100%); background: var(--bg-input) !important; border: 1px solid var(--border-color); }
        
        .student-cell { display: flex; align-items: center; width: 100%; }
        /* BLACK BORDER FOR PHOTO */
        .student-thumb { width: 45px; height: 45px; border-radius: 50%; object-fit: cover; margin-right: 15px; border: 2px solid #000 !important; box-shadow: 0 2px 4px rgba(0,0,0,0.1); flex-shrink: 0; }
        .student-info { display: flex; flex-direction: column; flex-grow: 1; min-width: 0; }
        .student-name-link { font-weight: 600; color: var(--text-main); font-size: 14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: block; }
        .student-phone-sub { font-size: 12px; color: var(--text-muted); margin-top: 2px; }
        .student-time-sub { font-size: 11px; color: var(--text-muted); display: block; }
        .status-present { color: var(--success); font-weight: bold; } .status-absent { color: var(--danger); font-weight: bold; }

        .reminder-item {
            background: var(--bg-card); padding: 12px; border-radius: 8px; margin-bottom: 8px;
            border-left: 4px solid var(--warning); display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05); color: var(--text-main);
        }

        .modal {
            display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; 
            background-color: rgba(15, 23, 42, 0.8); backdrop-filter: blur(4px); align-items: center; justify-content: center;
        }
        .modal-content {
            background-color: var(--bg-card); width: 90%; max-width: 600px; padding: 25px; border-radius: 16px;
            box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); max-height: 90vh; overflow-y: auto; position: relative;
            animation: slideUp 0.3s ease; color: var(--text-main); border: 1px solid var(--border-color);
        }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .close-button { float: right; font-size: 28px; color: var(--text-muted); cursor: pointer; }

        .scrollable-list {
            list-style: none; padding: 5px; margin: 0;
            max-height: 120px; overflow-y: auto;
            border: 1px solid var(--border-color);
            background: var(--bg-input);
            border-radius: 8px;
        }
        .scrollable-list li {
            padding: 5px; border-bottom: 1px solid var(--border-color); font-size: 12px; color: var(--text-main);
        }
        .scrollable-list li:last-child { border-bottom: none; }

        .search-bar { position: relative; margin-bottom: 20px; }
        .search-bar input { padding-left: 40px; border-radius: 50px; }
        .search-bar::before { content: '\f002'; font-family: "Font Awesome 6 Free"; font-weight: 900; position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: var(--text-muted); }
        
        #photoPreviewBox { width: 120px; height: 120px; border-radius: 50%; background: var(--bg-input); margin: 0 auto 15px auto; display: flex; align-items: center; justify-content: center; overflow: hidden; border: 2px dashed var(--secondary); cursor: pointer; }
        
        /* THEME ADAPTIVE SECURITY OVERLAY */
        #securityOverlay { 
            display: none; 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: #e0f7fa; 
            z-index: 9999; 
            flex-direction: column; align-items: center; justify-content: center; 
            color: var(--text-main); 
        }  
        [data-theme="dark"] #securityOverlay {
            background: var(--bg-body);
        }
        .pin-pad { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-top: 30px; }
        .pin-btn { 
            width: 70px; height: 70px; border-radius: 50%; 
            background: var(--bg-card); 
            display: flex; align-items: center; justify-content: center; 
            font-size: 24px; cursor: pointer; 
            border: 1px solid var(--border-color);
            color: var(--text-main);
            box-shadow: var(--shadow);
            transition: all 0.1s ease; 
        }
        .pin-btn:active { background-color: var(--bg-input); transform: scale(0.95); }
        .pin-dots { display: flex; gap: 15px; height: 20px; margin-bottom: 20px; }
        .pin-dot { width: 16px; height: 16px; border-radius: 50%; border: 2px solid var(--primary); }
        .pin-dot.filled { background: var(--primary); box-shadow: 0 0 10px var(--primary); }

        /* SIGNATURE MODAL STYLES */
        #signatureModal {
            background: #fff !important; /* Force white background for signature */
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 3005 !important; /* ‡¶è‡¶á ‡¶≤‡¶æ‡¶á‡¶®‡¶ü‡¶ø ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶∏‡¶Æ‡¶æ‡¶ß‡¶æ‡¶® ‡¶ï‡¶∞‡¶¨‡ßá */
        }
        
        .sig-container-wrapper {
             /* Container to hold the rotating canvas */
             position: relative;
             width: 100vw;
             height: 80vh;
             display: flex;
             align-items: center;
             justify-content: center;
             overflow: hidden;
        }

        .sig-canvas-box {
            border: 2px dashed #333;
            background: #fff;
            position: relative;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        
        .sig-toolbar {
            position: absolute;
            bottom: 20px;
            left: 0; 
            width: 100%;
            display: flex;
            justify-content: center;
            gap: 15px;
            z-index: 2002;
        }

/* --- WELCOME NOTE CSS (Large Text & No Watermark) --- */
#welcomeNoteTemplate {
    position: fixed; top: -9999px; left: -9999px; 
    width: 210mm; min-height: 297mm;
    background: #ffffff; color: #000;
    font-family: 'Hind Siliguri', sans-serif;
    padding: 40px; box-sizing: border-box;
    border: none;
}

/* Watermark REMOVED */
.wn-watermark { display: none !important; }

.wn-header { text-align: center; border-bottom: 3px solid #6a1b9a; padding-bottom: 15px; margin-bottom: 25px; position: relative; z-index: 2; }
.wn-logo { height: 90px; width: auto; margin-bottom: 10px; }
.wn-title { color: #6a1b9a; margin: 5px 0; font-size: 34px; font-weight: 800; font-family: 'Noto Serif Bengali', serif; text-transform: uppercase; line-height: 1.3; }
.wn-phone { font-weight: bold; color: #000; margin: 5px 0 0 0; font-size: 22px; }

/* Info Box */
.wn-details-box { 
    background: rgba(255, 255, 255, 0.95); border: 2px solid #ddd; 
    padding: 20px; border-radius: 12px; margin-bottom: 25px; 
    display: flex; justify-content: space-between; align-items: flex-start;
}
.wn-info-col { flex: 1; }
.wn-photo-col { width: 140px; padding-right: 15px; display: flex; justify-content: flex-end; }

.wn-row { display: flex; margin-bottom: 12px; align-items: center; font-size: 26px; } /* ‡¶∏‡¶æ‡¶á‡¶ú ‡ß®‡ß¶ ‡¶•‡ßá‡¶ï‡ßá ‡ß®‡ß® ‡¶ï‡¶∞‡¶æ ‡¶π‡¶≤‡ßã */
.wn-label { width: 200px; font-weight: bold; color: #333; }
.wn-val { flex: 1; border-bottom: 2px dotted #333; padding-left: 10px; font-weight: 600; color: #000; }

#wnStudentPhoto { 
    width: 110px; height: 130px; 
    border: 3px solid #000 !important; 
    object-fit: cover; background: #eee;
}

/* ‡¶¨‡ßü‡¶æ‡¶® (Welcome Msg) - ‡¶´‡¶®‡ßç‡¶ü ‡¶¨‡ßú ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá */
.wn-welcome-box { 
    background: #fdf2ff; padding: 25px; border-radius: 12px; 
    border-left: 8px solid #6a1b9a; margin-bottom: 30px; 
    text-align: center; 
}
.wn-welcome-title { color: #4a148c; margin-top: 0; font-size: 32px; font-weight: bold; } /* ‡ß®‡ß¨ ‡¶•‡ßá‡¶ï‡ßá ‡ß©‡ß® */
.wn-welcome-box p { font-size: 32px; line-height: 1.6; color: #333; margin: 0; font-weight: 500; } /* ‡ß®‡ß¶ ‡¶•‡ßá‡¶ï‡ßá ‡ß®‡ß¨ */

/* ‡¶®‡¶ø‡ßü‡¶Æ‡¶æ‡¶¨‡¶≤‡ßÄ (Rules) - ‡¶´‡¶®‡ßç‡¶ü ‡¶¨‡ßú ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá */
.wn-rules-box { margin-bottom: 30px; }
.wn-rules-title { border-bottom: 2px solid #ddd; padding-bottom: 8px; color: #000; font-size: 28px; margin-top: 0; font-weight: bold; } /* ‡ß®‡ß™ ‡¶•‡ßá‡¶ï‡ßá ‡ß®‡ßÆ */
.wn-rules-list { list-style: none; padding: 0; margin: 0; }
.wn-rules-list li { margin-bottom: 15px; padding-left: 40px; position: relative; line-height: 1.5; font-size: 30px; color: #222; } /* ‡ß®‡ß¶ ‡¶•‡ßá‡¶ï‡ßá ‡ß®‡ß™ */
.wn-rules-list li::before { content: 'üéµ'; position: absolute; left: 0; font-size: 24px; }

/* Footer */
.wn-footer { margin-top: 50px; display: flex; justify-content: space-between; align-items: flex-end; }
.wn-sig-box { text-align: center; width: 280px; }
.wn-sig-img { height: 70px; display: block; margin: 0 auto; }
.wn-owner { font-weight: bold; border-top: 2px solid #333; padding-top: 5px; display: block; margin-top: 5px; font-size: 22px; }

/* Digital Signature Size Increase */
#wnStudentSig {
    max-height: 140px !important; /* ‡¶∏‡¶ø‡¶ó‡¶®‡ßá‡¶ö‡¶æ‡¶∞ ‡¶∏‡¶æ‡¶á‡¶ú ‡ßÆ‡ß¶ ‡¶•‡ßá‡¶ï‡ßá ‡ßß‡ß®‡ß¶ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶≤‡ßã */
    width: auto;
    display: block;
}
        /* BLACK BORDER FOR PHOTO IN PDF */
        #wnStudentPhoto { width: 90px; height: 110px; border: 2px solid #000 !important; object-fit: cover; display: none; background: #eee; }

        /* SWEETALERT2 OVERRIDES */
        div:where(.swal2-container) .swal2-popup { background-color: var(--bg-card) !important; color: var(--text-main) !important; border: 1px solid var(--border-color); }
        div:where(.swal2-container) .swal2-title, div:where(.swal2-container) .swal2-html-container, div:where(.swal2-container) .swal2-content { color: var(--text-main) !important; }
        div:where(.swal2-container) .swal2-close { color: var(--text-muted) !important; }
        div:where(.swal2-container) .swal2-close:hover { color: var(--primary) !important; }
        div:where(.swal2-container) .swal2-input, div:where(.swal2-container) .swal2-textarea, div:where(.swal2-container) .swal2-select { background: var(--bg-input) !important; color: var(--text-main) !important; border: 1px solid var(--border-color) !important; }
        div:where(.swal2-container) .swal2-input:focus { border-color: var(--primary) !important; box-shadow: 0 0 0 1px var(--primary) inset !important; }
        div:where(.swal2-container) .swal2-timer-progress-bar { background: var(--primary) !important; }
        /* SWEETALERT POPUP FIX */
        div:where(.swal2-container) {
            z-index: 20000 !important; 
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
        }
        div:where(.swal2-popup) {
            margin: auto !important; 
        }
    </style>
</head>
<body>
<div id="loginOverlay" style="display: flex; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-body); z-index: 10000; flex-direction: column; align-items: center; justify-content: center; color: var(--text-main);">
    <div style="background: var(--bg-card); padding: 30px; border-radius: 16px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); width: 85%; max-width: 350px; text-align: center; border: 1px solid var(--border-color);">
        <h2 style="color: var(--primary); margin-bottom: 20px;">Manager Login</h2>
        <input type="email" id="loginEmail" placeholder="Email Address" style="width: 100%; padding: 12px; margin-bottom: 15px; border-radius: 8px; border: 1px solid var(--border-color); background: var(--bg-input); color: var(--text-main); box-sizing: border-box;">
        <input type="password" id="loginPassword" placeholder="Password" style="width: 100%; padding: 12px; margin-bottom: 20px; border-radius: 8px; border: 1px solid var(--border-color); background: var(--bg-input); color: var(--text-main); box-sizing: border-box;">
        
        <button onclick="handleLogin()" style="width: 100%; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 16px;">
            <i class="fas fa-sign-in-alt"></i> Login
        </button>
        <button onclick="handleSignUp()" style="width: 100%; padding: 12px; background: var(--secondary); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 16px; margin-top: 10px;">
    <i class="fas fa-user-plus"></i> Create Account
</button>
        <p id="loginError" style="color: var(--danger); font-size: 12px; margin-top: 15px; display: none;"></p>
    </div>
</div>

<div id="welcomeNoteTemplate">
    <div class="wn-watermark"><img id="wnWatermarkImg" src="" style="width:100%;"></div>
    
    <div class="wn-header">
        <img id="wnHeaderLogo" class="wn-logo" src="">
        <h1 class="wn-title">GUITAR, BASS GUITAR, PIANO, KEYBOARD, MANDOLIN CLASSES</h1>
        <p class="wn-phone">Ph- 7001471235</p>
    </div>
    
    <div class="wn-details-box">
        <div class="wn-info-col">
            <div class="wn-row"><span class="wn-label">Student Name:</span><span id="wnStudentName" class="wn-val"></span></div>
            <div class="wn-row"><span class="wn-label">Class:</span><span id="wnClass" class="wn-val"></span></div>
            <div class="wn-row"><span class="wn-label">Class Time:</span><span id="wnTime" class="wn-val"></span></div>
            <div class="wn-row"><span class="wn-label">Monthly Fees:</span><span id="wnFee" class="wn-val"></span></div>
            <div class="wn-row"><span class="wn-label">Address:</span><span id="wnAddress" class="wn-val"></span></div>
            <div class="wn-row"><span class="wn-label">Phone:</span><span id="wnPhone" class="wn-val"></span></div>
        </div>

        <div class="wn-photo-col">
            <img id="wnStudentPhoto" src="">
        </div>
    </div>

    <div class="wn-welcome-box">
        <h2 class="wn-welcome-title">‡¶™‡ßç‡¶∞‡¶ø‡¶Ø‡¶º ‡¶∂‡¶ø‡¶ï‡ßç‡¶∑‡¶æ‡¶∞‡ßç‡¶•‡ßÄ,</h2>
        <p>‡¶Ü‡¶™‡¶®‡¶æ‡¶ï‡ßá <strong>‡¶Ü‡¶Æ‡¶æ‡¶∞ ‡¶Æ‡¶ø‡¶â‡¶ú‡¶ø‡¶ï ‡¶ï‡ßç‡¶≤‡¶æ‡¶∏‡ßá</strong> ‡¶∏‡ßç‡¶¨‡¶æ‡¶ó‡¶§ ‡¶ú‡¶æ‡¶®‡¶æ‡¶á‡•§ ‡¶∏‡ßÅ‡¶∞‡ßá‡¶∞ ‡¶è‡¶á ‡¶ú‡¶æ‡¶¶‡ßÅ‡¶ï‡¶∞‡ßÄ ‡¶≠‡ßÅ‡¶¨‡¶®‡ßá ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶Ø‡¶æ‡¶§‡ßç‡¶∞‡¶æ ‡¶Ü‡¶®‡¶®‡ßç‡¶¶‡¶¶‡¶æ‡¶Ø‡¶º‡¶ï ‡¶π‡ßã‡¶ï‡•§ ‡¶Ü‡¶Æ‡¶ø ‡¶Ü‡¶∂‡¶æ ‡¶ï‡¶∞‡¶ø ‡¶Ü‡¶™‡¶®‡¶ø ‡¶Æ‡¶®‡ßã‡¶Ø‡ßã‡¶ó ‡¶¶‡¶ø‡¶Ø‡¶º‡ßá ‡¶∂‡¶ø‡¶ñ‡¶¨‡ßá‡¶® ‡¶è‡¶¨‡¶Ç ‡¶≠‡¶¨‡¶ø‡¶∑‡ßç‡¶Ø‡¶§‡ßá ‡¶è‡¶ï‡¶ú‡¶® ‡¶≠‡¶æ‡¶≤‡ßã ‡¶∂‡¶ø‡¶≤‡ßç‡¶™‡ßÄ ‡¶π‡¶ø‡¶∏‡ßá‡¶¨‡ßá ‡¶®‡¶ø‡¶ú‡ßá‡¶ï‡ßá ‡¶ó‡¶°‡¶º‡ßá ‡¶§‡ßÅ‡¶≤‡¶¨‡ßá‡¶®‡•§</p>
    </div>

    <div class="wn-rules-box">
        <h3 class="wn-rules-title">üìå ‡¶®‡¶ø‡¶Ø‡¶º‡¶Æ‡¶æ‡¶¨‡¶≤‡ßÄ (Rules for Student):</h3>
        <ul class="wn-rules-list">
            <li>‡¶Ü‡¶™‡¶®‡¶æ‡¶ï‡ßá ‡¶Æ‡¶æ‡¶∏‡¶ø‡¶ï ‡¶¨‡ßá‡¶§‡¶® (Monthly Fees) ‡¶Ö‡¶¨‡¶∂‡ßç‡¶Ø‡¶á <strong>‡¶Ö‡¶ó‡ßç‡¶∞‡¶ø‡¶Æ (Advance)</strong> ‡¶™‡¶∞‡¶ø‡¶∂‡ßã‡¶ß ‡¶ï‡¶∞‡¶§‡ßá ‡¶π‡¶¨‡ßá‡•§</li>
            <li>‡¶™‡ßç‡¶∞‡¶§‡¶ø ‡¶Æ‡¶æ‡¶∏‡ßá‡¶∞ <strong style="color:#d32f2f;">10 ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ‡ßá‡¶∞</strong> ‡¶Æ‡¶ß‡ßç‡¶Ø‡ßá ‡¶´‡¶ø‡¶∏ ‡¶ú‡¶Æ‡¶æ ‡¶¶‡ßá‡¶ì‡¶Ø‡¶º‡¶æ ‡¶¨‡¶æ‡¶ß‡ßç‡¶Ø‡¶§‡¶æ‡¶Æ‡ßÇ‡¶≤‡¶ï‡•§</li>
            <li>‡¶Ü‡¶™‡¶®‡¶ø ‡¶Ø‡¶¶‡¶ø ‡¶ï‡ßã‡¶®‡ßã ‡¶Æ‡¶æ‡¶∏‡ßá ‡¶ï‡ßç‡¶≤‡¶æ‡¶∏ ‡¶Æ‡¶ø‡¶∏ ‡¶ï‡¶∞‡ßá‡¶® ‡¶¨‡¶æ ‡¶Ö‡¶®‡ßÅ‡¶™‡¶∏‡ßç‡¶•‡¶ø‡¶§ ‡¶•‡¶æ‡¶ï‡ßá‡¶®, ‡¶§‡¶¨‡ßÅ‡¶ì ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶∏‡¶ø‡¶ü ‡¶¨‡¶ú‡¶æ‡¶Ø‡¶º ‡¶∞‡¶æ‡¶ñ‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶∏‡ßá‡¶á ‡¶Æ‡¶æ‡¶∏‡ßá‡¶∞ <strong>‡¶™‡ßÅ‡¶∞‡ßã ‡¶¨‡ßá‡¶§‡¶®</strong> ‡¶™‡¶∞‡¶ø‡¶∂‡ßã‡¶ß ‡¶ï‡¶∞‡¶§‡ßá ‡¶π‡¶¨‡ßá‡•§ <span style="color:#d32f2f;">*</span></li>
            <li>‡¶ï‡ßç‡¶≤‡¶æ‡¶∏‡ßá‡¶∞ ‡¶¶‡¶ø‡¶® ‡¶¨‡¶æ ‡¶∏‡¶Æ‡¶Ø‡¶º (Day & Time) ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶® ‡¶π‡¶≤‡ßá ‡¶ï‡¶∞‡ßç‡¶§‡ßÉ‡¶™‡¶ï‡ßç‡¶∑ ‡¶¶‡¶æ‡¶Ø‡¶º‡ßÄ ‡¶•‡¶æ‡¶ï‡¶¨‡ßá ‡¶®‡¶æ‡•§ <span style="color:#d32f2f;">*</span></li>
        </ul>
    </div>

    <div style="font-size: 18px; color: #444; margin-top: 30px; font-style: italic;">
        <p><span style="color:#d32f2f;">*</span> Conditions Apply.</p>
        <p>‡¶Ü‡¶Æ‡¶ø ‡¶â‡¶™‡¶∞‡ßá‡¶∞ ‡¶®‡¶ø‡¶Ø‡¶º‡¶Æ‡¶ó‡ßÅ‡¶≤‡ßã ‡¶™‡¶°‡¶º‡¶≤‡¶æ‡¶Æ ‡¶è‡¶¨‡¶Ç ‡¶Æ‡ßá‡¶®‡ßá ‡¶ö‡¶≤‡¶§‡ßá ‡¶∏‡¶Æ‡ßç‡¶Æ‡¶§ ‡¶π‡¶≤‡¶æ‡¶Æ‡•§</p>
    </div>

    <div class="wn-footer">
        <div class="wn-sig-box" style="text-align: left;">
            <div style="height: 130px; display: flex; align-items: flex-end; justify-content: flex-start;">
                <img id="wnStudentSig" src="" style="display:none;">
            </div>
            <span id="wnStudentNameSig" style="font-weight: bold; border-top: 2px solid #333; padding-top: 5px; display: block; margin-top: 5px; font-size: 22px;">
            </span>
            <div style="font-size: 22px; font-weight: bold; color: #333; margin-top: 5px;">
                Date: <span id="wnFooterDate"></span>
            </div>
        </div>

        <div class="wn-sig-box">
            <img id="wnSigImg" class="wn-sig-img" src="">
            <span class="wn-owner">Srikanta Banerjee</span>
            <span style="font-size: 18px;">(Owner & Instructor)</span>
        </div>
    </div>
</div>
    <div id="securityOverlay">
        <span class="close-pin" onclick="closePinScreen()" style="position: absolute; top: 30px; right: 20px; font-size: 30px; opacity: 0.7;">&times;</span>
        <div style="font-size: 20px; letter-spacing: 2px; margin-bottom: 20px; opacity: 0.9;">ENTER PIN</div>
        <div class="pin-dots" id="pinDots"><div class="pin-dot"></div><div class="pin-dot"></div><div class="pin-dot"></div><div class="pin-dot"></div></div>
        <div class="pin-pad">
            <div class="pin-btn" onclick="pressPin('1')">1</div><div class="pin-btn" onclick="pressPin('2')">2</div><div class="pin-btn" onclick="pressPin('3')">3</div>
            <div class="pin-btn" onclick="pressPin('4')">4</div><div class="pin-btn" onclick="pressPin('5')">5</div><div class="pin-btn" onclick="pressPin('6')">6</div>
            <div class="pin-btn" onclick="pressPin('7')">7</div><div class="pin-btn" onclick="pressPin('8')">8</div><div class="pin-btn" onclick="pressPin('9')">9</div>
            <div class="pin-btn" onclick="pressPin('C')" style="color: #ef4444;"><i class="fas fa-times"></i></div>
            <div class="pin-btn" onclick="pressPin('0')">0</div>
            <div class="pin-btn" onclick="submitPin()" style="color: #10b981;"><i class="fas fa-check"></i></div>
        </div>
    </div>

    <div id="signatureModal" class="modal">
        <div class="sig-container-wrapper" id="sigWrapper">
            <div class="sig-canvas-box">
                <canvas id="sigCanvas"></canvas>
            </div>
        </div>
 <div class="sig-toolbar">
    <button class="btn-danger" onclick="clearSignature()"><i class="fas fa-eraser"></i> Clear</button>
    <button class="btn-success" onclick="saveSignature()"><i class="fas fa-save"></i> Save Signature</button>
    <button class="btn-warning" onclick="closeSignatureModal()">Close</button>
</div>
    </div>

    <header>
        <div class="header-content">
            <img id="headerLogo" src="" alt="Logo">
            <div>
                <h1>Music Classes Manager</h1>
                <div id="liveClock">Loading time...</div>
            </div>
        </div>
        <div onclick="openTab('settings')" style="padding: 5px;"><i class="fas fa-cog" style="color: var(--text-muted); font-size: 18px;"></i></div>
    </header>

    <div class="container">
        <div class="bottom-nav">
            <button class="nav-item active" onclick="openTab('attendance')"><i class="fas fa-calendar-check"></i><span>Attend</span></button>
            <button class="nav-item" onclick="openTab('fees')"><i class="fas fa-rupee-sign"></i><span>Fees</span></button>
            <button class="nav-item" onclick="openTab('dashboard')"><i class="fas fa-chart-pie"></i><span>Dash</span></button>
            <button class="nav-item" onclick="openTab('reminders')"><i class="fas fa-bell"></i><span>Remind</span></button>
            <button class="nav-item" onclick="openTab('studentMgmt')"><i class="fas fa-users"></i><span>Students</span></button>
            <button class="nav-item" onclick="openTab('reports')"><i class="fas fa-file-invoice"></i><span>Report</span></button>
            <button class="nav-item" onclick="openTab('analytics')"><i class="fas fa-chart-line"></i><span>Analytic</span></button>
        </div>

        <div class="tab-buttons">
            <button class="tab-button" onclick="openTab('attendance')"></button>
            <button class="tab-button" onclick="openTab('fees')"></button>
            <button class="tab-button" onclick="openTab('studentMgmt')"></button>
            <button class="tab-button" onclick="openTab('dashboard')"></button>
            <button class="tab-button" onclick="openTab('reminders')"></button>
            <button class="tab-button" onclick="openTab('reports')"></button>
            <button class="tab-button" onclick="openTab('analytics')"></button>
            <button class="tab-button" onclick="openTab('settings')"></button>
        </div>

        <div id="attendance" class="tab-content active">
            <h3 style="border-left: 4px solid var(--primary); padding-left:10px;">Mark Attendance</h3>
            <div class="form-group" style="display: flex; gap: 10px;">
                <div style="flex: 1;">
                    <label>Date</label>
                    <input type="date" id="attendanceDate" onchange="renderAttendance()">
                </div>
                <div style="flex: 1;">
                    <label>Time</label>
                    <input type="time" id="attendanceTime" placeholder="Default: Current">
                </div>
            </div>
            <div class="search-bar"><input type="search" id="searchAttendance" onkeyup="searchTable('searchAttendance', 'attendanceTable')" placeholder="Search Name, Address..."></div>
            <table id="attendanceTable"><thead><tr><th>Student</th><th>Status</th><th>Action</th></tr></thead><tbody></tbody></table>
        </div>

        <div id="fees" class="tab-content">
            <h3 style="border-left: 4px solid var(--success); padding-left:10px;">Monthly Fees</h3>
            <div class="form-group"><input type="month" id="feeMonth" onchange="renderFees()"></div>
            <div class="search-bar"><input type="search" id="searchFees" onkeyup="searchTable('searchFees', 'feeTable')" placeholder="Search Name, Address..."></div>
            <div id="feeSummary" class="summary-box"></div>
            <table id="feeTable"><thead><tr><th>Student</th><th>Status</th><th>Actions</th></tr></thead><tbody></tbody></table>
        </div>

        <div id="reminders" class="tab-content">
            <h3 style="border-left: 4px solid var(--warning); padding-left:10px;">Weekly Reminders</h3>
            <div class="dashboard-card">
                <div class="form-group">
                    <label>Add New Reminder</label>
                    <input type="text" id="reminderText" placeholder="e.g. Check Guitars, Call Piano Batch..." style="margin-bottom:10px;">
                    <div style="display: flex; gap: 10px;">
                        <input type="date" id="reminderDate" style="flex:1;" onchange="updateReminderDay()">
                        <select id="reminderDay" style="flex:1;">
                            <option value="Monday">Monday</option>
                            <option value="Tuesday">Tuesday</option>
                            <option value="Wednesday">Wednesday</option>
                            <option value="Thursday">Thursday</option>
                            <option value="Friday">Friday</option>
                            <option value="Saturday">Saturday</option>
                            <option value="Sunday">Sunday</option>
                        </select>
                    </div>
                    <button class="btn-primary" onclick="addReminder()" style="width:100%; margin-top: 10px;">Add Reminder</button>
                </div>
            </div>
            <div id="reminderListContainer"></div>
        </div>

        <div id="studentMgmt" class="tab-content">
            <div class="dashboard-card" style="border-color: var(--info);">
                <h3><i class="fas fa-user-plus"></i> Add Student</h3>
                <div style="text-align: center;">
                    <input type="file" id="addStudentCamera" accept="image/*" capture="environment" onchange="handlePhotoSelection(this, 'add')" style="display:none;">
                    <input type="file" id="addStudentGallery" accept="image/*" onchange="handlePhotoSelection(this, 'add')" style="display:none;">
                    <div id="photoPreviewBox" onclick="openPhotoSourceModal('add')">
                        <span id="photoPlaceholder" style="font-size: 11px; color: var(--text-muted); text-align: center;"><i class="fas fa-camera fa-2x"></i><br>Add Photo</span>
                        <img id="photoPreview" src="" style="width: 100%; height: 100%; object-fit: cover; display: none;">
                    </div>
                </div>
                <div class="form-grid">
                    <div class="form-group"><input type="text" id="studentName" placeholder="Full Name"></div>
                    <div class="form-group"><input type="text" id="studentClass" placeholder="Class/Instrument"></div>
                    <div class="form-group"><select id="studentDay"><option value="">Select Day</option><option value="Sunday">Sunday</option><option value="Monday">Monday</option><option value="Tuesday">Tuesday</option><option value="Wednesday">Wednesday</option><option value="Thursday">Thursday</option><option value="Friday">Friday</option><option value="Saturday">Saturday</option></select></div>
                    <div class="form-group"><input type="time" id="studentTime"></div>
                    <div class="form-group"><input type="number" id="studentFee" placeholder="Monthly Fee (‚Çπ)"></div>
                    <div class="form-group"><input type="tel" id="phone" placeholder="Phone Number"></div>
                    <div class="form-group"><input type="email" id="studentEmail" placeholder="Email"></div>
                    <div class="form-group"><input type="text" id="guardianName" placeholder="Guardian Name"></div>
                    <div class="form-group"><input type="text" id="address" placeholder="Address"></div>
                    <div class="form-group"><label>Date of Birth</label><input type="date" id="studentDOB"></div>
                </div>
                
                <button class="btn-info" onclick="openSignatureModal()" style="width: 100%; margin-top: 10px; background: #6366f1;">
                    <i class="fas fa-pen-nib"></i> Take Digital Signature
                </button>
                <div id="signatureStatus" style="text-align:center; font-size:12px; color:green; display:none; margin-top:5px;">Signature Captured <i class="fas fa-check-circle"></i></div>

                <button class="btn-success" onclick="addStudent()" style="width: 100%; margin-top: 10px;">Save Student</button>
            </div>
            
            <div class="search-bar">
                <input type="search" id="searchStudents" onkeyup="filterStudentLists()" placeholder="Search student by Name, Address...">
            </div>

            <div style="display: flex; margin-bottom: 15px; background: var(--bg-input); border-radius: 8px; padding: 5px; border: 1px solid var(--border-color);">
                <button id="btnShowActive" onclick="switchStudentView('active')" style="flex: 1; border: none; background: var(--primary); color: white; padding: 10px; border-radius: 6px; font-size: 13px; margin-right: 5px;">Active Students</button>
                <button id="btnShowInactive" onclick="switchStudentView('inactive')" style="flex: 1; border: none; background: transparent; color: var(--text-muted); padding: 10px; border-radius: 6px; font-size: 13px;">Inactive Students</button>
            </div>

            <div id="activeStudentsContainer">
                <table id="activeStudentsTable">
                    <thead><tr><th>ID</th><th>Details</th><th>Class</th><th>Fee</th><th>Contact</th><th>Status</th><th>Actions</th></tr></thead>
                    <tbody id="activeStudentsList"></tbody>
                </table>
            </div>

            <div id="inactiveStudentsContainer" style="display: none;">
                <table id="inactiveStudentsTable" style="opacity: 0.9;">
                    <thead><tr><th>ID</th><th>Details</th><th>Class</th><th>Fee</th><th>Contact</th><th>Status</th><th>Actions</th></tr></thead>
                    <tbody id="inactiveStudentsList"></tbody>
                </table>
            </div>
        </div>

        <div id="dashboard" class="tab-content">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h3>Dashboard</h3>
                <button class="btn-primary" onclick="exportDashboardPDF()" style="font-size: 11px;"><i class="fas fa-download"></i> PDF</button>
            </div>
            
            <div id="dashboardRemindersBox" class="dashboard-card" style="display: none; border-top-color: var(--warning); background-color: rgba(253, 230, 138, 0.2);">
                <h3 style="color: var(--warning); border:none; margin-bottom:5px;"><i class="fas fa-bell"></i> Reminders for Today</h3>
                <div id="dashboardReminderList" style="padding-top:5px;"></div>
            </div>

            <div id="birthdayAlertBox" class="dashboard-card birthday-card" style="display: none;">
                <h3 style="color: var(--pink); border:none;"><i class="fas fa-birthday-cake"></i> Birthdays Today!</h3>
                <div id="birthdayList"></div>
            </div>

            <div class="dashboard-grid">
                <div class="dashboard-card">
                    <h3>Financials</h3>
                    <div class="chart-container" style="height: 200px;"><canvas id="financeChart"></canvas></div>
                    <div id="financeOverviewNumbers" class="summary-box" style="margin-top: 10px;"></div>
                </div>
                <div class="dashboard-card">
                    <h3>Stats</h3>
                    <div id="studentStatsSummary" class="summary-box" style="margin-top:0;"></div>
                    <div id="dashboardYearlySummary" class="summary-box"></div>
                </div>
                <div class="dashboard-card">
                    <h3>Class Strength</h3>
                    <ul id="classStrengthList" class="class-strength-list" style="padding-left: 20px;"></ul>
                </div>
                <div class="dashboard-card" style="border-top-color: var(--danger);">
                    <h3 style="color: var(--danger);">Pending Dues (Active Only)</h3>
                    <p id="dueFeeMessage" style="font-size: 12px; color: var(--text-muted);"></p>
                    <table id="dueFeeTable"><thead><tr><th>Student</th><th>Action</th></tr></thead><tbody></tbody></table>
                </div>
            </div>
        </div>
        
        <div id="reports" class="tab-content">
             <div class="dashboard-card">
                <h3>Generate Reports</h3>
                <div class="form-group">
                    <select id="reportType" onchange="toggleReportInputs(); generateReport()">
                        <option value="monthly">Monthly Report</option>
                        <option value="yearly">Yearly Report</option>
                    </select>
                </div>
                <div class="form-group" id="reportMonth-group">
                    <input type="month" id="reportMonth" onchange="generateReport()">
                </div>
                <div class="form-group" id="reportYear-group" style="display: none;">
                    <input type="number" id="reportYear" placeholder="Year" oninput="generateReport()">
                </div>
                <button class="btn-primary" onclick="generateReport()" style="width: 100%;">Generate View</button>
                <button id="exportReportBtn" class="btn-secondary" style="display:none; width: 100%; margin-top:10px;" onclick="exportReportPDF()">Download PDF</button>
            </div>
            <div id="reportSummary" class="summary-box" style="display: none;"></div>
            <table id="reportTable" style="display: none; margin-top: 20px;"><thead></thead><tbody></tbody></table>
        </div>

        <div id="analytics" class="tab-content">
             <div class="dashboard-card">
                <h3>Yearly Analysis & Comparison</h3>
                <div style="display:flex; gap:10px; align-items:center; margin-bottom:10px;">
                    <div class="form-group" style="margin-bottom:0; flex:1;">
                        <label>Select Year</label>
                        <input type="number" id="analyticsYear" placeholder="YYYY" oninput="updateYearlyChart()" onchange="updateYearlyChart()">
                    </div>
                    <div class="form-group" style="margin-bottom:0; flex:1;">
                        <label>Compare Year</label>
                        <input type="number" id="compareYear" placeholder="YYYY" oninput="updateYearlyChart()" onchange="updateYearlyChart()">
                    </div>
                </div>
                <div class="chart-container" style="height: 280px; position: relative;">
                    <canvas id="yearlyChart"></canvas>
                </div>
                <div id="yearlyAverages" class="summary-box" style="margin-top: 15px; display:none;"></div>
            </div>
            
            <div class="dashboard-card" style="border-top-color: var(--info);">
                <h3>Compare Specific Months</h3>
                <div class="form-group">
                    <label>Period A (Base)</label>
                    <input type="month" id="compMonth1" onchange="comparePeriods()">
                </div>
                <div class="form-group">
                    <label>Period B (Target)</label>
                    <input type="month" id="compMonth2" onchange="comparePeriods()">
                </div>
                <button class="btn-info" onclick="comparePeriods()" style="width:100%;">Compare Data</button>
                
                <div id="comparisonResults" style="display:none; margin-top:20px;">
                    <h4 style="text-align:center; margin-bottom:10px;">Comparison Result</h4>
                    <div class="comparison-grid">
                        <div class="comp-card">
                            <span style="font-size:10px; color:var(--text-muted);">Income A</span><br>
                            <strong id="compIncome1"></strong>
                        </div>
                        <div class="comp-card">
                            <span style="font-size:10px; color:var(--text-muted);">Income B</span><br>
                            <strong id="compIncome2"></strong>
                            <div id="compIncomeDiff" class="comp-diff"></div>
                        </div>
                        <div class="comp-card">
                            <span style="font-size:10px; color:var(--text-muted);">Students A</span><br>
                            <strong id="compStudent1"></strong>
                        </div>
                        <div class="comp-card">
                            <span style="font-size:10px; color:var(--text-muted);">Students B</span><br>
                            <strong id="compStudent2"></strong>
                            <div id="compStudentDiff" class="comp-diff"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="settings" class="tab-content">
             <h3>App Settings</h3>
            <div class="dashboard-grid">
                <div class="dashboard-card">
                    <label>App Theme</label>
                    <button class="btn-secondary" onclick="toggleTheme()" id="themeToggleBtn" style="width:100%;">
                        <i class="fas fa-moon"></i> Switch to Dark Mode
                    </button>
                </div>
                
                <div class="dashboard-card">
                    <label>Institute Logo</label>
                    <input type="file" id="instituteLogoInput" accept="image/*" onchange="saveInstituteLogo(this)">
                    <img id="logoPreview" src="" style="max-height: 60px; margin-top:10px; display: none;">
                    <button class="btn-danger" onclick="removeLogo()" id="removeLogoBtn" style="display:none; margin-top:5px; font-size:11px;">Remove</button>
                </div>
                <div class="dashboard-card">
                    <label>Auth Signature</label>
                    <input type="file" id="authSigInput" accept="image/*" onchange="saveAuthSignature(this)">
                    <img id="authSigPreview" src="" style="max-height: 60px; margin-top:10px; display: none;">
                    <button class="btn-danger" onclick="removeAuthSignature()" id="removeAuthSigBtn" style="display:none; margin-top:5px; font-size:11px;">Remove</button>
                </div>
                <div class="dashboard-card">
                    <label>Update PIN</label>
                    <div style="display:flex; gap:10px;">
                        <input type="password" id="newAppPin" placeholder="New PIN" maxlength="4">
                        <button class="btn-info" onclick="changeAppPin()">Save</button>
                    </div>
                </div>
                <div class="dashboard-card" style="border-top-color: var(--danger);">
    <label>Account Status</label>
    <div style="margin-top: 5px; font-size: 12px; color: var(--text-muted); margin-bottom: 10px;" id="currentUserDisplay">Checking status...</div>
    <button class="btn-danger" onclick="handleLogout()" style="width:100%;">
        <i class="fas fa-sign-out-alt"></i> Logout
    </button>
</div>
                <div class="dashboard-card">
                    <label>Backup Data</label>
                    <button class="btn-primary btn-google" onclick="secureAction(exportData)" style="width:100%; margin-top:5px;"><i class="fab fa-google-drive"></i> Backup</button>
                    <button class="btn-success" onclick="secureAction(exportToExcel)" style="width:100%; margin-top:10px; background: #1D6F42;">
    <i class="fas fa-file-excel"></i> Export to Excel (Secure)
</button>
                    <hr style="margin: 15px 0; border-top: 1px solid var(--border-color);">
                    <label>Restore / Reset</label>
                    <button class="btn-warning" onclick="secureAction(() => document.getElementById('importFile').click())" style="width:100%;"><i class="fas fa-file-upload"></i> Restore JSON</button>
                    <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importData(event)">
                    <button class="btn-danger" onclick="secureAction(resetApp)" style="width:100%; margin-top:10px;"><i class="fas fa-trash"></i> Factory Reset</button>
                </div>
            </div>
        </div>
    </div>

    <div id="photoSourceModal" class="modal" style="z-index: 3000;">
        <div class="modal-content" style="max-width: 300px; text-align: center;">
            <span class="close-button" onclick="closeModal('photoSourceModal')">&times;</span>
            <h3>Add Photo</h3>
            <div style="display: flex; flex-direction: column; gap: 15px; margin-top: 20px;">
                <button class="btn-primary" onclick="triggerCamera()"><i class="fas fa-camera"></i> Camera</button>
                <button class="btn-info" onclick="triggerGallery()"><i class="fas fa-images"></i> Gallery</button>
            </div>
        </div>
    </div>

    <div id="classStudentsModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal('classStudentsModal')">&times;</span>
            <h3 id="classStudentsTitle"></h3>
            <div style="max-height: 60vh; overflow-y: auto;">
                <table id="classStudentsTable"><thead><tr><th>ID</th><th>Student</th><th>Contact</th></tr></thead><tbody></tbody></table>
            </div>
        </div>
    </div>

    <div id="studentDetailsModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal('studentDetailsModal')">&times;</span>
            <div style="text-align: center; margin-bottom: 20px;">
                <img id="modalStudentPhoto" src="" style="width:100px; height:100px; border-radius:50%; border:2px solid #000 !important; object-fit:cover;">
                <h2 id="modalStudentName" style="margin:10px 0 5px 0;"></h2>
                <span id="modalClass" style="color:var(--primary); font-weight:600;"></span>
            </div>
            <div style="background: var(--bg-input); padding: 15px; border-radius: 12px; font-size: 14px; margin-bottom: 20px;">
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                    <div><strong>ID:</strong> <span id="modalSerialNo"></span></div>
                    <div><strong>Fee:</strong> <span id="modalFeeAmount"></span></div>
                    <div><strong>Day:</strong> <span id="modalDayTime"></span></div>
                    <div><strong>Join:</strong> <span id="modalJoiningDate"></span></div>
                </div>
                <p><strong>Phone:</strong> <span id="modalPhone"></span></p>
                <p><strong>Email:</strong> <span id="modalEmail"></span></p>
                <p><strong>Guardian:</strong> <span id="modalGuardianName"></span></p>
                <p><strong>Addr:</strong> <span id="modalAddress"></span></p>
                <p><strong>DOB:</strong> <span id="modalDOB"></span></p>
            </div>
            
            <button class="btn-info" id="btnViewSignature" style="width: 100%; margin-top: 10px; margin-bottom: 15px; background-color: #6366f1; border: none; padding: 10px; border-radius: 8px;">
                <i class="fas fa-file-signature"></i> View Digital Signature
            </button>

            <div style="display:flex; gap:10px; margin-bottom:10px; align-items:center; background:var(--bg-input); padding:10px; border-radius:8px;">
                <select id="detailsFilterYear" style="flex:1; font-size:12px; padding:8px;" onchange="renderStudentDetailsHistory()"></select>
                <select id="detailsFilterMonth" style="flex:1; font-size:12px; padding:8px;" onchange="renderStudentDetailsHistory()"></select>
            </div>

            <div style="margin-bottom:20px;">
                <h4 style="margin:0 0 10px 0;">Status History</h4>
                <ul id="modalStatusHistory" class="scrollable-list"></ul>
            </div>
            <div style="margin-bottom:20px; display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                 <div>
                    <h4 style="margin:0 0 5px 0;">Paid</h4>
                    <ul id="modalPaidList" class="scrollable-list"></ul>
                 </div>
                 <div>
                    <h4 style="margin:0 0 5px 0;">Attendance</h4>
                    <div style="font-size:11px;">Present: <ul id="modalPresentList" class="scrollable-list" style="max-height:80px;"></ul></div>
                    <div style="font-size:11px; color:red; margin-top:5px;">Absent: <ul id="modalAbsentList" class="scrollable-list" style="max-height:80px;"></ul></div>
                 </div>
            </div>
            <div style="background: var(--bg-input); padding: 15px; border-radius: 12px; margin-bottom: 20px; border: 1px solid var(--border-color);">
    <h4 style="margin: 0 0 10px 0; border-bottom: 2px solid var(--warning); padding-bottom: 5px;">
        <i class="fas fa-sticky-note" style="color: var(--warning);"></i> Class Notes History
    </h4>
    
    <input type="text" id="noteSearchInput" placeholder="Search by Date or Note content..." 
           onkeyup="filterStudentNotes()" 
           style="padding: 8px; font-size: 12px; margin-bottom: 10px;">

    <div style="max-height: 150px; overflow-y: auto; border: 1px solid var(--border-color); background: var(--bg-card); border-radius: 8px;">
        <ul id="modalNotesList" style="list-style: none; padding: 0; margin: 0;">
            </ul>
    </div>
</div>
            <div style="background: var(--bg-input); padding: 15px; border-radius: 12px;">
                <label>Generate Documents</label>
                <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                    <input type="date" id="idCardIssueDate">
                    <input type="date" id="idCardEndDate">
                </div>
                
                <div style="display: flex; gap: 10px;">
                    <button class="btn-info" onclick="generateIDCard()" style="flex:1;">ID Card</button>
                    <button class="btn-primary" id="exportPdfBtn" style="flex:1;">Profile PDF</button>
                </div>
                <button class="btn-welcome" id="generateWelcomeBtn" onclick="generateWelcomeNote(currentlyViewingStudentId)" style="width:100%; margin-top:10px;">
                    <i class="fas fa-file-pdf"></i> Welcome Note (Bangla)
                </button>
            </div>
        </div>
    </div>

    <div id="statusChangeModal" class="modal">
        <div class="modal-content" style="max-width: 400px;">
            <span class="close-button" onclick="closeModal('statusChangeModal')">&times;</span>
            <h2 id="statusChangeTitle"></h2>
            <input type="hidden" id="statusChangeStudentId"><input type="hidden" id="statusChangeToActive">
            <div class="form-group"><label>Date:</label><input type="date" id="statusDate"></div>
            <div class="form-group"><label>Note:</label><textarea id="statusNote" rows="3"></textarea></div>
            <button class="btn-primary" onclick="saveStatusChange()" style="width:100%;">Confirm</button>
        </div>
    </div>

    <div id="editStudentModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal('editStudentModal')">&times;</span>
            <h2>Edit Student</h2>
            <input type="hidden" id="editStudentId">
            <input type="file" id="editStudentCamera" accept="image/*" capture="environment" onchange="handlePhotoSelection(this, 'edit')" style="display:none;">
            <input type="file" id="editStudentGallery" accept="image/*" onchange="handlePhotoSelection(this, 'edit')" style="display:none;">
            <div style="text-align: center; margin-bottom: 15px;">
    <div onclick="openPhotoSourceModal('edit')" style="width: 80px; height: 80px; border-radius: 50%; overflow: hidden; margin: 0 auto; border: 2px solid #000; position: relative; cursor: pointer;">
        <img id="editPhotoPreview" src="" style="width: 100%; height: 100%; object-fit: cover;">
        <div style="position: absolute; bottom: 0; background: rgba(0,0,0,0.5); width: 100%; color: white; font-size: 10px;">EDIT</div>
    </div>
    
    <button type="button" onclick="removeEditPhoto()" style="margin-top: 5px; background: #ef4444; color: white; border: none; padding: 4px 10px; border-radius: 4px; font-size: 11px; cursor: pointer;">
        <i class="fas fa-trash"></i> Remove Photo
    </button>
</div>
            <div class="form-grid">
                <div class="form-group"><label>Name</label><input type="text" id="editStudentName"></div>
                <div class="form-group"><label>Class</label><input type="text" id="editStudentClass"></div>
                <div class="form-group"><label>Day</label><select id="editStudentDay"><option value="">Select</option><option value="Sunday">Sunday</option><option value="Monday">Monday</option><option value="Tuesday">Tuesday</option><option value="Wednesday">Wednesday</option><option value="Thursday">Thursday</option><option value="Friday">Friday</option><option value="Saturday">Saturday</option></select></div>
                <div class="form-group"><label>Time</label><input type="time" id="editStudentTime"></div>
                <div class="form-group"><label>Fee</label><input type="number" id="editStudentFee"></div>
                <div class="form-group"><label>Phone</label><input type="tel" id="editPhone"></div>
                <div class="form-group"><label>Guardian</label><input type="text" id="editGuardianName"></div>
                <div class="form-group"><label>Email</label><input type="email" id="editStudentEmail"></div>
                <div class="form-group"><label>Addr</label><input type="text" id="editAddress"></div>
                <div class="form-group"><label>DOB</label><input type="date" id="editStudentDOB"></div>
            </div>
            
            <div style="margin-top: 10px; text-align: center;">
                <label style="display:block; margin-bottom:5px;">Signature</label>
                <button class="btn-info" onclick="openSignatureModal()" style="width: 100%; background: #6366f1;">
                    <i class="fas fa-pen-nib"></i> Update Signature
                </button>
            </div>

            <button class="btn-primary" onclick="saveStudentChanges()" style="width:100%; margin-top:15px;">Update</button>
        </div>
    </div>

    <div id="feeModal" class="modal">
        <div class="modal-content" style="max-width: 400px;">
            <span class="close-button" onclick="closeModal('feeModal')">&times;</span>
            <h2 id="feeModalTitle"></h2>
            <input type="hidden" id="feeStudentId"><input type="hidden" id="feeRecordMonth">
            <div class="form-group"><label>Amount</label><input type="number" id="feeAmount" style="font-size: 20px; font-weight: bold; color: var(--success);"></div>
            <div class="form-group"><label>Mode</label><select id="paymentMode"><option value="Cash">Cash</option><option value="Online">Online/UPI</option></select></div>
            <div class="form-group"><label>Txn ID</label><input type="text" id="transactionId"></div>
            <div class="form-group"><label>Date</label><input type="date" id="feeDate"></div>
            <button class="btn-success" onclick="saveFee()" style="width:100%;">Save Payment</button>
        </div>
    </div>

    <script>
        // --- 2. Firebase Config ---
        const firebaseConfig = {
            apiKey: "AIzaSyBDr_ANRX57trE7_1pkH2BaOeQsG0B-3LI",
            authDomain: "student-management-syste-6a036.firebaseapp.com",
            projectId: "student-management-syste-6a036",
            storageBucket: "student-management-syste-6a036.firebasestorage.app",
            messagingSenderId: "198959369817",
            appId: "1:198959369817:web:f24dfd15b9d3d897d9eb48"
        };

        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // --- 3. ENABLE OFFLINE PERSISTENCE (Fast & Offline) ---
        // ‡¶è‡¶ü‡¶ø ‡¶á‡¶®‡ßç‡¶ü‡¶æ‡¶∞‡¶®‡ßá‡¶ü ‡¶®‡¶æ ‡¶•‡¶æ‡¶ï‡¶≤‡ßá‡¶ì ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡¶ï‡ßá ‡¶∏‡¶ö‡¶≤ ‡¶∞‡¶æ‡¶ñ‡¶¨‡ßá ‡¶è‡¶¨‡¶Ç ‡¶ï‡ßç‡¶Ø‡¶æ‡¶∂ ‡¶•‡ßá‡¶ï‡ßá ‡¶°‡¶æ‡¶ü‡¶æ ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶¨‡ßá
        db.enablePersistence({ synchronizeTabs: true })
            .catch((err) => {
                if (err.code == 'failed-precondition') {
                    console.log('Multiple tabs open');
                } else if (err.code == 'unimplemented') {
                    console.log('Browser not supported');
                }
            });

        const COLLECTION_NAME = 'music_classes';
let DOC_ID = 'main_data'; // ‡¶è‡¶ü‡¶ø const ‡¶•‡ßá‡¶ï‡ßá let ‡¶ï‡¶∞‡¶æ ‡¶π‡¶≤‡ßã

        // --- 4. Optimized Database Functions ---

        async function openDB() { return true; }

        async function dbGet(key) {
            try {
                const docRef = db.collection(COLLECTION_NAME).doc(DOC_ID);
                // ‡¶Ü‡¶Æ‡¶∞‡¶æ ‡¶™‡ßç‡¶∞‡¶•‡¶Æ‡ßá ‡¶ï‡ßç‡¶Ø‡¶æ‡¶∂ ‡¶•‡ßá‡¶ï‡ßá ‡¶°‡¶æ‡¶ü‡¶æ ‡¶ñ‡ßã‡¶Å‡¶ú‡¶æ‡¶∞ ‡¶ö‡ßá‡¶∑‡ßç‡¶ü‡¶æ ‡¶ï‡¶∞‡¶¨ ‡¶®‡¶æ, ‡¶´‡¶æ‡¶Ø‡¶º‡¶æ‡¶∞‡¶¨‡ßá‡¶∏ ‡¶®‡¶ø‡¶ú‡ßá‡¶á ‡¶è‡¶ü‡¶æ ‡¶π‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶°‡ßá‡¶≤ ‡¶ï‡¶∞‡ßá
                const doc = await docRef.get(); 
                if (doc.exists) {
                    const data = doc.data();
                    return data[key] !== undefined ? data[key] : null;
                }
                return null;
            } catch (error) {
                console.log("Offline mode: Reading from cache...");
                return null;
            }
        }

        // Fast Save (Update logic)
        async function dbSet(key, value) {
            try {
                const docRef = db.collection(COLLECTION_NAME).doc(DOC_ID);
                // 'update' ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶õ‡¶ø ‡¶Ø‡¶æ‡¶§‡ßá ‡¶∂‡ßÅ‡¶ß‡ßÅ ‡¶®‡¶ø‡¶∞‡ßç‡¶¶‡¶ø‡¶∑‡ßç‡¶ü ‡¶´‡¶ø‡¶≤‡ßç‡¶° ‡¶ö‡ßá‡¶û‡ßç‡¶ú ‡¶π‡¶Ø‡¶º
                // ‡¶á‡¶®‡ßç‡¶ü‡¶æ‡¶∞‡¶®‡ßá‡¶ü ‡¶®‡¶æ ‡¶•‡¶æ‡¶ï‡¶≤‡ßá ‡¶è‡¶ü‡¶ø ‡¶≤‡ßã‡¶ï‡¶æ‡¶≤ ‡¶Æ‡ßá‡¶Æ‡ßã‡¶∞‡¶ø‡¶§‡ßá ‡¶∏‡ßá‡¶≠ ‡¶π‡¶¨‡ßá ‡¶è‡¶¨‡¶Ç ‡¶™‡¶∞‡ßá ‡¶Ü‡¶™‡¶≤‡ßã‡¶° ‡¶π‡¶¨‡ßá
                docRef.set({ [key]: value }, { merge: true }); 
                console.log("Saved (Background):", key);
            } catch (error) {
                console.error("Save Error:", error);
            }
        }

        async function dbDelete(key) {
            try {
                const docRef = db.collection(COLLECTION_NAME).doc(DOC_ID);
                await docRef.update({ [key]: firebase.firestore.FieldValue.delete() });
            } catch (error) { console.error("Delete Error:", error); }
        }

        async function dbClear() {
            try { await db.collection(COLLECTION_NAME).doc(DOC_ID).delete(); }
            catch (error) { console.error("Clear Error:", error); }
        }

        // --- 5. Data Migration (One time) ---
        async function syncOldDataToFirebase() {
            // ‡¶ö‡ßá‡¶ï ‡¶ï‡¶∞‡¶õ‡¶ø ‡¶Ö‡¶®‡¶≤‡¶æ‡¶á‡¶®‡ßá ‡¶°‡¶æ‡¶ü‡¶æ ‡¶Ü‡¶õ‡ßá ‡¶ï‡¶ø‡¶®‡¶æ
            const docRef = db.collection(COLLECTION_NAME).doc(DOC_ID);
            const doc = await docRef.get();
            
            if (doc.exists) {
                console.log("Online data found. Skip migration.");
                return;
            }

            // ‡¶Ø‡¶¶‡¶ø ‡¶Ö‡¶®‡¶≤‡¶æ‡¶á‡¶®‡ßá ‡¶°‡¶æ‡¶ü‡¶æ ‡¶®‡¶æ ‡¶•‡¶æ‡¶ï‡ßá, ‡¶∂‡ßÅ‡¶ß‡ßÅ ‡¶§‡¶ñ‡¶®‡¶á ‡¶≤‡ßã‡¶ï‡¶æ‡¶≤ ‡¶°‡¶æ‡¶ü‡¶æ ‡¶Ü‡¶™‡¶≤‡ßã‡¶° ‡¶π‡¶¨‡ßá
            const lsPin = localStorage.getItem('app_pin');
            if (lsPin) {
                Swal.fire({ title: 'Syncing...', text: 'Uploading local data...', didOpen: () => Swal.showLoading() });
                
                const dataToUpload = {};
                if(localStorage.getItem('app_pin')) dataToUpload['app_pin'] = localStorage.getItem('app_pin');
                if(localStorage.getItem('students')) dataToUpload['students'] = JSON.parse(localStorage.getItem('students'));
                if(localStorage.getItem('attendance')) dataToUpload['attendance'] = JSON.parse(localStorage.getItem('attendance'));
                if(localStorage.getItem('fees')) dataToUpload['fees'] = JSON.parse(localStorage.getItem('fees'));
                if(localStorage.getItem('studentSerialCounter')) dataToUpload['studentSerialCounter'] = localStorage.getItem('studentSerialCounter');
                if(localStorage.getItem('instituteLogo')) dataToUpload['instituteLogo'] = localStorage.getItem('instituteLogo');
                if(localStorage.getItem('authorizedSignature')) dataToUpload['authorizedSignature'] = localStorage.getItem('authorizedSignature');

                await docRef.set(dataToUpload, { merge: true });
                Swal.fire('Success', 'Data synced!', 'success');
            } else {
                await dbSet('app_pin', '1234');
            }
        }

        // --- 6. App Logic & Initialization ---
        
        if ('serviceWorker' in navigator) { 
            window.addEventListener('load', () => { navigator.serviceWorker.register('./serviceWorker.js').catch(console.error); }); 
        }
        
let lastCheckedDate = new Date().toDateString();

        function startClock() {
            setInterval(() => {
                const now = new Date();
                
                // ‡ßß. ‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ ‡¶è‡¶¨‡¶Ç ‡¶∏‡¶Æ‡ßü ‡¶¶‡ßÅ‡¶ü‡ßã‡¶∞ ‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç ‡¶¶‡ßá‡¶ì‡ßü‡¶æ ‡¶π‡¶≤‡ßã
                const options = { 
                    weekday: 'short', // ‡¶¨‡¶æ‡¶∞ (‡¶Ø‡ßá‡¶Æ‡¶®: Sun, Mon)
                    day: 'numeric',   // ‡¶¶‡¶ø‡¶® (‡¶Ø‡ßá‡¶Æ‡¶®: 20)
                    month: 'short',   // ‡¶Æ‡¶æ‡¶∏ (‡¶Ø‡ßá‡¶Æ‡¶®: Jan)
                    year: 'numeric',  // ‡¶¨‡¶õ‡¶∞ (‡¶Ø‡ßá‡¶Æ‡¶®: 2026)
                    hour: '2-digit', 
                    minute: '2-digit', 
                    second: '2-digit', 
                    hour12: true 
                };

                // ‡ß®. ‡¶∏‡ßç‡¶ï‡ßç‡¶∞‡¶ø‡¶®‡ßá ‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ
                document.getElementById('liveClock').textContent = now.toLocaleString('en-IN', options);

                // ‡ß©. ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ ‡¶™‡¶æ‡¶≤‡ßç‡¶ü‡¶æ‡¶≤‡ßá ‡¶Ö‡¶ü‡ßã‡¶Æ‡ßá‡¶ü‡¶ø‡¶ï ‡¶π‡¶æ‡¶ú‡¶ø‡¶∞‡¶æ ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ ‡¶¨‡¶¶‡¶≤‡¶æ‡¶®‡ßã‡¶∞ ‡¶≤‡¶ú‡¶ø‡¶ï (‡¶Ü‡¶ó‡ßá‡¶∞ ‡¶Æ‡¶§‡ßã‡¶á)
                if (now.toDateString() !== lastCheckedDate) {
                    lastCheckedDate = now.toDateString();
                    document.getElementById('attendanceDate').valueAsDate = now;
                    renderAttendance();
                }
            }, 1000);
        }
// --- NEW AUTH & STARTUP LOGIC ---
const auth = firebase.auth();

document.addEventListener('DOMContentLoaded', async () => {
    loadTheme(); // ‡¶•‡¶ø‡¶Æ ‡¶≤‡ßã‡¶° ‡¶π‡¶¨‡ßá ‡¶∏‡¶¨‡¶æ‡¶∞ ‡¶Ü‡¶ó‡ßá

    // Auth State Check (Online/Offline)
    auth.onAuthStateChanged(async (user) => {
        const loginOverlay = document.getElementById('loginOverlay');
        const userDisplay = document.getElementById('currentUserDisplay');

        if (user) {
            // ‡ßß. ‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶≤‡¶ó‡¶á‡¶® ‡¶Ö‡¶¨‡¶∏‡ßç‡¶•‡¶æ‡ßü ‡¶Ü‡¶õ‡ßá
            console.log("Logged in:", user.email);
            if(userDisplay) userDisplay.textContent = `User: ${user.email}`;
            
            // ‡ß®. ‡¶≤‡¶ó‡¶á‡¶® ‡¶∏‡ßç‡¶ï‡ßç‡¶∞‡¶ø‡¶® ‡¶∏‡¶∞‡¶æ‡¶®
            loginOverlay.style.display = 'none';

            // ‡ß©. ‡¶á‡¶â‡¶ú‡¶æ‡¶∞‡ßá‡¶∞ ‡¶®‡¶ø‡¶ú‡¶∏‡ßç‡¶¨ ‡¶°‡¶æ‡¶ü‡¶æ‡¶¨‡ßá‡¶∏ ‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®
            DOC_ID = user.uid; 

            // ‡ß™. ‡¶°‡¶æ‡¶ü‡¶æ ‡¶∏‡¶ø‡¶ô‡ßç‡¶ï ‡¶ì ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡ßÅ‡¶®
            await syncOldDataToFirebase();
            await loadInstituteLogo();
            await loadAuthSignature();

            // ‡ß´. ‡¶™‡¶ø‡¶® ‡¶∏‡ßç‡¶ï‡ßç‡¶∞‡¶ø‡¶® ‡¶¶‡ßá‡¶ñ‡¶æ‡¶® (‡¶∏‡¶ø‡¶ï‡¶ø‡¶â‡¶∞‡¶ø‡¶ü‡¶ø‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø)
            // ‡¶™‡¶ø‡¶® ‡¶¶‡¶ø‡¶≤‡ßá‡¶á ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™ ‡¶ñ‡ßÅ‡¶≤‡¶¨‡ßá
            secureAction(() => { 
                initApp(); 
                startClock(); 
            }, true); // true ‡¶Æ‡¶æ‡¶®‡ßá ‡¶è‡¶ü‡¶ø ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™ ‡¶∏‡ßç‡¶ü‡¶æ‡¶∞‡ßç‡¶ü‡ßá‡¶∞ ‡¶™‡¶ø‡¶®

        } else {
            // ‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶≤‡¶ó‡¶Ü‡¶â‡¶ü ‡¶Ö‡¶¨‡¶∏‡ßç‡¶•‡¶æ‡ßü ‡¶Ü‡¶õ‡ßá
            console.log("No user.");
            // ‡ßß. ‡¶≤‡¶ó‡¶á‡¶® ‡¶∏‡ßç‡¶ï‡ßç‡¶∞‡¶ø‡¶® ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®
            loginOverlay.style.display = 'flex';
            // ‡ß®. ‡¶™‡¶ø‡¶® ‡¶∏‡ßç‡¶ï‡ßç‡¶∞‡¶ø‡¶® ‡¶•‡¶æ‡¶ï‡¶≤‡ßá ‡¶≤‡ßÅ‡¶ï‡¶æ‡¶®
            document.getElementById('securityOverlay').style.display = 'none';
        }
    });
});

// ‡¶≤‡¶ó‡¶á‡¶® ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®
function handleLogin() {
    const email = document.getElementById('loginEmail').value;
    const password = document.getElementById('loginPassword').value;
    const errorMsg = document.getElementById('loginError');

    if (!email || !password) {
        errorMsg.textContent = "Email and password required!";
        errorMsg.style.display = 'block';
        return;
    }

    // ‡¶≤‡ßã‡¶°‡¶ø‡¶Ç ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®
    const loginBtn = document.querySelector('#loginOverlay button');
    const originalText = loginBtn.innerHTML;
    loginBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Checking...';

    auth.signInWithEmailAndPassword(email, password)
        .then((userCredential) => {
            // ‡¶∏‡¶´‡¶≤ ‡¶π‡¶≤‡ßá onAuthStateChanged ‡¶Ö‡¶ü‡ßã‡¶Æ‡ßá‡¶ü‡¶ø‡¶ï ‡¶ï‡¶æ‡¶ú ‡¶ï‡¶∞‡¶¨‡ßá
        })
        .catch((error) => {
            console.error(error);
            errorMsg.textContent = "Error: " + error.message;
            errorMsg.style.display = 'block';
            loginBtn.innerHTML = originalText;
        });
}

// ‡¶≤‡¶ó‡¶Ü‡¶â‡¶ü ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®
function handleLogout() {
    Swal.fire({
        title: 'Logout?',
        text: "You need internet to login again.",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        confirmButtonText: 'Yes, Logout'
    }).then((result) => {
        if (result.isConfirmed) {
            auth.signOut().then(() => {
                window.location.reload();
            });
        }
    });
}

        // Theme Functions
        function toggleTheme() {
            const body = document.body;
            const newTheme = body.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
            body.setAttribute('data-theme', newTheme);
            localStorage.setItem('app_theme', newTheme);
            updateThemeButton(newTheme);
        }
        function loadTheme() {
            const t = localStorage.getItem('app_theme') || 'light';
            document.body.setAttribute('data-theme', t);
            updateThemeButton(t);
        }
        function updateThemeButton(theme) {
            const btn = document.getElementById('themeToggleBtn');
            if(btn) btn.innerHTML = theme === 'dark' ? '<i class="fas fa-sun"></i> Switch to Light Mode' : '<i class="fas fa-moon"></i> Switch to Dark Mode';
        }

        async function checkBackupStatus() {} // No backup warning needed
// ‡ßß. ‡¶è‡¶á ‡¶≠‡ßá‡¶∞‡¶ø‡ßü‡ßá‡¶¨‡¶≤‡¶ü‡¶ø ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶® (‡¶∏‡ßç‡¶ï‡ßç‡¶∞‡¶ø‡¶™‡ßç‡¶ü‡ßá‡¶∞ ‡¶∂‡ßÅ‡¶∞‡ßÅ‡¶§‡ßá ‡¶Ö‡¶®‡ßç‡¶Ø ‡¶≠‡ßá‡¶∞‡¶ø‡ßü‡ßá‡¶¨‡¶≤‡ßá‡¶∞ ‡¶∏‡¶æ‡¶•‡ßá)
let isPhotoDeletedInEdit = false;

// ‡ß®. ‡¶è‡¶á ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®‡¶ü‡¶ø ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶® (‡¶Ö‡¶®‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶Ø ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®‡ßá‡¶∞ ‡¶∏‡¶æ‡¶•‡ßá)
function removeEditPhoto() {
    // ‡¶™‡ßç‡¶∞‡¶ø‡¶≠‡¶ø‡¶â‡¶§‡ßá ‡¶°‡¶ø‡¶´‡¶≤‡ßç‡¶ü ‡¶õ‡¶¨‡¶ø ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®‡ßã
    document.getElementById('editPhotoPreview').src = 'https://via.placeholder.com/100?text=No+Photo';
    
    // ‡¶è‡¶°‡¶ø‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶õ‡¶¨‡¶ø ‡¶®‡¶æ‡¶≤ (Null) ‡¶ï‡¶∞‡¶æ
    currentEditPhotoBase64 = null; 
    
    // ‡¶´‡ßç‡¶≤‡ßç‡¶Ø‡¶æ‡¶ó ‡¶∏‡¶§‡ßç‡¶Ø ‡¶ï‡¶∞‡¶æ ‡¶Ø‡¶æ‡¶§‡ßá ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶∏‡¶Æ‡ßü ‡¶õ‡¶¨‡¶ø ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶Ø‡¶æ‡ßü
    isPhotoDeletedInEdit = true;
}

// ‡¶®‡¶§‡ßÅ‡¶® ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®: ‡¶õ‡¶æ‡¶§‡ßç‡¶∞‡¶¶‡ßá‡¶∞ ‡¶Ü‡¶≤‡¶æ‡¶¶‡¶æ ‡¶´‡ßã‡¶≤‡ßç‡¶°‡¶æ‡¶∞ ‡¶•‡ßá‡¶ï‡ßá ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶æ
async function loadStudentsFromSubCollection() {
    try {
        const snapshot = await db.collection(COLLECTION_NAME).doc(DOC_ID).collection('students').get();
        if (snapshot.empty) {
            return [];
        }
        return snapshot.docs.map(doc => doc.data());
    } catch (error) {
        console.error("Error loading students:", error);
        return [];
    }
}
// ‡¶®‡¶§‡ßÅ‡¶® ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®: ‡¶õ‡¶æ‡¶§‡ßç‡¶∞‡¶¶‡ßá‡¶∞ ‡¶Ü‡¶≤‡¶æ‡¶¶‡¶æ ‡¶∏‡¶æ‡¶¨-‡¶ï‡¶æ‡¶≤‡ßá‡¶ï‡¶∂‡¶® ‡¶•‡ßá‡¶ï‡ßá ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶æ
async function loadStudentsFromSubCollection() {
    try {
        const snapshot = await db.collection(COLLECTION_NAME).doc(DOC_ID).collection('students').get();
        if (snapshot.empty) return [];
        return snapshot.docs.map(doc => doc.data());
    } catch (error) {
        console.error("Error loading students:", error);
        return [];
    }
}
        // --- SUPER FAST INIT APP (Parallel Loading) ---
        async function initApp() { 
    const now = new Date();
    document.getElementById('attendanceDate').valueAsDate = now;
    document.getElementById('attendanceTime').value = now.toLocaleTimeString('en-GB', {hour: '2-digit', minute:'2-digit'});
    
    const currentMonthStr = `${now.getFullYear()}-${(now.getMonth() + 1).toString().padStart(2, '0')}`; 
    const prevDate = new Date(now);
    prevDate.setMonth(prevDate.getMonth() - 1);
    const prevMonthStr = `${prevDate.getFullYear()}-${(prevDate.getMonth() + 1).toString().padStart(2, '0')}`;

    document.getElementById('feeMonth').value = currentMonthStr; 
    document.getElementById('reportMonth').value = currentMonthStr; 
    document.getElementById('reportYear').value = now.getFullYear(); 
    document.getElementById('idCardIssueDate').valueAsDate = now; 
    document.getElementById('analyticsYear').value = now.getFullYear(); 
    document.getElementById('compMonth1').value = prevMonthStr;
    document.getElementById('compMonth2').value = currentMonthStr;

    toggleReportInputs(); 

    try {
        // ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶®: ‡¶è‡¶ñ‡¶æ‡¶®‡ßá dbGet('students') ‡¶è‡¶∞ ‡¶¨‡¶¶‡¶≤‡ßá ‡¶®‡¶§‡ßÅ‡¶® ‡¶´‡¶æ‡¶Ç‡¶∂‡¶® ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá
        const [sData, aData, fData, rData, scData] = await Promise.all([
            loadStudentsFromSubCollection(), 
            dbGet('attendance'),
            dbGet('fees'),
            dbGet('reminders'),
            dbGet('studentSerialCounter')
        ]);

        students = sData || []; 
        attendance = aData || {}; 
        fees = fData || {}; 
        reminders = rData || []; 
        studentSerialCounter = parseInt(scData) || 1; 
        
        loadAllData(); 
    } catch(e) {
        console.error("Init Error:", e);
        if(!students) students = [];
        if(!attendance) attendance = {};
    }

    document.getElementById('attendanceDate').addEventListener('change', renderAttendance); 
    document.getElementById('feeMonth').addEventListener('change', renderFees); 
    
    comparePeriods(); 
    updateYearlyChart();
}

        const INSTITUTE_NAME = "Guitar, Bass Guitar, Piano, Keyboard, Mandolin Classes"; 
        const MY_NAME = "Srikanta Banerjee"; 
        const DEFAULT_FEE = 500, DUE_DATE = 10; 
        
        let students = [], attendance = {}, fees = {}, reminders = [], studentSerialCounter = 1; 
        let financeChartInstance = null; 
        let instituteLogo = null; 
        let authorizedSignature = null;
        let analyticsChartInstance = null; 
        let currentlyViewingStudentId = null; 
        let currentStudentView = 'active'; 
        
        let dismissedBirthdays = JSON.parse(sessionStorage.getItem('dismissedBirthdays')) || [];

        async function saveInstituteLogo(input) { const file = input.files[0]; if (file) { const reader = new FileReader(); reader.onload = function(e) { const img = new Image(); img.onload = async function() { const canvas = document.createElement('canvas'); const ctx = canvas.getContext('2d'); const maxWidth = 200; const scaleSize = maxWidth / img.width; canvas.width = maxWidth; canvas.height = img.height * scaleSize; ctx.drawImage(img, 0, 0, canvas.width, canvas.height); const logoBase64 = canvas.toDataURL('image/jpeg', 0.8); await dbSet('instituteLogo', logoBase64); await loadInstituteLogo(); Swal.fire('Success', 'Logo saved!', 'success'); }; img.src = e.target.result; }; reader.readAsDataURL(file); } }
        async function loadInstituteLogo() { instituteLogo = await dbGet('instituteLogo'); const img = document.getElementById('logoPreview'); const headerLogo = document.getElementById('headerLogo'); const btn = document.getElementById('removeLogoBtn'); if (instituteLogo) { img.src = instituteLogo; img.style.display = 'block'; btn.style.display = 'inline-block'; headerLogo.src = instituteLogo; headerLogo.style.display = 'block'; } else { img.style.display = 'none'; btn.style.display = 'none'; headerLogo.style.display = 'none'; } }
        async function removeLogo() { await dbDelete('instituteLogo'); instituteLogo = null; await loadInstituteLogo(); }
        async function saveAuthSignature(input) { const file = input.files[0]; if (file) { const reader = new FileReader(); reader.onload = function(e) { const img = new Image(); img.onload = async function() { const canvas = document.createElement('canvas'); const ctx = canvas.getContext('2d'); const maxWidth = 150; const scaleSize = maxWidth / img.width; canvas.width = maxWidth; canvas.height = img.height * scaleSize; ctx.drawImage(img, 0, 0, canvas.width, canvas.height); const sigBase64 = canvas.toDataURL('image/png'); await dbSet('authorizedSignature', sigBase64); await loadAuthSignature(); Swal.fire('Success', 'Signature saved!', 'success'); }; img.src = e.target.result; }; reader.readAsDataURL(file); } }
        async function loadAuthSignature() { authorizedSignature = await dbGet('authorizedSignature'); const img = document.getElementById('authSigPreview'); const btn = document.getElementById('removeAuthSigBtn'); if (authorizedSignature) { img.src = authorizedSignature; img.style.display = 'block'; btn.style.display = 'inline-block'; } else { img.style.display = 'none'; btn.style.display = 'none'; } }
        async function removeAuthSignature() { await dbDelete('authorizedSignature'); authorizedSignature = null; await loadAuthSignature(); }
        
        /* SIGNATURE PAD LOGIC */
        let signaturePad = null;
        let isDrawing = false;
        let currentStudentSignature = null;
        let sigRotation = 0;

        function openSignatureModal() {
            const modal = document.getElementById('signatureModal');
            modal.style.display = 'flex';
            
            const canvas = document.getElementById('sigCanvas');
            const wrapper = document.getElementById('sigWrapper');
            
            // Adjust canvas size to fit wrapper
            canvas.width = wrapper.clientWidth - 40;
            canvas.height = wrapper.clientHeight - 40;
            
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = "#fff";
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.strokeStyle = "#000";
            ctx.lineWidth = 3;
            ctx.lineCap = "round";

            sigRotation = 0;
            document.querySelector('.sig-canvas-box').style.transform = `rotate(0deg)`;

            // Event Listeners
            canvas.addEventListener('mousedown', startDraw);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDraw);
            canvas.addEventListener('touchstart', startDraw, {passive: false});
            canvas.addEventListener('touchmove', draw, {passive: false});
            canvas.addEventListener('touchend', stopDraw);
        }

        function closeSignatureModal() {
            document.getElementById('signatureModal').style.display = 'none';
        }

        function startDraw(e) {
            isDrawing = true;
            draw(e);
            e.preventDefault(); 
        }

        function draw(e) {
            if (!isDrawing) return;
            const canvas = document.getElementById('sigCanvas');
            const ctx = canvas.getContext('2d');
            const rect = canvas.getBoundingClientRect();
            
            let x, y;
            if (e.type.includes('touch')) {
                x = e.touches[0].clientX - rect.left;
                y = e.touches[0].clientY - rect.top;
            } else {
                x = e.clientX - rect.left;
                y = e.clientY - rect.top;
            }

            ctx.lineTo(x, y);
            ctx.stroke();
            ctx.beginPath();
            ctx.moveTo(x, y);
            e.preventDefault();
        }

        function stopDraw() {
            isDrawing = false;
            const canvas = document.getElementById('sigCanvas');
            const ctx = canvas.getContext('2d');
            ctx.beginPath();
        }

        function clearSignature() {
            const canvas = document.getElementById('sigCanvas');
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = "#fff";
            ctx.fillRect(0, 0, canvas.width, canvas.height);
        }

        function rotateSignaturePad() {
            sigRotation = (sigRotation + 90) % 360;
            document.querySelector('.sig-canvas-box').style.transform = `rotate(${sigRotation}deg)`;
        }

        function saveSignature() {
            const canvas = document.getElementById('sigCanvas');
            // We save whatever is on the canvas. If visual rotation was used, 
            // the signature is relative to the canvas. 
            currentStudentSignature = canvas.toDataURL('image/png');
            document.getElementById('signatureStatus').style.display = 'block';
            closeSignatureModal();
            Swal.fire('Saved', 'Signature captured successfully.', 'success');
        }

        function getFeeCalculationStartDate(student) { return new Date(student.joining_date); }
        
        function wasStudentActiveDuringMonth(student, monthStr) {
            const [year, month] = monthStr.split('-').map(Number);
            const monthStart = new Date(year, month - 1, 1);
            const monthEnd = new Date(year, month, 0, 23, 59, 59);
            const joinDate = new Date(student.joining_date);
            if (joinDate > monthEnd) return false;
            
            const history = (student.status.history || []).sort((a, b) => new Date(a.date) - new Date(b.date));
            
            let statusAtStart = 'Active'; 
            for (let i = 0; i < history.length; i++) { 
                if (new Date(history[i].date) < monthStart) { 
                    statusAtStart = history[i].status; 
                } 
            }
            
            let changesInMonth = history.filter(h => { 
                const d = new Date(h.date); 
                return d >= monthStart && d <= monthEnd; 
            });
            
            if (changesInMonth.length === 0) { return statusAtStart === 'Active'; }
            
            const lastChangeInMonth = changesInMonth[changesInMonth.length - 1];
            const changeDate = new Date(lastChangeInMonth.date);
            
            if (lastChangeInMonth.status === 'Inactive') { 
                return changeDate.getDate() > 10; 
            } else { 
                return true; 
            }
        }

        function checkGlobalDues(studentId) { 
            const s = students.find(x => x.id === studentId); 
            if (!s) return false; 
            const now = new Date();
            const currentYear = now.getFullYear();
            const currentMonthIndex = now.getMonth();
            const today = now.getDate();
            let iterDate = new Date(s.joining_date);
            if(isNaN(iterDate.getTime())) return false;
            iterDate.setDate(1);
            while (iterDate <= now) { 
                const y = iterDate.getFullYear(); 
                const m = iterDate.getMonth() + 1; 
                const monthStr = `${y}-${m.toString().padStart(2, '0')}`; 
                if (wasStudentActiveDuringMonth(s, monthStr)) { 
                    if (y < currentYear || (y === currentYear && m - 1 < currentMonthIndex)) { 
                        if (fees[monthStr]?.[studentId]?.status !== 'paid') return true; 
                    } else if (y === currentYear && m - 1 === currentMonthIndex && today > DUE_DATE) { 
                        if (fees[monthStr]?.[studentId]?.status !== 'paid') return true; 
                    } 
                } 
                iterDate.setMonth(iterDate.getMonth() + 1); 
            } 
            return false; 
        }

        function getDueMonthsList(studentId) { 
            const s = students.find(x => x.id === studentId); 
            if (!s) return []; 
            const dueMonths = []; 
            const now = new Date(); 
            let iterDate = new Date(s.joining_date);
            if(isNaN(iterDate.getTime())) return [];
            iterDate.setDate(1);
            while (iterDate <= now) { 
                const y = iterDate.getFullYear(); 
                const m = iterDate.getMonth() + 1; 
                const monthStr = `${y}-${m.toString().padStart(2, '0')}`; 
                if (wasStudentActiveDuringMonth(s, monthStr) && isMonthDue(monthStr) && fees[monthStr]?.[studentId]?.status !== 'paid') { 
                    dueMonths.push(formatMonthYear(monthStr)); 
                } 
                iterDate.setMonth(iterDate.getMonth() + 1); 
            } 
            return dueMonths; 
        }

        function getDueMsg(student, month) { const amount = student.fee_amount || DEFAULT_FEE; const monthName = formatMonthYear(month); const cls = student.class || 'Music'; return `Dear ${student.name}, This is a friendly reminder that your fee of ‚Çπ${amount} for ${monthName} for your ${cls} class is due. Please pay as soon as possible. Thank you. From ${MY_NAME} (${INSTITUTE_NAME}).`; }
        function getPaidMsg(student, month, amount, txnId) { const monthName = formatMonthYear(month); const cls = student.class || 'Music'; let msg = `Dear ${student.name}, Your fee of ‚Çπ${amount} for ${monthName} for your ${cls} class has been received by ${MY_NAME} (${INSTITUTE_NAME}).`; if(txnId) { msg += ` Transaction ID: ${txnId}.`; } msg += ` Thank you.`; return msg; }
        
        function sendMsg(type, studentId, month, amount = 0, isDue = true) { const student = students.find(s => s.id === studentId); if(!student) return; let txnId = ""; if (!isDue && fees[month] && fees[month][studentId]) { txnId = fees[month][studentId].transactionId || ""; } const msgBody = isDue ? getDueMsg(student, month) : getPaidMsg(student, month, amount, txnId); if(type === 'wa') { let cleanPhone = student.phone.replace(/[^0-9]/g, ''); if(cleanPhone.length === 10) cleanPhone = '91' + cleanPhone; window.open(`https://wa.me/${cleanPhone}?text=${encodeURIComponent(msgBody)}`, '_blank'); } else if (type === 'sms') { window.open(`sms:${student.phone}?body=${encodeURIComponent(msgBody)}`, '_self'); } else if (type === 'mail') { const subject = isDue ? "Fee Reminder" : "Payment Receipt"; window.open(`mailto:${student.email}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(msgBody)}`, '_self'); } }
        function sendGeneralMsg(type, studentId) { const student = students.find(s => s.id === studentId); if(!student) return; const msgBody = `Hello ${student.name}, Hope you are doing well. Just connecting regarding the music classes updates. From Srikanta Banerjee (Guitar, Bass Guitar, Piano, Keyboard, Mandolin Classes.)`; if(type === 'wa') { let cleanPhone = student.phone.replace(/[^0-9]/g, ''); if(cleanPhone.length === 10) cleanPhone = '91' + cleanPhone; window.open(`https://wa.me/${cleanPhone}?text=${encodeURIComponent(msgBody)}`, '_blank'); } else if (type === 'sms') { window.open(`sms:${student.phone}?body=${encodeURIComponent(msgBody)}`, '_self'); } else if (type === 'mail') { window.open(`mailto:${student.email}?subject=${encodeURIComponent("Music Class Info")}&body=${encodeURIComponent(msgBody)}`, '_self'); } }
        
        function sendBirthdayWish(type, studentId) { const student = students.find(s => s.id === studentId); if(!student) return; const msgBody = `Happy Birthday ${student.name}! Wishing you a fantastic day filled with music and joy. Best wishes from Srikanta Banerjee (Guitar, Bass Guitar, Piano, Keyboard, Mandolin Classes).`; if(type === 'wa') { let cleanPhone = student.phone.replace(/[^0-9]/g, ''); if(cleanPhone.length === 10) cleanPhone = '91' + cleanPhone; window.open(`https://wa.me/${cleanPhone}?text=${encodeURIComponent(msgBody)}`, '_blank'); } else if (type === 'sms') { window.open(`sms:${student.phone}?body=${encodeURIComponent(msgBody)}`, '_self'); } else if (type === 'mail') { window.open(`mailto:${student.email}?subject=${encodeURIComponent("Happy Birthday!")}&body=${encodeURIComponent(msgBody)}`, '_self'); } }
        function dismissBirthday(studentId) {
            dismissedBirthdays.push(studentId);
            sessionStorage.setItem('dismissedBirthdays', JSON.stringify(dismissedBirthdays));
            renderDashboard();
        }

        let pendingAction = null, pinInput = "";
        function secureAction(callback, isInit = false) { pendingAction = callback; pinInput = ""; updatePinDots(); document.querySelector('.close-pin').style.display = isInit ? 'none' : 'block'; document.getElementById('securityOverlay').style.display = 'flex'; }
        function closePinScreen() { 
    // ‡¶Ø‡¶¶‡¶ø ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™ ‡¶ö‡¶æ‡¶≤‡ßÅ ‡¶®‡¶æ ‡¶π‡¶Ø‡¶º‡ßá ‡¶•‡¶æ‡¶ï‡ßá (‡¶Ö‡¶∞‡ßç‡¶•‡¶æ‡ßé students ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶∞‡ßá ‡¶ñ‡¶æ‡¶≤‡¶ø), ‡¶§‡¶æ‡¶π‡¶≤‡ßá ‡¶™‡¶ø‡¶® ‡¶ï‡ßç‡¶≤‡ßã‡¶ú ‡¶ï‡¶∞‡¶æ ‡¶Ø‡¶æ‡¶¨‡ßá ‡¶®‡¶æ
    if (!students || students.length === 0) {
        return; 
    }
    document.getElementById('securityOverlay').style.display = 'none'; 
    pendingAction = null; 
    pinInput = ""; 
}
        function pressPin(key) { if (key === 'C') pinInput = ""; else if (pinInput.length < 4) pinInput += key; updatePinDots(); }
        function updatePinDots() { document.querySelectorAll('.pin-dot').forEach((dot, index) => { index < pinInput.length ? dot.classList.add('filled') : dot.classList.remove('filled'); }); }
        async function submitPin() { const currentPin = await dbGet('app_pin'); if (pinInput === currentPin) { document.getElementById('securityOverlay').style.display = 'none'; if (pendingAction) pendingAction(); pendingAction = null; pinInput = ""; } else { alert("Incorrect PIN"); pinInput = ""; updatePinDots(); } }
        async function changeAppPin() { const newPin = document.getElementById('newAppPin').value; if (newPin.length === 4 && !isNaN(newPin)) { await dbSet('app_pin', newPin); Swal.fire('Success', 'PIN changed successfully.', 'success'); document.getElementById('newAppPin').value = ''; } else { Swal.fire('Error', 'PIN must be 4 digits.', 'error'); } }
        
        function sendWelcomeMsg(type, studentId) {
            const student = students.find(s => s.id === studentId);
            if (!student) return;

            const msgBody = `Welcome ${student.name} to the ${student.class || 'Music'} class! We are glad to have you with us. Your classes are on ${student.class_day || 'scheduled day'} at ${student.class_time ? formatTime12H(student.class_time) : 'scheduled time'}. Regards, Srikanta Banerjee (Guitar, Bass Guitar, Piano, Keyboard & Mandolin Classes)`;
            
            if (type === 'wa') {
                let cleanPhone = student.phone.replace(/[^0-9]/g, '');
                if (cleanPhone.length === 10) cleanPhone = '91' + cleanPhone;
                window.open(`https://wa.me/${cleanPhone}?text=${encodeURIComponent(msgBody)}`, '_blank');
            } else if (type === 'sms') {
                window.open(`sms:${student.phone}?body=${encodeURIComponent(msgBody)}`, '_self');
            } else if (type === 'mail') {
                window.open(`mailto:${student.email}?subject=${encodeURIComponent("Welcome to Music Classes")}&body=${encodeURIComponent(msgBody)}`, '_self');
            }
        }
        
        window.shareWelcomePdf = async function(fileName) {
            const file = window.tempPdfFile;
            if (navigator.canShare && navigator.share && file) {
                try {
                    await navigator.share({
                        files: [file],
                        title: 'Welcome Note',
                        text: 'Welcome to Music Classes'
                    });
                } catch (err) {
                    console.log("Share failed", err);
                    alert("Share not supported or cancelled.");
                }
            } else {
                alert("Sharing not supported on this device/browser.");
            }
        };

        window.downloadWelcomePdf = function(fileName) {
             const pdf = window.tempPdfObj;
             if(pdf) pdf.save(fileName);
        };
        
        window.sendWelcomeSmsFromModal = function(studentId) {
            sendWelcomeMsg('sms', studentId);
        };

async function generateWelcomeNote(studentId) {
    const student = students.find(s => s.id === studentId);
    if (!student) return;

    Swal.fire({
        title: 'Generating PDF...',
        text: 'Please wait...',
        allowOutsideClick: false,
        didOpen: () => { Swal.showLoading(); }
    });

    // ‡¶°‡¶æ‡¶ü‡¶æ ‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ
    document.getElementById('wnStudentName').textContent = student.name;
    document.getElementById('wnStudentNameSig').textContent = student.name; // ‡¶∏‡¶ø‡¶ó‡¶®‡ßá‡¶ö‡¶æ‡¶∞‡ßá‡¶∞ ‡¶®‡¶ø‡¶ö‡ßá ‡¶®‡¶æ‡¶Æ
    document.getElementById('wnClass').textContent = student.class || 'Music';
    
    let timeStr = (student.class_day || '') + ' ' + (student.class_time ? formatTime12H(student.class_time) : '');
    document.getElementById('wnTime').textContent = timeStr;
    document.getElementById('wnFee').textContent = '‚Çπ' + (student.fee_amount || DEFAULT_FEE) + '/-';
    document.getElementById('wnAddress').textContent = student.address || '';
    document.getElementById('wnPhone').textContent = student.phone || '';
    document.getElementById('wnFooterDate').textContent = new Date().toLocaleDateString('en-GB');

    // ‡¶õ‡¶¨‡¶ø
    const photoImg = document.getElementById('wnStudentPhoto');
    if (student.photo) { photoImg.src = student.photo; photoImg.style.display = 'block'; } 
    else { photoImg.style.display = 'none'; }

    // --- ‡¶∏‡¶ø‡¶ó‡¶®‡ßá‡¶ö‡¶æ‡¶∞ ‡¶´‡¶ø‡¶ï‡ßç‡¶∏ ---
    const studSigImg = document.getElementById('wnStudentSig');
    if (student.student_signature) { 
        studSigImg.src = student.student_signature; 
        studSigImg.style.display = 'block'; 
    } else { 
        studSigImg.style.display = 'none'; 
    }

    if (instituteLogo) {
        document.getElementById('wnHeaderLogo').src = instituteLogo;
        document.getElementById('wnWatermarkImg').src = instituteLogo;
    }
    if (authorizedSignature) {
        document.getElementById('wnSigImg').src = authorizedSignature;
    }

    setTimeout(async () => {
        const element = document.getElementById('welcomeNoteTemplate');
        
        try {
            const canvas = await html2canvas(element, { 
                scale: 1.5, 
                useCORS: true, 
                logging: false,
                backgroundColor: '#ffffff'
            });
            
            const imgData = canvas.toDataURL('image/jpeg', 0.8);
            
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF('p', 'mm', 'a4');
            const pdfWidth = pdf.internal.pageSize.getWidth();
            const pdfHeight = pdf.internal.pageSize.getHeight();
            
            pdf.addImage(imgData, 'JPEG', 0, 0, pdfWidth, pdfHeight);
            
            const fileName = `Welcome_${student.name.replace(/\s+/g, '_')}.pdf`;
            window.tempPdfObj = pdf;
            const pdfBlob = pdf.output('blob');
            window.tempPdfFile = new File([pdfBlob], fileName, { type: "application/pdf" });

            Swal.close();

            // --- ‡¶Ü‡¶ó‡ßá‡¶∞ ‡¶Æ‡¶§‡ßã ‡¶¨‡¶æ‡¶ü‡¶® ‡¶∏‡¶π ‡¶™‡¶™-‡¶Ü‡¶™ ---
            Swal.fire({
                title: 'Welcome Note Ready!',
                html: `
                    <div class="swal-custom-actions" style="display:flex; flex-direction:column; gap:10px;">
                        <button class="btn-whatsapp" onclick="shareWelcomePdf('${fileName}')" style="padding:10px; width:100%;">
                            <i class="fab fa-whatsapp"></i> Share PDF
                        </button>
                        
                        <div style="display:flex; gap:5px;">
                            <button class="btn-whatsapp" style="background: #128C7E; flex:1;" onclick="sendWelcomeMsg('wa', ${studentId})">
                                <i class="fab fa-whatsapp"></i> Msg (WA)
                            </button>
                            <button class="btn-sms" style="flex:1;" onclick="sendWelcomeSmsFromModal(${studentId})">
                                <i class="fas fa-sms"></i> Send SMS
                            </button>
                        </div>

                        <button class="btn-primary" onclick="downloadWelcomePdf('${fileName}')" style="padding:10px; width:100%;">
                            <i class="fas fa-download"></i> Download PDF
                        </button>
                    </div>
                `,
                icon: 'success',
                showConfirmButton: true,
                confirmButtonText: 'Close',
                confirmButtonColor: '#d33',
                allowOutsideClick: false
            });

        } catch (err) {
            console.error(err);
            Swal.fire('Error', 'Failed to generate PDF.', 'error');
        }
    }, 200);
}
async function addStudent() { 
    const name = document.getElementById('studentName').value; 
    const className = document.getElementById('studentClass').value; 
    const day = document.getElementById('studentDay').value; 
    const time = document.getElementById('studentTime').value; 
    const fee = parseFloat(document.getElementById('studentFee').value) || DEFAULT_FEE; 
    const email = document.getElementById('studentEmail').value; 
    const guardian = document.getElementById('guardianName').value; 
    const phone = document.getElementById('phone').value; 
    const address = document.getElementById('address').value; 
    const dob = document.getElementById('studentDOB').value; 

    if (name.trim() === '') { 
        Swal.fire('Error', 'Name is required.', 'error'); 
        return; 
    } 

    // ‡¶™‡ßç‡¶∞‡¶ø‡¶≠‡¶ø‡¶â ‡¶≤‡¶ú‡¶ø‡¶ï (‡¶Ø‡¶æ ‡¶õ‡¶ø‡¶≤ ‡¶§‡¶æ‡¶á)
    let photoDisplay = '';
    if (currentPhotoBase64) {
        photoDisplay = `<img src="${currentPhotoBase64}" style="width: 80px; height: 80px; border-radius: 50%; object-fit: cover; border: 2px solid #000; margin-bottom: 10px;">`;
    } else {
        photoDisplay = `<div style="width: 80px; height: 80px; border-radius: 50%; background: #eee; display: flex; align-items: center; justify-content: center; margin: 0 auto 10px auto; border: 1px solid #ccc;">No Photo</div>`;
    }

    let timeDisplay = time;
    if(time) {
        const [h, m] = time.split(':');
        const ampm = h >= 12 ? 'PM' : 'AM';
        const h12 = h % 12 || 12;
        timeDisplay = `${h12}:${m} ${ampm}`;
    }
    
    let sigDisplay = currentStudentSignature 
        ? `<div style="margin-top:5px;"><img src="${currentStudentSignature}" style="max-height: 40px; border:1px solid #ddd; padding:2px;"></div>` 
        : '<span style="color:red;">No</span>';

    const detailsHtml = `
        <div style="text-align: center;">${photoDisplay}</div>
        <div style="text-align: left; font-size: 14px; line-height: 1.6; background: var(--bg-input); padding: 15px; border-radius: 8px;">
            <div><strong>Name:</strong> ${name}</div>
            <div><strong>Class:</strong> ${className || '-'}</div>
            <div><strong>Time:</strong> ${day || ''} ${timeDisplay || ''}</div>
            <div><strong>Fee:</strong> ‚Çπ${fee}</div>
            <div><strong>Phone:</strong> ${phone || '-'}</div>
            <div><strong>Guardian:</strong> ${guardian || '-'}</div>
            <div><strong>Address:</strong> ${address || '-'}</div>
            <div><strong>Signature:</strong> ${sigDisplay}</div>
        </div>
        <div style="margin-top: 10px; font-size: 12px; color: var(--danger);">
            * Please check carefully before saving.
        </div>
    `;

    const result = await Swal.fire({
        title: 'Check Details',
        html: detailsHtml,
        icon: 'question',
        showCancelButton: true,
        confirmButtonText: 'Confirm & Save',
        cancelButtonText: 'Edit / Cancel',
        confirmButtonColor: 'var(--success)',
        cancelButtonColor: 'var(--danger)',
        allowOutsideClick: false 
    });

    if (result.isConfirmed) {
        
        const newStudent = { 
            id: Date.now(), 
            serial_no: studentSerialCounter++, 
            name, 
            class: className, 
            class_day: day, 
            class_time: time, 
            fee_amount: fee, 
            email, 
            guardian, 
            phone, 
            address, 
            dob: dob, 
            photo: currentPhotoBase64, 
            student_signature: currentStudentSignature, 
            joining_date: new Date().toISOString().split('T')[0], 
            status: { isActive: true, history: [{ status: 'Active', date: new Date().toISOString().split('T')[0], note: 'Joined' }] } 
        }; 

        // ‡ßß. ‡¶≤‡ßã‡¶ï‡¶æ‡¶≤ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶∞‡ßá‡¶§‡ßá ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶æ
        students.push(newStudent); 
        
        // ‡ß®. ‡¶°‡¶æ‡¶ü‡¶æ‡¶¨‡ßá‡¶∏‡ßá ‡¶Ü‡¶≤‡¶æ‡¶¶‡¶æ ‡¶´‡¶æ‡¶á‡¶≤ ‡¶π‡¶ø‡¶∏‡ßá‡¶¨‡ßá ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡¶æ (NEW CODE)
        await db.collection(COLLECTION_NAME).doc(DOC_ID).collection('students').doc(String(newStudent.id)).set(newStudent);
        
        // ‡ß©. ‡¶∏‡¶ø‡¶∞‡¶ø‡ßü‡¶æ‡¶≤ ‡¶®‡¶æ‡¶Æ‡ßç‡¶¨‡¶æ‡¶∞ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ
        await dbSet('studentSerialCounter', studentSerialCounter);
        
        // ‡¶á‡¶®‡¶™‡ßÅ‡¶ü ‡¶ï‡ßç‡¶≤‡¶ø‡ßü‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶æ
        document.getElementById('studentName').value = ''; 
        document.getElementById('studentClass').value = ''; 
        document.getElementById('studentFee').value = ''; 
        document.getElementById('studentEmail').value = ''; 
        document.getElementById('guardianName').value = ''; 
        document.getElementById('phone').value = ''; 
        document.getElementById('address').value = ''; 
        document.getElementById('studentDOB').value = ''; 
        document.getElementById('studentDay').value = ''; 
        document.getElementById('studentTime').value = ''; 
        document.getElementById('photoPreview').style.display = 'none'; 
        document.getElementById('photoPlaceholder').style.display = 'block'; 
        currentPhotoBase64 = null; 
        currentStudentSignature = null;
        document.getElementById('signatureStatus').style.display = 'none';
        document.getElementById('addStudentCamera').value = ''; 
        document.getElementById('addStudentGallery').value = ''; 
        
        loadAllData(); 
        
        Swal.fire({
            title: 'Student Added!',
            html: `
                <p>Send Welcome Message via:</p>
                <div style="display:flex; flex-wrap:wrap; gap:10px; justify-content:center; margin-top:15px;">
                    <button class="btn-whatsapp btn-like" onclick="sendWelcomeMsg('wa', ${newStudent.id})"><i class="fab fa-whatsapp"></i> WhatsApp</button>
                    <button class="btn-sms btn-like" onclick="sendWelcomeMsg('sms', ${newStudent.id})"><i class="fas fa-sms"></i> SMS</button>
                </div>
                <div style="margin-top:15px;">
                    <button class="btn-welcome btn-like" onclick="generateWelcomeNote(${newStudent.id})" style="width:100%;"><i class="fas fa-file-pdf"></i> Generate Bangla Welcome Note</button>
                </div>
            `,
            icon: 'success',
            showConfirmButton: true,
            confirmButtonColor: '#d33', 
            confirmButtonText: 'Done / Close',
            showCloseButton: true,
            allowOutsideClick: false 
        });
    } 
}
        async function saveData() { 
    // students ‡¶¨‡¶æ‡¶¶‡ßá ‡¶¨‡¶æ‡¶ï‡¶ø ‡¶∏‡¶¨ ‡¶∏‡ßá‡¶≠ ‡¶π‡¶¨‡ßá
    await dbSet('attendance', attendance); 
    await dbSet('fees', fees); 
    await dbSet('reminders', reminders); 
    await dbSet('studentSerialCounter', studentSerialCounter); 
}
        function loadAllData() { renderDashboard(); loadStudentsList(); renderAttendance(); renderFees(); renderReminders(); }
        
        async function exportData() { 
            const logo = await dbGet('instituteLogo');
            const sig = await dbGet('authorizedSignature');
            
            const data = { 
                students, attendance, fees, reminders, studentSerialCounter,
                instituteLogo: logo,
                authorizedSignature: sig
            }; 
            const jsonStr = JSON.stringify(data); const defaultDate = new Date().toISOString().split('T')[0]; const defaultName = `music_class_backup_${defaultDate}.json`; try { if (window.showSaveFilePicker) { const handle = await window.showSaveFilePicker({ suggestedName: defaultName, types: [{ description: 'JSON Backup File', accept: { 'application/json': ['.json'] }, }], }); const writable = await handle.createWritable(); await writable.write(jsonStr); await writable.close(); } else { const { value: fileName } = await Swal.fire({ title: 'Backup File Name', input: 'text', inputValue: defaultName, text: 'Enter a name for your backup file:', showCancelButton: true }); if (!fileName) return; const blob = new Blob([jsonStr], { type: "application/json" }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = fileName.endsWith('.json') ? fileName : fileName + '.json'; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url); } await dbSet('lastBackupDate', new Date().toISOString()); Swal.fire({ title: 'Backup Saved!', html: '<p>Backup file saved successfully. Ekhon file ti <b>Google Drive</b> e upload kore rakhun.</p>', icon: 'success', showCancelButton: true, confirmButtonText: 'Open Google Drive', cancelButtonText: 'Close' }).then((result) => { if (result.isConfirmed) { window.open('https://drive.google.com', '_blank'); } }); } catch (err) { if (err.name !== 'AbortError') { console.error(err); Swal.fire('Error', 'Failed to save backup.', 'error'); } } 
        }

        function openTab(tabName) { 
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active')); 
            document.querySelectorAll('.nav-item').forEach(button => button.classList.remove('active')); 
            document.getElementById(tabName).classList.add('active'); 
            const navBtns = document.querySelectorAll('.nav-item'); 
            navBtns.forEach(btn => { if(btn.getAttribute('onclick').includes(tabName)) btn.classList.add('active'); }); 
            if(tabName === 'dashboard') renderDashboard(); 
            if(tabName === 'analytics') updateYearlyChart(); 
            if(tabName === 'studentMgmt') {
                loadStudentsList();
                // Reset add student form signature
                currentStudentSignature = null;
                document.getElementById('signatureStatus').style.display = 'none';
            }
            if(tabName === 'attendance') {
                const now = new Date();
                const hours = now.getHours().toString().padStart(2, '0');
                const mins = now.getMinutes().toString().padStart(2, '0');
                document.getElementById('attendanceTime').value = `${hours}:${mins}`;
                renderAttendance();
            }
            if(tabName === 'fees') renderFees();
            if(tabName === 'reminders') renderReminders();
        }

        function migrateStudentData(student) { 
            if (!student.status) { student.status = { isActive: true, history: [] }; }
            if (student.status && !student.status.history) { const oldNote = student.status.note || 'Legacy data'; const oldDate = student.status.isActive ? (student.status.last_active_date || student.joining_date) : (student.status.last_inactive_date || student.joining_date); student.status.history = [{ status: student.status.isActive ? 'Active' : 'Inactive', date: oldDate, note: oldNote }]; } 
            if (student.fee_amount === undefined) student.fee_amount = DEFAULT_FEE; 
            if (!student.photo) student.photo = null; 
            if (!student.dob) student.dob = null; 
            if (!student.student_signature) student.student_signature = null; // Ensure field exists
            return student; 
        }

        let currentPhotoBase64 = null; let currentEditPhotoBase64 = null; let photoSelectionContext = 'add';
        function openPhotoSourceModal(context) { photoSelectionContext = context; document.getElementById('photoSourceModal').style.display = 'flex'; }
        function triggerCamera() { closeModal('photoSourceModal'); const id = photoSelectionContext === 'add' ? 'addStudentCamera' : 'editStudentCamera'; document.getElementById(id).click(); }
        function triggerGallery() { closeModal('photoSourceModal'); const id = photoSelectionContext === 'add' ? 'addStudentGallery' : 'editStudentGallery'; document.getElementById(id).click(); }
       function handlePhotoSelection(input, context) {
    const file = input.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            const img = new Image();
            img.onload = function() {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                // ‡¶∏‡¶æ‡¶á‡¶ú ‡¶ï‡¶Æ‡¶æ‡¶®‡ßã ‡¶π‡¶ö‡ßç‡¶õ‡ßá (‡¶Ü‡¶ó‡ßá ‡ßß‡ß´‡ß¶ ‡¶õ‡¶ø‡¶≤, ‡¶è‡¶ñ‡¶® ‡ßß‡ß®‡ß¶ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶≤‡ßã)
                const maxWidth = 120; 
                const scaleSize = maxWidth / img.width;
                canvas.width = maxWidth;
                canvas.height = img.height * scaleSize;
                
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                
                // ‡¶ï‡ßã‡ßü‡¶æ‡¶≤‡¶ø‡¶ü‡¶ø ‡ß¶.‡ß≠ ‡¶•‡ßá‡¶ï‡ßá ‡¶ï‡¶Æ‡¶ø‡ßü‡ßá ‡ß¶.‡ß™ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶≤‡ßã (‡¶∏‡¶æ‡¶á‡¶ú ‡¶Ö‡¶®‡ßá‡¶ï ‡¶ï‡¶Æ‡¶¨‡ßá)
                const base64 = canvas.toDataURL('image/jpeg', 0.4); 

                if (context === 'add') {
                    currentPhotoBase64 = base64;
                    document.getElementById('photoPreview').src = base64;
                    document.getElementById('photoPreview').style.display = 'block';
                    document.getElementById('photoPlaceholder').style.display = 'none';
                } else {
                    currentEditPhotoBase64 = base64;
                    document.getElementById('editPhotoPreview').src = base64;
                }
            };
            img.src = e.target.result;
        };
        reader.readAsDataURL(file);
    }
}

        async function importData(event) { 
    const file = event.target.files[0]; 
    if (!file) return; 
    
    const reader = new FileReader(); 
    reader.onload = function(e) { 
        try { 
            const json = e.target.result; 
            let importedData = JSON.parse(json); 

            if (!importedData || !Array.isArray(importedData.students)) { 
                throw new Error("Invalid Data Format"); 
            } 

            Swal.fire({ 
                title: 'Restore Data?', 
                text: "This will restore your data to the new system.", 
                icon: 'question', 
                showCancelButton: true, 
                confirmButtonText: 'Yes, Restore' 
            }).then(async (result) => { 
                if (result.isConfirmed) { 
                    
                    Swal.fire({
                        title: 'Restoring...', 
                        html: 'Preparing data...<br><b>Do not close the app.</b>',
                        allowOutsideClick: false,
                        didOpen: () => Swal.showLoading()
                    });

                    // ‡ßß. ‡¶Æ‡ßá‡¶Æ‡ßã‡¶∞‡¶ø‡¶§‡ßá ‡¶°‡¶æ‡¶ü‡¶æ ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶æ
                    students = (importedData.students || []).map(migrateStudentData); 
                    attendance = importedData.attendance || {}; 
                    fees = importedData.fees || {}; 
                    reminders = importedData.reminders || []; 
                    studentSerialCounter = importedData.studentSerialCounter || (students.length + 1); 
                    
                    if(importedData.instituteLogo) await dbSet('instituteLogo', importedData.instituteLogo);
                    if(importedData.authorizedSignature) await dbSet('authorizedSignature', importedData.authorizedSignature);

                    // ‡ß®. ‡¶Ü‡¶∏‡¶≤ ‡¶ï‡¶æ‡¶ú: ‡¶≤‡ßÅ‡¶™ ‡¶ö‡¶æ‡¶≤‡¶ø‡ßü‡ßá (One by one) ‡¶Ü‡¶™‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶æ - ‡¶Ø‡¶æ‡¶§‡ßá ‡¶π‡ßç‡¶Ø‡¶æ‡¶Ç ‡¶®‡¶æ ‡¶π‡ßü
                    let completed = 0;
                    for (const student of students) {
                        try {
                            await db.collection(COLLECTION_NAME).doc(DOC_ID).collection('students').doc(String(student.id)).set(student);
                            completed++;
                            // ‡¶™‡ßç‡¶∞‡ßã‡¶ó‡ßç‡¶∞‡ßá‡¶∏ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®‡ßã
                            Swal.update({
                                html: `Restoring...<br><b>Uploaded: ${completed} / ${students.length}</b><br>Please wait...`
                            });
                        } catch (err) {
                            console.error("Failed to upload student:", student.name, err);
                        }
                    }

                    // ‡ß©. ‡¶¨‡¶æ‡¶ï‡¶ø ‡¶°‡¶æ‡¶ü‡¶æ ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡¶æ
                    await saveData(); 
                    
                    await loadInstituteLogo(); 
                    await loadAuthSignature(); 
                    loadAllData(); 
                    
                    Swal.fire('Success', 'Data restored successfully!', 'success'); 
                } 
            }); 
        } catch (error) { 
            console.error(error); 
            Swal.fire('Error', 'Failed to load backup file. Check Console.', 'error'); 
        } finally { 
            event.target.value = null; 
        } 
    }; 
    reader.readAsText(file); 
}

        function openStatusChangeModal(id, toActive) { document.getElementById('statusChangeStudentId').value = id; document.getElementById('statusChangeToActive').value = toActive; document.getElementById('statusChangeTitle').textContent = toActive ? 'Activate Student' : 'Deactivate Student'; document.getElementById('statusDate').valueAsDate = new Date(); document.getElementById('statusNote').value = ''; document.getElementById('statusChangeModal').style.display = 'flex'; }
        async function saveStatusChange() { 
    const id = parseInt(document.getElementById('statusChangeStudentId').value); 
    const toActive = document.getElementById('statusChangeToActive').value === 'true'; 
    const note = document.getElementById('statusNote').value.trim(); 
    const statusDate = document.getElementById('statusDate').value; 
    
    if (!statusDate) { Swal.fire('Error', 'Please select a date.', 'error'); return; } 
    
    const student = students.find(s => s.id === id); 
    if (student) { 
        student.status.isActive = toActive; 
        student.status.history.unshift({ status: toActive ? 'Active' : 'Inactive', date: statusDate, note: note || (toActive ? 'Re-activated' : 'Deactivated') }); 
        
        // ‡¶°‡¶æ‡¶ü‡¶æ‡¶¨‡ßá‡¶∏‡ßá ‡¶Ü‡¶™‡¶°‡ßá‡¶ü (Specific Document Update)
        await db.collection(COLLECTION_NAME).doc(DOC_ID).collection('students').doc(String(id)).update({
            status: student.status
        });

        await saveData(); // (Optional: attendance or counters if needed)
        loadAllData(); 
        closeModal('statusChangeModal'); 
        Swal.fire('Updated', `Status changed.`, 'success'); 
    } 
}        function formatTime12H(timeStr) {
            if(!timeStr) return '';
            const [h, m] = timeStr.split(':');
            const ampm = h >= 12 ? 'PM' : 'AM';
            const h12 = h % 12 || 12;
            return `${h12}:${m} ${ampm}`;
        }

        function getStudentHtml(student) { 
            const photoSrc = student.photo ? student.photo : 'https://via.placeholder.com/40?text=S'; 
            const phoneText = student.phone ? `<span class="student-phone-sub">${student.phone}</span>` : ''; 
            const formattedTime = student.class_time ? formatTime12H(student.class_time) : '';
            const dayText = student.class_day ? `<span class="student-time-sub">${student.class_day} ${formattedTime}</span>` : ''; 
            const hiddenAddress = `<span style="display:none;">${student.address || ''}</span>`;
            return `
            <div class="student-cell">
                <img src="${photoSrc}" class="student-thumb">
                <div class="student-info">
                    <span class="student-name-link" onclick="showStudentDetails(${student.id})">${student.name}</span>
                    ${phoneText}
                    ${dayText}
                    ${hiddenAddress}
                </div>
            </div>`; 
        }

        function isMonthDue(monthStr) { const now = new Date(); now.setHours(0,0,0,0); const [year, month] = monthStr.split('-').map(Number); const firstDayOfMonth = new Date(year, month - 1, 1); if (firstDayOfMonth > now) return false; const currentYear = now.getFullYear(), currentMonthIndex = now.getMonth(), currentDay = now.getDate(); if (year < currentYear) return true; if (year === currentYear && month - 1 < currentMonthIndex) return true; return year === currentYear && month - 1 === currentMonthIndex && currentDay > DUE_DATE; }
        function formatMonthYear(monthStr) { const [year, month] = monthStr.split('-'); const date = new Date(year, month - 1); return date.toLocaleString('en-US', { month: 'long', year: 'numeric' }); }
        
        function getContactButtons(studentId, month) { const student = students.find(s => s.id === studentId); if (!student) return 'N/A'; let b = ''; const isDue = month && isMonthDue(month) && wasStudentActiveDuringMonth(student, month) && !(fees[month]?.[student.id]?.status === 'paid'); if (student.phone || student.email) { if(isDue) { b += `<button class="btn-whatsapp" onclick="sendMsg('wa', ${student.id}, '${month}')">WhatsApp</button>`; b += `<button class="btn-sms" onclick="sendMsg('sms', ${student.id}, '${month}')">SMS</button>`; b += `<button class="btn-mail" onclick="sendMsg('mail', ${student.id}, '${month}')">Email</button>`; b += `<a href="tel:${student.phone}" class="btn-like btn-call">Call</a>`; } else { b += `<a href="tel:${student.phone}" class="btn-like btn-call">Call</a>`; } } return b || 'N/A'; }
        function getAllContactButtons(student) { let b = ''; if (student.phone) { b += `<a href="tel:${student.phone}" class="btn-like btn-call">Call</a>`; b += `<button class="btn-whatsapp" onclick="sendGeneralMsg('wa', ${student.id})">WhatsApp</button>`; b += `<button class="btn-sms" onclick="sendGeneralMsg('sms', ${student.id})">SMS</button>`; } if (student.email) { b += `<button class="btn-mail" onclick="sendGeneralMsg('mail', ${student.id})">Mail</button>`; } return b || 'N/A'; }
        
        function showFeeBreakdown(type, specificMonth = null) {
            const selectedMonth = specificMonth || document.getElementById('feeMonth').value;
            if(!selectedMonth) return;
            const monthIsDue = isMonthDue(selectedMonth);
            
            const list = students.filter(s => {
                if(!wasStudentActiveDuringMonth(s, selectedMonth)) return false;
                const feeRecord = fees[selectedMonth]?.[s.id];
                const isPaid = feeRecord?.status === 'paid';
                if (type === 'collected') return isPaid;
                if (type === 'due') return !isPaid && monthIsDue;
                return false;
            });

            if (type === 'collected') {
                list.sort((a, b) => {
                    const dateA = new Date(fees[selectedMonth][a.id].date);
                    const dateB = new Date(fees[selectedMonth][b.id].date);
                    return dateB - dateA; 
                });
            } else if (type === 'due') {
                list.sort((a, b) => {
                    const duesA = getDueMonthsList(a.id).length;
                    const duesB = getDueMonthsList(b.id).length;
                    return duesB - duesA;
                });
            }
            
            document.getElementById('classStudentsTitle').textContent = type === 'collected' ? `Paid Students (${formatMonthYear(selectedMonth)})` : `Due Students (${formatMonthYear(selectedMonth)})`;
            const tableBody = document.querySelector('#classStudentsTable tbody');
            const tableHead = document.querySelector('#classStudentsTable thead tr');
            
            tableHead.innerHTML = '<th>ID</th><th>Student</th><th>Contact</th>';
            tableBody.innerHTML = '';
            
            if(list.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="3" style="text-align:center; padding:20px;">No students found.</td></tr>';
            } else {
                list.forEach(s => {
                    const feeRecord = fees[selectedMonth]?.[s.id];
                    let info = '';
                    if(type === 'collected') info = `<br><span style="font-size:10px; color:green;">‚Çπ${feeRecord.amount} on ${new Date(feeRecord.date).toLocaleDateString()}</span>`;
                    else {
                        const totalDueMonths = getDueMonthsList(s.id).length;
                        info = `<br><span style="font-size:10px; color:red;">Due: ‚Çπ${s.fee_amount || DEFAULT_FEE} (${totalDueMonths} Months Pending)</span>`;
                    }
                    
                    tableBody.innerHTML += `<tr><td>${s.serial_no}</td><td>${getStudentHtml(s)}${info}</td><td>${type === 'due' ? getContactButtons(s.id, selectedMonth) : getAllContactButtons(s)}</td></tr>`;
                });
            }
            document.getElementById('classStudentsModal').style.display = 'flex';
        }

        function showYearlyBreakdown(type, year) {
            let reportData = [];
            students.forEach(student => {
                let monthsDetails = [];
                let studentTotal = 0;

                for(let i=1; i<=12; i++) {
                     const monthStr = `${year}-${i.toString().padStart(2, '0')}`;
                     const monthName = new Date(year, i-1).toLocaleString('default', { month: 'short' });

                     if (wasStudentActiveDuringMonth(student, monthStr)) {
                         if (type === 'collected') {
                             if (fees[monthStr]?.[student.id]?.status === 'paid') {
                                 const amt = fees[monthStr][student.id].amount;
                                 monthsDetails.push(`${monthName}: ‚Çπ${amt}`);
                                 studentTotal += amt;
                             }
                         } else if (type === 'due') {
                             if (isMonthDue(monthStr) && fees[monthStr]?.[student.id]?.status !== 'paid') {
                                 const amt = student.fee_amount || DEFAULT_FEE;
                                 monthsDetails.push(`${monthName}: ‚Çπ${amt}`);
                                 studentTotal += amt;
                             }
                         }
                     }
                }

                if (studentTotal > 0) {
                    reportData.push({ student, months: monthsDetails, total: studentTotal });
                }
            });

            reportData.sort((a, b) => b.total - a.total);

            const title = type === 'collected' ? `Collected Breakdown (${year})` : `Due Breakdown (${year})`;
            document.getElementById('classStudentsTitle').textContent = title;
            const tableBody = document.querySelector('#classStudentsTable tbody');
            const tableHead = document.querySelector('#classStudentsTable thead tr');

            tableHead.innerHTML = '<th>Student</th><th>Monthly Breakdown</th><th>Total</th>';
            tableBody.innerHTML = '';

            if(reportData.length === 0) {
                 tableBody.innerHTML = '<tr><td colspan="3" style="text-align:center; padding:20px;">No data found for this year.</td></tr>';
            } else {
                reportData.forEach(item => {
                    const breakdownHtml = item.months.map(m => `<span style="font-size:11px; display:inline-block; background:var(--bg-input); padding:2px 5px; margin:2px; border-radius:4px; border:1px solid var(--border-color);">${m}</span>`).join(' ');

                    tableBody.innerHTML += `
                        <tr>
                            <td>${getStudentHtml(item.student)}</td>
                            <td>${breakdownHtml}</td>
                            <td style="font-weight:bold; color:${type==='collected'?'var(--success)':'var(--danger)'}">‚Çπ${item.total}</td>
                        </tr>
                    `;
                });
            }

            document.getElementById('classStudentsModal').style.display = 'flex';
        }

        function showClassStudents(className) { 
            document.getElementById('classStudentsTitle').textContent = `Students in ${className} Class`; 
            const tableBody = document.querySelector('#classStudentsTable tbody'); 
            const tableHead = document.querySelector('#classStudentsTable thead tr');
            tableHead.innerHTML = '<th>ID</th><th>Student</th><th>Contact</th>'; 
            tableBody.innerHTML = ''; 
            const classStudents = students.filter(s => s.status?.isActive && (s.class || 'Unassigned') === className); 
            classStudents.forEach(s => { tableBody.innerHTML += `<tr><td>${s.serial_no}</td><td>${getStudentHtml(s)}</td><td>${getContactButtons(s.id)}</td></tr>`; }); 
            document.getElementById('classStudentsModal').style.display = 'flex'; 
        }

        function showCategoryList(type) { 
            const list = students.filter(s => type === 'active' ? s.status?.isActive : !s.status?.isActive); 
            document.getElementById('classStudentsTitle').textContent = type === 'active' ? 'Active Students' : 'Inactive Students'; 
            const tableBody = document.querySelector('#classStudentsTable tbody'); 
            const tableHead = document.querySelector('#classStudentsTable thead tr');
            tableHead.innerHTML = '<th>ID</th><th>Student</th><th>Contact</th>'; 
            tableBody.innerHTML = ''; 
            if(list.length === 0) { tableBody.innerHTML = '<tr><td colspan="3" style="text-align:center; padding:20px;">No students found.</td></tr>'; } 
            else { list.forEach(s => { tableBody.innerHTML += `<tr><td>${s.serial_no}</td><td>${getStudentHtml(s)}</td><td>${getAllContactButtons(s)}</td></tr>`; }); } 
            document.getElementById('classStudentsModal').style.display = 'flex'; 
        }
        
        function checkBirthday(dobString) { if (!dobString) return false; const today = new Date(); const dob = new Date(dobString); return today.getDate() === dob.getDate() && today.getMonth() === dob.getMonth(); }
        function updateReminderDay() { const dateVal = document.getElementById('reminderDate').value; if (dateVal) { const date = new Date(dateVal); const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday']; document.getElementById('reminderDay').value = days[date.getDay()]; } }
        async function addReminder() { 
    const text = document.getElementById('reminderText').value.trim(); 
    const day = document.getElementById('reminderDay').value; 
    const dateVal = document.getElementById('reminderDate').value; // Tarikh nawa holo

    if(!text) { 
        Swal.fire('Error', 'Please enter reminder text.', 'error'); 
        return; 
    } 

    // Ekhane 'date' property add kora holo
    reminders.push({ id: Date.now(), text: text, day: day, date: dateVal }); 
    
    await saveData(); 
    
    document.getElementById('reminderText').value = ''; 
    document.getElementById('reminderDate').value = ''; 
    renderReminders(); 
    
    Swal.fire('Added', 'Reminder added successfully.', 'success'); 
}
        async function deleteReminder(id) { reminders = reminders.filter(r => r.id !== id); await saveData(); renderReminders(); }
        function renderReminders() { 
    const listContainer = document.getElementById('reminderListContainer'); 
    listContainer.innerHTML = ''; 
    const days = ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"]; 
    
    days.forEach(day => { 
        const dayReminders = reminders.filter(r => r.day === day); 
        
        if(dayReminders.length > 0) { 
            const dayHeader = document.createElement('h4'); 
            dayHeader.style.cssText = "margin: 15px 0 5px 0; color: var(--primary); font-size:14px; border-bottom:1px solid var(--border-color); padding-bottom: 5px;"; 
            dayHeader.textContent = day; 
            listContainer.appendChild(dayHeader); 
            
            dayReminders.forEach(r => { 
                // Tarikh format kora (DD/MM/YYYY)
                let dateDisplay = "";
                if(r.date) {
                    const d = new Date(r.date);
                    dateDisplay = `<div style="font-size:10px; color:var(--text-muted); margin-top:2px;">üìÖ ${d.toLocaleDateString('en-IN')}</div>`;
                }

                const div = document.createElement('div'); 
                div.className = 'reminder-item'; 
                // Ekhane design change kora hoyeche date dekhanor jonno
                div.innerHTML = `
                    <div style="flex:1;">
                        <span style="font-weight:500;">${r.text}</span>
                        ${dateDisplay}
                    </div> 
                    <button class="btn-danger" style="padding:5px 10px; height:30px;" onclick="deleteReminder(${r.id})">
                        <i class="fas fa-trash"></i>
                    </button>`; 
                listContainer.appendChild(div); 
            }); 
        } 
    }); 
    
    if(reminders.length === 0) { 
        listContainer.innerHTML = '<p style="text-align:center; color:var(--text-muted); font-size:12px; margin-top:20px;">No reminders set.</p>'; 
    } 
}
        function renderDashboard() { 
            const activeStudents = students.filter(s => s.status?.isActive); 
            document.getElementById('studentStatsSummary').innerHTML = `<div class="clickable-stat" onclick="showCategoryList('active')"><h4>Active</h4><p class="summary-collected">${activeStudents.length}</p></div><div class="clickable-stat" onclick="showCategoryList('inactive')"><h4>Inactive</h4><p class="summary-due">${students.length - activeStudents.length}</p></div><div><h4>Total</h4><p class="summary-total" style="color:var(--text-main);">${students.length}</p></div>`; 
            const birthdayBox = document.getElementById('birthdayAlertBox'); const birthdayList = document.getElementById('birthdayList'); 
            const birthdayStudents = activeStudents.filter(s => checkBirthday(s.dob) && !dismissedBirthdays.includes(s.id)); 
            if (birthdayStudents.length > 0) { birthdayList.innerHTML = ''; birthdayStudents.forEach(s => { birthdayList.innerHTML += `<div style="display:flex; align-items:center; justify-content:space-between; background:var(--bg-input); padding:10px; border-radius:8px; margin-bottom:5px; border:1px solid #ffe4e6; color:var(--text-main);"><div style="display:flex; align-items:center;"><img src="${s.photo || 'https://via.placeholder.com/40?text=S'}" style="width:40px; height:40px; border-radius:50%; margin-right:10px; object-fit:cover; border: 2px solid #000 !important;"><div><strong>${s.name}</strong><br><span style="font-size:11px; color:var(--text-muted);">${s.class || 'Student'}</span></div></div><div style="display:flex; gap:5px;"><button class="btn-whatsapp btn-like" onclick="sendBirthdayWish('wa', ${s.id})"><i class="fab fa-whatsapp"></i></button><button class="btn-sms btn-like" onclick="sendBirthdayWish('sms', ${s.id})"><i class="fas fa-sms"></i></button><button class="btn-success btn-like" onclick="dismissBirthday(${s.id})" title="Dismiss"><i class="fas fa-check"></i></button></div></div>`; }); birthdayBox.style.display = 'block'; } else { birthdayBox.style.display = 'none'; }
            const classCounts = activeStudents.reduce((acc, student) => { const className = student.class || 'Unassigned'; acc[className] = (acc[className] || 0) + 1; return acc; }, {}); const classListEl = document.getElementById('classStrengthList'); classListEl.innerHTML = ''; Object.entries(classCounts).sort().forEach(([className, count]) => { classListEl.innerHTML += `<li onclick="showClassStudents('${className}')" style="cursor:pointer; color:var(--text-main);"><strong>${className}:</strong> <span>${count} students</span></li>`; }); 
            let monthlyCollected = 0, monthlyDueAmount = 0, yearlyCollected = 0, yearlyDueAmount = 0; const currentYear = new Date().getFullYear(), currentMonthStr = `${currentYear}-${(new Date().getMonth() + 1).toString().padStart(2, '0')}`; 
            
            const days = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"]; const todayName = days[new Date().getDay()]; const todaysReminders = reminders.filter(r => r.day === todayName); const rBox = document.getElementById('dashboardRemindersBox'); const rList = document.getElementById('dashboardReminderList'); if(todaysReminders.length > 0) { rList.innerHTML = ''; todaysReminders.forEach(r => { rList.innerHTML += `<div style="padding:8px; border-bottom:1px solid #fde68a; font-size:13px; color:var(--text-main);">‚Ä¢ ${r.text}</div>`; }); rBox.style.display = 'block'; } else { rBox.style.display = 'none'; }
            
            students.forEach(student => { 
                for (let i = 0; i < 12; i++) { 
                    const monthStr = `${currentYear}-${(i + 1).toString().padStart(2, '0')}`; 
                    if (wasStudentActiveDuringMonth(student, monthStr)) { 
                        if (fees[monthStr]?.[student.id]?.status === 'paid') { 
                            if (monthStr === currentMonthStr) monthlyCollected += fees[monthStr][student.id].amount; 
                            yearlyCollected += fees[monthStr][student.id].amount; 
                        } else if (isMonthDue(monthStr)) { 
                            const studentFee = student.fee_amount || DEFAULT_FEE; 
                            if (monthStr === currentMonthStr) monthlyDueAmount += studentFee; 
                            yearlyDueAmount += studentFee; 
                        } 
                    } 
                } 
            });
            document.getElementById('dashboardYearlySummary').innerHTML = `<div onclick="showYearlyBreakdown('collected', '${currentYear}')" style="cursor:pointer;"><h4>Yearly Collected</h4><p class="summary-collected">‚Çπ${yearlyCollected}</p></div><div onclick="showYearlyBreakdown('due', '${currentYear}')" style="cursor:pointer;"><h4>Yearly Due (Active)</h4><p class="summary-due">‚Çπ${yearlyDueAmount}</p></div>`; 
            document.getElementById('financeOverviewNumbers').innerHTML = `<div onclick="showFeeBreakdown('collected')"><h4>Collected</h4><p class="summary-collected">‚Çπ${monthlyCollected}</p></div><div onclick="showFeeBreakdown('due')"><h4>Due</h4><p class="summary-due">‚Çπ${monthlyDueAmount}</p></div>`;

            const dueTableBody = document.querySelector('#dueFeeTable tbody'); const dueMessageEl = document.getElementById('dueFeeMessage'); dueTableBody.innerHTML = ''; 
            
            const defaulters = students.filter(s => s.status?.isActive).map(s => { return { student: s, months: getDueMonthsList(s.id) }; }).filter(item => item.months.length > 0); 
            
            defaulters.sort((a, b) => b.months.length - a.months.length);
            if (defaulters.length === 0) { dueMessageEl.textContent = "No pending dues."; } else { dueMessageEl.textContent = `(${defaulters.length}) students have pending dues.`; defaulters.forEach(item => { const monthsStr = item.months.join(", "); const studentHtml = getStudentHtml(item.student); const dueDisplay = `<div style="margin-top:5px; font-size:11px; color:#dc2626; font-weight:600; line-height:1.4;">Due: ${monthsStr}</div>`; const latestDueMonth = item.months.length > 0 ? getMonthStrFromFormat(item.months[0]) : currentMonthStr; dueTableBody.innerHTML += `<tr><td>${studentHtml}${dueDisplay}</td><td class="action-buttons">${getContactButtons(item.student.id, latestDueMonth)}</td></tr>`; }); }
            
            const ctx = document.getElementById('financeChart').getContext('2d'); if (financeChartInstance) financeChartInstance.destroy(); financeChartInstance = new Chart(ctx, { type: 'doughnut', data: { labels: ['Collected', 'Due'], datasets: [{ data: [monthlyCollected, monthlyDueAmount], backgroundColor: ['#28a745', '#dc3545'], hoverOffset: 4 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { color: getComputedStyle(document.body).getPropertyValue('--text-main') } }, title: { display: true, text: `Summary for ${formatMonthYear(currentMonthStr)}`, color: getComputedStyle(document.body).getPropertyValue('--text-main') } } } });
        }

        function getMonthStrFromFormat(formattedMonth) { const parts = formattedMonth.split(' '); if (parts.length !== 2) return null; const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"]; const monthIndex = monthNames.findIndex(name => name === parts[0]); if (monthIndex === -1) return null; const month = (monthIndex + 1).toString().padStart(2, '0'); const year = parts[1]; return `${year}-${month}`; }
// ‡ßß. ‡¶®‡¶§‡ßÅ‡¶® ‡¶´‡ßÅ‡¶ü‡¶æ‡¶∞ ‡¶´‡¶æ‡¶Ç‡¶∂‡¶® (‡¶è‡¶ü‡¶ø ‡¶™‡ßç‡¶∞‡¶§‡¶ø ‡¶™‡ßá‡¶ú‡ßá‡¶∞ ‡¶®‡¶ø‡¶ö‡ßá ‡¶°‡ßá‡¶ü ‡¶ì ‡¶∏‡¶ø‡¶ó‡¶®‡ßá‡¶ö‡¶æ‡¶∞ ‡¶¨‡¶∏‡¶æ‡¶¨‡ßá)
function addPageFooter(doc, dateStr) {
    const pageCount = doc.getNumberOfPages();
    const pageWidth = doc.internal.pageSize.getWidth();
    const pageHeight = doc.internal.pageSize.getHeight();
    const margin = 15;
    const footerY = pageHeight - 20; // ‡¶®‡¶ø‡¶ö ‡¶•‡ßá‡¶ï‡ßá ‡ß®‡ß¶ ‡¶Æ‡¶ø‡¶Æ‡¶ø ‡¶â‡¶™‡¶∞‡ßá

    for (let i = 1; i <= pageCount; i++) {
        doc.setPage(i);

        // ‡¶ì‡ßü‡¶æ‡¶ü‡¶æ‡¶∞‡¶Æ‡¶æ‡¶∞‡ßç‡¶ï (Watermark)
        if (instituteLogo) {
            doc.saveGraphicsState();
            doc.setGState(new doc.GState({ opacity: 0.05 })); // ‡¶ñ‡ßÅ‡¶¨ ‡¶π‡¶æ‡¶≤‡¶ï‡¶æ
            const imgSize = 100;
            doc.addImage(instituteLogo, 'JPEG', (pageWidth - imgSize) / 2, (pageHeight - imgSize) / 2, imgSize, imgSize);
            doc.restoreGraphicsState();
        }

        // --- ‡¶´‡ßÅ‡¶ü‡¶æ‡¶∞ ‡¶è‡¶∞‡¶ø‡ßü‡¶æ ---
        
        // ‡ßß. ‡¶¨‡¶æ‡¶Æ ‡¶¶‡¶ø‡¶ï‡ßá ‡¶°‡ßá‡¶ü (Date on Bottom Left)
        doc.setFontSize(9);
        doc.setFont("helvetica", "normal");
        doc.setTextColor(50);
        doc.text(`Generated Date: ${dateStr}`, margin, footerY + 5);
        
        // ‡¶™‡ßá‡¶ú ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ (‡¶Æ‡¶æ‡¶ù‡¶ñ‡¶æ‡¶®‡ßá)
        doc.text(`Page ${i} of ${pageCount}`, pageWidth / 2, footerY + 15, { align: 'center' });

        // ‡ß®. ‡¶°‡¶æ‡¶® ‡¶¶‡¶ø‡¶ï‡ßá ‡¶∏‡¶ø‡¶ó‡¶®‡ßá‡¶ö‡¶æ‡¶∞ (Signature on Bottom Right)
        if (authorizedSignature) {
            // ‡¶∏‡¶ø‡¶ó‡¶®‡ßá‡¶ö‡¶æ‡¶∞ ‡¶á‡¶Æ‡ßá‡¶ú
            doc.addImage(authorizedSignature, 'PNG', pageWidth - 50, footerY - 10, 35, 12);
        }
        
        // ‡¶∏‡¶ø‡¶ó‡¶®‡ßá‡¶ö‡¶æ‡¶∞ ‡¶ü‡ßá‡¶ï‡ßç‡¶∏‡¶ü
        doc.setFontSize(8);
        doc.setFont("helvetica", "bold");
        doc.text("Authorized Signature", pageWidth - 15, footerY + 5, { align: "right" });
        doc.setFont("helvetica", "italic");
        doc.text(`(${MY_NAME})`, pageWidth - 15, footerY + 9, { align: "right" });
    }
}

// ‡ß®. ‡¶Æ‡ßá‡¶á‡¶® ‡¶™‡¶ø‡¶°‡¶ø‡¶è‡¶´ ‡¶´‡¶æ‡¶Ç‡¶∂‡¶® (‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ)
function exportStudentDetailsAsPDF(studentId) {
    const student = students.find(s => s.id === studentId);
    if (!student) return;

    // ... ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®‡ßá‡¶∞ ‡¶∂‡ßÅ‡¶∞‡ßÅ‡¶∞ ‡¶≠‡ßá‡¶∞‡¶ø‡ßü‡ßá‡¶¨‡¶≤‡¶ó‡ßÅ‡¶≤‡ßã ...
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    const pageWidth = doc.internal.pageSize.getWidth();
    const currentDate = new Date().toLocaleDateString('en-IN');

    let y = 20;
    const leftMargin = 15;
    const lineHeight = 7;

    // --- ‡ßß. ‡¶π‡ßá‡¶°‡¶æ‡¶∞ ‡¶∏‡ßá‡¶ï‡¶∂‡¶® (‡¶≤‡ßã‡¶ó‡ßã ‡¶∏‡¶π ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ) ---
    
    // ‡¶≤‡ßã‡¶ó‡ßã ‡¶¨‡¶∏‡¶æ‡¶®‡ßã (‡¶¨‡¶æ‡¶Æ ‡¶¶‡¶ø‡¶ï‡ßá)
    if (instituteLogo) {
        const logoSize = 20; // ‡¶≤‡ßã‡¶ó‡ßã‡¶∞ ‡¶∏‡¶æ‡¶á‡¶ú (‡¶õ‡ßã‡¶ü)
        // (x=15, y=15) ‡¶™‡¶ú‡¶ø‡¶∂‡¶®‡ßá ‡¶≤‡ßã‡¶ó‡ßã ‡¶¨‡¶∏‡¶¨‡ßá
        doc.addImage(instituteLogo, 'JPEG', leftMargin, 15, logoSize, logoSize);
    }

    // ‡¶ü‡¶æ‡¶á‡¶ü‡ßá‡¶≤ (‡¶∏‡ßá‡¶®‡ßç‡¶ü‡¶æ‡¶∞‡ßá)
    doc.setFontSize(20);
    doc.setFont("helvetica", "bold");
    doc.setTextColor(0);
    
    // ‡¶ü‡¶æ‡¶á‡¶ü‡ßá‡¶≤‡¶ü‡¶ø ‡¶Ø‡¶æ‡¶§‡ßá ‡¶≤‡ßã‡¶ó‡ßã‡¶∞ ‡¶â‡¶™‡¶∞‡ßá ‡¶®‡¶æ ‡¶â‡¶†‡ßá ‡¶Ø‡¶æ‡ßü, ‡¶§‡¶æ‡¶á ‡¶è‡¶ï‡¶ü‡ßÅ ‡¶ú‡¶æ‡ßü‡¶ó‡¶æ ‡¶∞‡¶æ‡¶ñ‡¶æ ‡¶π‡¶≤‡ßã
    // ‡¶≤‡ßã‡¶ó‡ßã ‡¶•‡¶æ‡¶ï‡¶≤‡ßá‡¶ì ‡¶ü‡¶æ‡¶á‡¶ü‡ßá‡¶≤ ‡¶™‡ßá‡¶ú‡ßá‡¶∞ ‡¶Æ‡¶æ‡¶ù‡¶ñ‡¶æ‡¶®‡ßá (Center) ‡¶•‡¶æ‡¶ï‡¶¨‡ßá, ‡¶¶‡ßá‡¶ñ‡¶§‡ßá ‡¶™‡ßç‡¶∞‡ßã‡¶´‡ßá‡¶∂‡¶®‡¶æ‡¶≤ ‡¶≤‡¶æ‡¶ó‡¶¨‡ßá
    const titleLines = doc.splitTextToSize(INSTITUTE_NAME, 130); 
    
    // ‡¶≤‡ßã‡¶ó‡ßã ‡¶•‡¶æ‡¶ï‡¶≤‡ßá ‡¶ü‡¶æ‡¶á‡¶ü‡ßá‡¶≤ ‡¶è‡¶ï‡¶ü‡ßÅ ‡¶°‡¶æ‡¶® ‡¶¶‡¶ø‡¶ï ‡¶•‡ßá‡¶ï‡ßá ‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶π‡¶¨‡ßá ‡¶®‡¶æ, ‡¶Æ‡¶æ‡¶ù‡¶ñ‡¶æ‡¶®‡ßá‡¶á ‡¶•‡¶æ‡¶ï‡¶¨‡ßá ‡¶§‡¶¨‡ßá y ‡¶™‡¶ú‡¶ø‡¶∂‡¶® ‡¶†‡¶ø‡¶ï ‡¶•‡¶æ‡¶ï‡¶¨‡ßá
    const titleY = instituteLogo ? 20 : 20; 
    
    doc.text(titleLines, pageWidth / 2, titleY, { align: 'center' });
    y += (titleLines.length * 8) + 8; // ‡¶∏‡ßç‡¶™‡ßá‡¶∏ ‡¶¨‡¶æ‡ßú‡¶æ‡¶®‡ßã ‡¶π‡¶≤‡ßã

    // ‡¶∏‡¶æ‡¶¨-‡¶π‡ßá‡¶°‡¶æ‡¶∞
    doc.setFontSize(14);
    doc.setTextColor(80);
    doc.text("STUDENT PROFILE REPORT", pageWidth / 2, y, { align: 'center' });
    y += 8;

    // ‡¶≤‡¶æ‡¶á‡¶®
    doc.setDrawColor(100);
    doc.setLineWidth(0.5);
    doc.line(leftMargin, y, pageWidth - leftMargin, y);
    y += 15;

    // ... ‡¶è‡¶∞‡¶™‡¶∞ "‡ß®. ‡¶õ‡¶¨‡¶ø ‡¶è‡¶¨‡¶Ç ‡¶¨‡ßá‡¶∏‡¶ø‡¶ï ‡¶§‡¶•‡ßç‡¶Ø" ‡¶∏‡ßá‡¶ï‡¶∂‡¶® ‡¶•‡ßá‡¶ï‡ßá ‡¶¨‡¶æ‡¶ï‡¶ø ‡¶ï‡ßã‡¶° ‡¶è‡¶ï‡¶á ‡¶•‡¶æ‡¶ï‡¶¨‡ßá ...

    // --- ‡ß®. ‡¶õ‡¶¨‡¶ø ‡¶è‡¶¨‡¶Ç ‡¶¨‡ßá‡¶∏‡¶ø‡¶ï ‡¶§‡¶•‡ßç‡¶Ø ---
    if (student.photo) {
        const photoSize = 35;
        const photoX = pageWidth - leftMargin - photoSize;
        const photoY = y;
        doc.addImage(student.photo, 'JPEG', photoX, photoY, photoSize, photoSize);
        doc.setDrawColor(0, 0, 0); 
        doc.setLineWidth(1.0);     
        doc.rect(photoX, photoY, photoSize, photoSize); 
    } else {
        doc.setDrawColor(200);
        doc.setFillColor(240);
        doc.rect(pageWidth - leftMargin - 35, y, 35, 35, 'FD');
        doc.setFontSize(8);
        doc.text("No Photo", pageWidth - leftMargin - 17.5, y + 17.5, {align:'center'});
    }

    doc.setFontSize(11);
    doc.setTextColor(0);
    const addInfo = (label, value) => {
        doc.setFont("helvetica", "bold");
        doc.text(label, leftMargin, y);
        doc.setFont("helvetica", "normal");
        doc.text(value || 'N/A', leftMargin + 35, y);
        y += lineHeight;
    };

    addInfo("Name:", student.name);
    addInfo("ID No:", student.serial_no.toString());
    addInfo("Class:", student.class);
    addInfo("Fees:", `Rs. ${student.fee_amount || DEFAULT_FEE}/-`);
    addInfo("Joined:", new Date(student.joining_date).toLocaleDateString('en-IN'));
    y += 5;

    doc.setFontSize(12);
    doc.setFont("helvetica", "bold");
    doc.text("Contact Info", leftMargin, y);
    y += 8;
    
    doc.setFontSize(11);
    addInfo("Phone:", student.phone);
    addInfo("Guardian:", student.guardian);
    
    doc.setFont("helvetica", "bold");
    doc.text("Address:", leftMargin, y);
    doc.setFont("helvetica", "normal");
    const addrLines = doc.splitTextToSize(student.address || 'N/A', 80);
    doc.text(addrLines, leftMargin + 35, y);
    y += (addrLines.length * 6) + 10;

    // --- ‡ß©. ‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶° (Fees) ---
    doc.setDrawColor(200); doc.setLineWidth(0.2);
    doc.line(leftMargin, y, pageWidth - leftMargin, y);
    y += 10;

    doc.setFontSize(12);
    doc.setFont("helvetica", "bold");
    doc.text("Fee Payment History (Recent)", leftMargin, y);
    y += 8;

    doc.setFillColor(230);
    doc.rect(leftMargin, y, pageWidth - (leftMargin*2), 8, 'F');
    doc.setFontSize(10);
    doc.text("Month", leftMargin + 5, y + 5);
    doc.text("Amount", leftMargin + 50, y + 5);
    doc.text("Status", leftMargin + 100, y + 5);
    y += 12;

    doc.setFont("helvetica", "normal");
    let hasFees = false;
    Object.keys(fees).sort().reverse().slice(0, 12).forEach(month => { // Last 12 records
        if (wasStudentActiveDuringMonth(student, month)) {
            const rec = fees[month]?.[student.id];
            if (rec?.status === 'paid' || isMonthDue(month)) {
                hasFees = true;
                const monthName = new Date(month + '-01').toLocaleString('default', { month: 'short', year: 'numeric' });
                doc.text(monthName, leftMargin + 5, y);
                
                if (rec?.status === 'paid') {
                    doc.text(`Rs. ${rec.amount}`, leftMargin + 50, y);
                    doc.setTextColor(0, 100, 0); 
                    doc.text(`Paid (${new Date(rec.date).toLocaleDateString('en-IN')})`, leftMargin + 100, y);
                } else {
                    doc.text(`Rs. ${student.fee_amount}`, leftMargin + 50, y);
                    doc.setTextColor(200, 0, 0); 
                    doc.text("Due", leftMargin + 100, y);
                }
                doc.setTextColor(0);
                y += 7;
            }
        }
    });
    if (!hasFees) doc.text("No recent records.", leftMargin + 5, y);
    y += 10;

    // --- ‡ß™. ‡¶è‡¶ü‡ßá‡¶®‡ßç‡¶°‡ßá‡¶®‡ßç‡¶∏ ‡¶è‡¶¨‡¶Ç ‡¶®‡ßã‡¶ü (Attendance Section) --- 
    // (‡¶è‡¶á ‡¶Ö‡¶Ç‡¶∂‡¶ü‡¶ø ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶Æ‡¶ø‡¶∏‡¶ø‡¶Ç ‡¶õ‡¶ø‡¶≤, ‡¶è‡¶ñ‡¶® ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶æ ‡¶π‡¶≤‡ßã)
    
    if (y > 220) { addPageFooter(doc, currentDate); doc.addPage(); y = 20; }

    doc.setFontSize(12);
    doc.setFont("helvetica", "bold");
    doc.text("Attendance & Class Notes", leftMargin, y);
    y += 8;

    // ‡¶ü‡ßá‡¶¨‡¶ø‡¶≤ ‡¶π‡ßá‡¶°‡¶æ‡¶∞
    doc.setFillColor(230);
    doc.rect(leftMargin, y, pageWidth - (leftMargin*2), 8, 'F');
    doc.setFontSize(10);
    doc.text("Date", leftMargin + 5, y + 5);
    doc.text("Status", leftMargin + 45, y + 5);
    doc.text("Topic / Note", leftMargin + 85, y + 5);
    y += 12;

    doc.setFont("helvetica", "normal");
    let hasAttendance = false;
    
    // ‡¶è‡¶ü‡ßá‡¶®‡ßç‡¶°‡ßá‡¶®‡ßç‡¶∏ ‡¶∏‡¶∞‡ßç‡¶ü ‡¶ï‡¶∞‡¶æ (‡¶®‡¶§‡ßÅ‡¶® ‡¶•‡ßá‡¶ï‡ßá ‡¶™‡ßÅ‡¶∞‡¶®‡ßã)
    const sortedDates = Object.keys(attendance).sort().reverse();

    sortedDates.forEach(date => {
        const entry = attendance[date]?.[student.id];
        if (entry) {
            hasAttendance = true;
            const d = new Date(date);
            const dateStr = d.toLocaleDateString('en-IN');
            
            // ‡¶°‡¶æ‡¶ü‡¶æ ‡¶¨‡ßá‡¶∞ ‡¶ï‡¶∞‡¶æ
            const status = (typeof entry === 'object') ? entry.status : entry;
            const note = (typeof entry === 'object' && entry.note) ? entry.note : '';
            
            // ‡ßß. ‡¶°‡ßá‡¶ü ‡¶ï‡¶≤‡¶æ‡¶Æ
            doc.setTextColor(0);
            doc.text(dateStr, leftMargin + 5, y);

            // ‡ß®. ‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶∏ ‡¶ï‡¶≤‡¶æ‡¶Æ (‡¶∞‡¶ô‡¶ø‡¶®)
            if(status === 'present') {
                doc.setTextColor(0, 128, 0); // Green
                doc.text("Present", leftMargin + 45, y);
            } else if(status === 'absent') {
                doc.setTextColor(200, 0, 0); // Red
                doc.text("Absent", leftMargin + 45, y);
            }

            // ‡ß©. ‡¶®‡ßã‡¶ü ‡¶ï‡¶≤‡¶æ‡¶Æ (Note)
            doc.setTextColor(80); // Dark Gray
            const noteText = note ? note : '-';
            // ‡¶®‡ßã‡¶ü ‡¶¨‡ßá‡¶∂‡¶ø ‡¶¨‡ßú ‡¶π‡¶≤‡ßá ‡¶Ø‡¶æ‡¶§‡ßá ‡¶™‡¶∞‡ßá‡¶∞ ‡¶≤‡¶æ‡¶á‡¶®‡ßá ‡¶Ø‡¶æ‡ßü
            const noteLines = doc.splitTextToSize(noteText, 95); 
            doc.text(noteLines, leftMargin + 85, y);

            // ‡¶™‡¶∞‡ßá‡¶∞ ‡¶≤‡¶æ‡¶á‡¶®‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶∏‡ßç‡¶™‡ßá‡¶∏ ‡¶π‡¶ø‡¶∏‡¶æ‡¶¨ ‡¶ï‡¶∞‡¶æ
            const rowHeight = Math.max(7, noteLines.length * 5);
            y += rowHeight;

            // ‡¶™‡ßá‡¶ú ‡¶∂‡ßá‡¶∑ ‡¶π‡¶≤‡ßá ‡¶®‡¶§‡ßÅ‡¶® ‡¶™‡ßá‡¶ú
            if (y > 270) {
                addPageFooter(doc, currentDate);
                doc.addPage();
                y = 20;
            }
        }
    });

    if (!hasAttendance) {
        doc.setTextColor(0);
        doc.text("No attendance records found.", leftMargin + 5, y);
    }

    // --- ‡ß´. ‡¶´‡ßÅ‡¶ü‡¶æ‡¶∞ ‡¶è‡¶¨‡¶Ç ‡¶∏‡ßá‡¶≠ ---
    addPageFooter(doc, currentDate);
    doc.save(`${student.name}_Profile.pdf`);
}
        function calculateMonthStats(monthStr) { let income = 0; let studentCount = 0; if(fees[monthStr]) { Object.values(fees[monthStr]).forEach(record => { if(record.status === 'paid') income += record.amount; }); } students.forEach(student => { if(wasStudentActiveDuringMonth(student, monthStr)) { studentCount++; } }); return { income, studentCount }; }

        function updateYearlyChart() { 
            const year1 = document.getElementById('analyticsYear').value; const year2 = document.getElementById('compareYear').value; if(!year1) return; const labels = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"]; const inc1 = []; const stu1 = []; let sumInc1 = 0; let sumStu1 = 0; for(let i=1; i<=12; i++) { const m = `${year1}-${i.toString().padStart(2, '0')}`; const s = calculateMonthStats(m); inc1.push(s.income); stu1.push(s.studentCount); sumInc1 += s.income; sumStu1 += s.studentCount; } const avgInc1 = sumInc1 / 12; const avgStu1 = sumStu1 / 12; const statsDiv = document.getElementById('yearlyAverages'); let statsHtml = `<div><h4>Avg Income (${year1})</h4><p class="summary-collected">‚Çπ${avgInc1.toFixed(0)}</p></div><div><h4>Avg Students (${year1})</h4><p class="summary-total" style="color:var(--text-main);">${Math.round(avgStu1)}</p></div>`; const datasets = [ { label: `Income ${year1}`, data: inc1, backgroundColor: 'rgba(16, 185, 129, 0.6)', borderColor: '#10b981', borderWidth: 1, type: 'bar', yAxisID: 'y' }, { label: `Students ${year1}`, data: stu1, borderColor: '#3b82f6', borderWidth: 2, type: 'line', tension: 0.3, yAxisID: 'y1' } ]; 
            if (year2) { const inc2 = []; const stu2 = []; let sumInc2 = 0; let sumStu2 = 0; for(let i=1; i<=12; i++) { const m = `${year2}-${i.toString().padStart(2, '0')}`; const s = calculateMonthStats(m); inc2.push(s.income); stu2.push(s.studentCount); sumInc2 += s.income; sumStu2 += s.studentCount; } const avgInc2 = sumInc2 / 12; const avgStu2 = sumStu2 / 12; statsHtml += `<div><h4>Avg Income (${year2})</h4><p class="summary-collected">‚Çπ${avgInc2.toFixed(0)}</p></div><div><h4>Avg Students (${year2})</h4><p class="summary-total" style="color:var(--text-main);">${Math.round(avgStu2)}</p></div>`; datasets.push({ label: `Income ${year2}`, data: inc2, backgroundColor: 'rgba(239, 68, 68, 0.6)', borderColor: '#ef4444', borderWidth: 1, type: 'bar', yAxisID: 'y' }); datasets.push({ label: `Students ${year2}`, data: stu2, borderColor: '#f97316', borderWidth: 2, type: 'line', tension: 0.3, pointRadius: 3, yAxisID: 'y1' }); } 
            statsDiv.innerHTML = statsHtml; statsDiv.style.display = 'flex'; 
            const ctx = document.getElementById('yearlyChart').getContext('2d'); if(analyticsChartInstance) analyticsChartInstance.destroy(); analyticsChartInstance = new Chart(ctx, { type: 'bar', data: { labels: labels, datasets: datasets }, options: { responsive: true, maintainAspectRatio: false, interaction: { mode: 'index', intersect: false }, plugins: { legend: { position: 'bottom', labels: { color: getComputedStyle(document.body).getPropertyValue('--text-main') } }, title: { display: true, text: year2 ? `${year1} vs ${year2}` : `Overview ${year1}`, color: getComputedStyle(document.body).getPropertyValue('--text-main') } }, scales: { y: { beginAtZero: true, position: 'left', title: {display:true, text:'Income (‚Çπ)', color: getComputedStyle(document.body).getPropertyValue('--text-muted')}, ticks: { color: getComputedStyle(document.body).getPropertyValue('--text-muted') } }, y1: { beginAtZero: true, position: 'right', grid: {drawOnChartArea: false}, title: {display:true, text:'Students', color: getComputedStyle(document.body).getPropertyValue('--text-muted')}, ticks: { color: getComputedStyle(document.body).getPropertyValue('--text-muted') } }, x: { ticks: { color: getComputedStyle(document.body).getPropertyValue('--text-muted') } } } } }); 
        }

        function comparePeriods() { const m1 = document.getElementById('compMonth1').value; const m2 = document.getElementById('compMonth2').value; if(!m1 || !m2) { return; } const s1 = calculateMonthStats(m1); const s2 = calculateMonthStats(m2); document.getElementById('compIncome1').textContent = `‚Çπ${s1.income}`; document.getElementById('compIncome2').textContent = `‚Çπ${s2.income}`; document.getElementById('compStudent1').textContent = s1.studentCount; document.getElementById('compStudent2').textContent = s2.studentCount; const incDiff = s2.income - s1.income; const stuDiff = s2.studentCount - s1.studentCount; const incDiffEl = document.getElementById('compIncomeDiff'); incDiffEl.innerHTML = incDiff > 0 ? `<i class="fas fa-arrow-up"></i> ‚Çπ${incDiff}` : (incDiff < 0 ? `<i class="fas fa-arrow-down"></i> ‚Çπ${Math.abs(incDiff)}` : '-'); incDiffEl.className = 'comp-diff ' + (incDiff >= 0 ? 'diff-up' : 'diff-down'); const stuDiffEl = document.getElementById('compStudentDiff'); stuDiffEl.innerHTML = stuDiff > 0 ? `<i class="fas fa-arrow-up"></i> ${stuDiff}` : (stuDiff < 0 ? `<i class="fas fa-arrow-down"></i> ${Math.abs(stuDiff)}` : '-'); stuDiffEl.className = 'comp-diff ' + (stuDiff >= 0 ? 'diff-up' : 'diff-down'); document.getElementById('comparisonResults').style.display = 'block'; }
        
        function exportDashboardPDF() { 
            const activeStudents = students.filter(s => s.status?.isActive); 
            const currentYear = new Date().getFullYear(); 
            const currentMonthStr = `${currentYear}-${(new Date().getMonth() + 1).toString().padStart(2, '0')}`; 
            let monthlyCollected = 0, monthlyDueAmount = 0, yearlyCollected = 0, yearlyDueAmount = 0; 
            
            students.forEach(student => { 
                for (let i = 0; i < 12; i++) { 
                    const monthStr = `${currentYear}-${(i + 1).toString().padStart(2, '0')}`; 
                    if (wasStudentActiveDuringMonth(student, monthStr)) { 
                        if (fees[monthStr]?.[student.id]?.status === 'paid') { 
                            if (monthStr === currentMonthStr) monthlyCollected += fees[monthStr][student.id].amount; 
                            yearlyCollected += fees[monthStr][student.id].amount; 
                        } else if (isMonthDue(monthStr)) { 
                            const studentFee = student.fee_amount || DEFAULT_FEE; 
                            if (monthStr === currentMonthStr) monthlyDueAmount += studentFee; 
                            yearlyDueAmount += studentFee; 
                        } 
                    } 
                } 
            }); 
            
            const classCounts = activeStudents.reduce((acc, student) => { const className = student.class || 'Unassigned'; acc[className] = (acc[className] || 0) + 1; return acc; }, {}); 
            const { jsPDF } = window.jspdf; const doc = new jsPDF(); let y = 20; doc.setFontSize(18); doc.setFont("helvetica", "bold"); doc.text(INSTITUTE_NAME, 105, y, {align: "center"}); y += 10; doc.setFontSize(14); doc.text("Complete Dashboard Report", 105, y, {align: "center"}); y += 8; doc.setFontSize(10); doc.setFont("helvetica", "normal"); doc.text(`Generated: ${new Date().toLocaleDateString('en-IN')}`, 105, y, {align: "center"}); y += 15; doc.setFontSize(12); doc.setFont("helvetica", "bold"); doc.text("Student Statistics", 15, y); y += 7; doc.setFontSize(11); doc.setFont("helvetica", "normal"); doc.text(`Total Students: ${students.length}`, 20, y); y += 6; doc.text(`Active Students: ${activeStudents.length}`, 20, y); y += 6; doc.text(`Inactive Students: ${students.length - activeStudents.length}`, 20, y); y += 12; doc.setFontSize(12); doc.setFont("helvetica", "bold"); doc.text("Financial Overview", 15, y); y += 7; doc.setFontSize(11); doc.setFont("helvetica", "normal"); doc.text(`Current Month (${formatMonthYear(currentMonthStr)}) Collected: Rs. ${monthlyCollected}`, 20, y); y += 6; doc.text(`Current Month Due: Rs. ${monthlyDueAmount}`, 20, y); y += 6; doc.text(`Yearly Collected: Rs. ${yearlyCollected}`, 20, y); y += 6; doc.text(`Yearly Due: Rs. ${yearlyDueAmount}`, 20, y); y += 12; doc.setFontSize(12); doc.setFont("helvetica", "bold"); doc.text("Class Strength", 15, y); y += 7; doc.setFontSize(11); doc.setFont("helvetica", "normal"); Object.entries(classCounts).sort().forEach(([className, count]) => { doc.text(`${className}: ${count} students`, 20, y); y += 6; }); addWatermarkAndSignatureToPdf(doc); doc.save(`Dashboard_Full_Report_${currentMonthStr}.pdf`); 
        }

        function toggleReportInputs() {
            const type = document.getElementById('reportType').value;
            if(type === 'monthly') {
                document.getElementById('reportMonth-group').style.display = 'block';
                document.getElementById('reportYear-group').style.display = 'none';
            } else {
                document.getElementById('reportMonth-group').style.display = 'none';
                document.getElementById('reportYear-group').style.display = 'block';
            }
        }

        function generateReport() { 
            const type = document.getElementById('reportType').value; 
            const summaryEl = document.getElementById('reportSummary'); 
            const tableEl = document.getElementById('reportTable'); 
            const tableHead = tableEl.querySelector('thead'); 
            const tableBody = tableEl.querySelector('tbody'); 
            const exportBtn = document.getElementById('exportReportBtn'); 
            
            tableHead.innerHTML = ''; tableBody.innerHTML = ''; 
            summaryEl.style.display = 'flex'; tableEl.style.display = 'table'; 
            exportBtn.style.display = 'inline-block'; 
            
            let totalCollected = 0, totalDue = 0; 
            
            if (type === 'monthly') { 
                const month = document.getElementById('reportMonth').value; 
                if (!month) return; 
                
                tableHead.innerHTML = `<tr><th>Student Name</th><th>Status</th><th>Amount</th><th>Action</th></tr>`; 
                const monthIsDue = isMonthDue(month); 
                
                students.forEach(student => { 
                    if (!wasStudentActiveDuringMonth(student, month)) return; 
                    
                    const feeRecord = fees[month]?.[student.id]; 
                    let status = 'Pending', amount = `‚Çπ0`, rowClass = 'pending'; 
                    
                    if (feeRecord?.status === 'paid') { 
                        status = `Paid on ${new Date(feeRecord.date).toLocaleDateString('en-IN')}`; 
                        amount = `‚Çπ${feeRecord.amount}`; 
                        rowClass = 'paid'; 
                        totalCollected += feeRecord.amount; 
                    } else if (monthIsDue) { 
                        status = 'Due'; 
                        const studentFee = student.fee_amount || DEFAULT_FEE; 
                        amount = `‚Çπ${studentFee}`; 
                        rowClass = 'unpaid'; 
                        totalDue += studentFee; 
                    } 
                    
                    tableBody.innerHTML += `<tr class="${rowClass}"><td>${getStudentHtml(student)}</td><td>${status}</td><td>${amount}</td><td class="action-buttons">${status === 'Due' ? getContactButtons(student.id, month) : ''}</td></tr>`; 
                }); 
                
                summaryEl.innerHTML = `
                    <div onclick="showFeeBreakdown('collected', '${month}')" style="cursor:pointer; border:1px solid var(--success);">
                        <h4>Total Collected <i class="fas fa-list" style="font-size:10px; margin-left:3px;"></i></h4>
                        <p class="summary-collected">‚Çπ${totalCollected}</p>
                    </div>
                    <div onclick="showFeeBreakdown('due', '${month}')" style="cursor:pointer; border:1px solid var(--danger);">
                        <h4>Total Due <i class="fas fa-list" style="font-size:10px; margin-left:3px;"></i></h4>
                        <p class="summary-due">‚Çπ${totalDue}</p>
                    </div>
                `; 
                
            } else if (type === 'yearly') { 
                const year = document.getElementById('reportYear').value; 
                if (!year) return; 
                
                tableHead.innerHTML = `<tr><th>Student</th><th>Monthly History</th><th>Summary</th></tr>`; 
                
                students.forEach(student => { 
                    let studentTotalPaid = 0; 
                    let studentTotalDue = 0;
                    let historyHtml = '';
                    let hasActivityInYear = false; 

                    for(let i=1; i<=12; i++) { 
                        const monthStr = `${year}-${i.toString().padStart(2, '0')}`; 
                        const monthName = new Date(year, i-1).toLocaleString('default', { month: 'short' });

                        if (wasStudentActiveDuringMonth(student, monthStr)) { 
                            hasActivityInYear = true; 
                            
                            if (fees[monthStr]?.[student.id]?.status === 'paid') { 
                                const amt = fees[monthStr][student.id].amount;
                                studentTotalPaid += amt; 
                                historyHtml += `<span style="font-size:11px; color:var(--success); margin-right:5px;">${monthName}: ‚Çπ${amt} <i class="fas fa-check"></i></span><br>`;
                            } else if (isMonthDue(monthStr)) { 
                                const amt = student.fee_amount || DEFAULT_FEE;
                                studentTotalDue += amt;
                                historyHtml += `<span style="font-size:11px; color:var(--danger); margin-right:5px;">${monthName}: ‚Çπ${amt} (Due)</span><br>`;
                            } else {
                                historyHtml += `<span style="font-size:11px; color:var(--text-muted); margin-right:5px;">${monthName}: -</span><br>`;
                            }
                        } 
                    } 
                    
                    if(hasActivityInYear) { 
                        totalCollected += studentTotalPaid; 
                        totalDue += studentTotalDue; 
                        
                        tableBody.innerHTML += `
                            <tr>
                                <td>${getStudentHtml(student)}</td>
                                <td style="line-height:1.4;">${historyHtml || '<span style="color:var(--text-muted);">No Activity</span>'}</td>
                                <td>
                                    <div style="font-size:12px;">
                                        <div style="color:var(--success); font-weight:bold;">Paid: ‚Çπ${studentTotalPaid}</div>
                                        <div style="color:var(--danger); font-weight:bold; margin-top:2px;">Due: ‚Çπ${studentTotalDue}</div>
                                    </div>
                                </td>
                            </tr>`; 
                    } 
                }); 
                
                summaryEl.innerHTML = `
                    <div onclick="showYearlyBreakdown('collected', '${year}')" style="cursor:pointer; border:1px solid var(--success);">
                        <h4>Total Collected <i class="fas fa-list" style="font-size:10px; margin-left:3px;"></i></h4>
                        <p class="summary-collected">‚Çπ${totalCollected}</p>
                    </div>
                    <div onclick="showYearlyBreakdown('due', '${year}')" style="cursor:pointer; border:1px solid var(--danger);">
                        <h4>Total Due <i class="fas fa-list" style="font-size:10px; margin-left:3px;"></i></h4>
                        <p class="summary-due">‚Çπ${totalDue}</p>
                    </div>
                `; 
            } 
        }

        function exportReportPDF() { 
            const type = document.getElementById('reportType').value; const { jsPDF } = window.jspdf; const doc = new jsPDF(); let y = 20; 
            doc.setFontSize(16); doc.setFont("helvetica", "bold"); doc.text(INSTITUTE_NAME, 105, y, {align: "center"}); y += 10; 
            
            if (type === 'monthly') { 
                const month = document.getElementById('reportMonth').value; if(!month) return; 
                doc.setFontSize(12); doc.text(`Monthly Report: ${formatMonthYear(month)}`, 105, y, {align: "center"}); y += 15; 
                doc.setFontSize(10); doc.setFont("helvetica", "bold"); 
                doc.text("Student Name", 15, y); doc.text("Status", 80, y); doc.text("Amount", 150, y); 
                doc.line(15, y+2, 195, y+2); y += 8; 
                const monthIsDue = isMonthDue(month); let totalCollected = 0, totalDue = 0; 
                doc.setFont("helvetica", "normal"); 
                
                students.forEach(student => { 
                    if (!wasStudentActiveDuringMonth(student, month)) return; 
                    const feeRecord = fees[month]?.[student.id]; 
                    let status = 'Pending', amount = '0'; 
                    if (feeRecord?.status === 'paid') { 
                        status = `Paid (${feeRecord.mode || 'Cash'})`; amount = `${feeRecord.amount}`; totalCollected += feeRecord.amount; 
                    } else if (monthIsDue) { 
                        status = 'Due'; const f = student.fee_amount || DEFAULT_FEE; amount = `${f}`; totalDue += f; 
                    } 
                    doc.text(student.name, 15, y); doc.text(status, 80, y); doc.text(amount, 150, y); y += 6; 
                    if(y > 280) { doc.addPage(); y = 20; } 
                }); 
                
                y += 5; doc.line(15, y, 195, y); y += 8; doc.setFont("helvetica", "bold"); 
                doc.text(`Total Collected: ${totalCollected}`, 15, y); doc.text(`Total Due: ${totalDue}`, 80, y); 
                addWatermarkAndSignatureToPdf(doc); doc.save(`Monthly_Report_${month}.pdf`); 
                
            } else if (type === 'yearly') { 
                const year = document.getElementById('reportYear').value; if(!year) return; 
                doc.setFontSize(12); doc.text(`Yearly Report: ${year}`, 105, y, {align: "center"}); y += 15; 
                doc.setFontSize(10); doc.setFont("helvetica", "bold"); 
                doc.text("Student Name", 15, y); doc.text("Total Paid", 90, y); doc.text("Total Due", 140, y); 
                doc.line(15, y+2, 195, y+2); y += 8; 
                let totalCollected = 0, totalDue = 0;
                doc.setFont("helvetica", "normal"); 
                
                students.forEach(student => { 
                    let studentTotal = 0; let studentDue = 0; let hasActivity = false; 
                    for(let i=1; i<=12; i++) { 
                        const m = `${year}-${i.toString().padStart(2, '0')}`; 
                        if (wasStudentActiveDuringMonth(student, m)) { 
                            hasActivity = true; 
                            if(fees[m]?.[student.id]?.status === 'paid') studentTotal += fees[m][student.id].amount; 
                            else if(isMonthDue(m)) studentDue += (student.fee_amount || DEFAULT_FEE);
                        } 
                    } 
                    if(hasActivity) { 
                        totalCollected += studentTotal; 
                        totalDue += studentDue;
                        doc.text(student.name, 15, y); doc.text(`${studentTotal}`, 90, y); doc.text(`${studentDue}`, 140, y); y += 6; 
                        if(y > 280) { doc.addPage(); y = 20; } 
                    } 
                }); 
                
                y += 5; doc.line(15, y, 195, y); y += 8; doc.setFont("helvetica", "bold"); 
                doc.text(`Grand Total Collected: ${totalCollected}`, 15, y); 
                doc.text(`Grand Total Due: ${totalDue}`, 90, y); 
                addWatermarkAndSignatureToPdf(doc); doc.save(`Yearly_Report_${year}.pdf`); 
            } 
        }

        function searchTable(inputId, tableId) { const input = document.getElementById(inputId), filter = input.value.toUpperCase(), table = document.getElementById(tableId), tr = table.getElementsByTagName("tr"); for (let i = 1; i < tr.length; i++) { const rowText = tr[i].textContent || tr[i].innerText; if (rowText.toUpperCase().indexOf(filter) > -1) { tr[i].style.display = ""; } else { tr[i].style.display = "none"; } } }
        
        function switchStudentView(view) {
            currentStudentView = view;
            const activeBtn = document.getElementById('btnShowActive');
            const inactiveBtn = document.getElementById('btnShowInactive');
            const activeDiv = document.getElementById('activeStudentsContainer');
            const inactiveDiv = document.getElementById('inactiveStudentsContainer');

            if (view === 'active') {
                activeBtn.style.background = 'var(--primary)';
                activeBtn.style.color = 'white';
                inactiveBtn.style.background = 'transparent';
                inactiveBtn.style.color = 'var(--text-muted)';
                activeDiv.style.display = 'block';
                inactiveDiv.style.display = 'none';
            } else {
                activeBtn.style.background = 'transparent';
                activeBtn.style.color = 'var(--text-muted)';
                inactiveBtn.style.background = 'var(--secondary)';
                inactiveBtn.style.color = 'white';
                activeDiv.style.display = 'none';
                inactiveDiv.style.display = 'block';
            }
        }

        function filterStudentLists() {
            const input = document.getElementById('searchStudents');
            const filter = input.value.toUpperCase();
            
            searchTable('searchStudents', 'activeStudentsTable');
            searchTable('searchStudents', 'inactiveStudentsTable');
            
            const activeDiv = document.getElementById('activeStudentsContainer');
            const inactiveDiv = document.getElementById('inactiveStudentsContainer');
            
            if (filter.length > 0) {
                activeDiv.style.display = 'block';
                inactiveDiv.style.display = 'block';
            } else {
                switchStudentView(currentStudentView);
            }
        }

        async function saveFee() { 
    const studentId = parseInt(document.getElementById('feeStudentId').value); 
    const month = document.getElementById('feeRecordMonth').value; 
    const amount = parseFloat(document.getElementById('feeAmount').value); 
    const date = document.getElementById('feeDate').value; 
    const mode = document.getElementById('paymentMode').value; 
    const txnId = document.getElementById('transactionId').value.trim(); 
    
    if (isNaN(amount) || amount <= 0) { Swal.fire('Error','Invalid amount.', 'error'); return; } 
    if (!date) { Swal.fire('Error','Select date.', 'error'); return; } 
    if (!fees[month]) fees[month] = {}; 
    
    let receiptNo = fees[month][studentId]?.receiptNo; 
    if (!receiptNo) { 
        receiptNo = Date.now().toString().slice(-6); 
    }
    fees[month][studentId] = { status: 'paid', amount, date, mode: mode, transactionId: txnId, receiptNo: receiptNo }; 
    await saveData(); 
    closeModal('feeModal'); 
    
    Swal.fire({ 
        title: 'Payment Recorded!', 
        html: `<p>What would you like to do?</p>
               <div style="display:flex; gap:5px; justify-content:center; flex-wrap:wrap;">
                   <button class="btn-like btn-receipt" onclick="generatePaymentReceipt(${studentId}, '${month}')">Receipt</button>
                   <button class="btn-like btn-whatsapp" onclick="sendMsg('wa', ${studentId}, '${month}', ${amount}, false)">WhatsApp</button>
                   <button class="btn-like btn-sms" onclick="sendMsg('sms', ${studentId}, '${month}', ${amount}, false)">SMS</button>
                   <button class="btn-like btn-mail" onclick="sendMsg('mail', ${studentId}, '${month}', ${amount}, false)">Email</button>
               </div>`, 
        icon: 'success', 
        showConfirmButton: true, 
        confirmButtonText: 'Close',
        confirmButtonColor: '#d33', // ‡¶≤‡¶æ‡¶≤ ‡¶∞‡¶ô‡ßá‡¶∞ ‡¶ï‡ßç‡¶≤‡ßã‡¶ú ‡¶¨‡¶æ‡¶ü‡¶®
        showCloseButton: true,
        allowOutsideClick: false // ‡¶è‡¶á ‡¶≤‡¶æ‡¶á‡¶®‡¶ü‡¶ø ‡¶¨‡¶æ‡¶á‡¶∞‡ßá ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ‡¶¨‡¶®‡ßç‡¶ß ‡¶ï‡¶∞‡¶¨‡ßá
    }); 
    
    loadAllData(); 
}
        function renderFees() { 
            const selectedMonth = document.getElementById('feeMonth').value, tableBody = document.querySelector('#feeTable tbody'); 
            tableBody.innerHTML = ''; 
            if (!selectedMonth) return; 
            
            let totalCollected = 0, totalDueAmount = 0, dueCount = 0; 
            const monthIsDue = isMonthDue(selectedMonth); 
            
            students.forEach(student => { 
                const wasActive = wasStudentActiveDuringMonth(student, selectedMonth); 
                if (!wasActive) return; 
                
                const feeRecord = fees[selectedMonth]?.[student.id];
                const isPaid = feeRecord?.status === 'paid'; 
                const hasGlobalDue = checkGlobalDues(student.id); 
                
                let rowClass = 'pending', statusText = 'Pending'; 
                
                if (isPaid) { 
                    totalCollected += feeRecord.amount; 
                    rowClass = 'paid'; 
                    statusText = `Paid (‚Çπ${feeRecord.amount})`; 
                } else if (monthIsDue) { 
                    dueCount++; 
                    totalDueAmount += student.fee_amount || DEFAULT_FEE; 
                    rowClass = 'unpaid'; 
                    statusText = 'Due'; 
                } 
                
                if (hasGlobalDue) rowClass += ' has-dues-alert'; 
                
                const row = document.createElement('tr'); 
                row.className = rowClass; 
                
                let actionButtons = isPaid ? 
                    `<button class="btn-receipt" onclick="generatePaymentReceipt(${student.id}, '${selectedMonth}')">Receipt</button> <button class="btn-warning" onclick="openFeeModal(${student.id}, '${selectedMonth}', true)">Edit</button><button class="btn-danger" onclick="unmarkFee(${student.id}, '${selectedMonth}')">Unmark</button>` 
                    : `<button class="btn-success" onclick="openFeeModal(${student.id}, '${selectedMonth}')">Record Payment</button>` + (monthIsDue ? getContactButtons(student.id, selectedMonth) : ''); 
                
                row.innerHTML = `<td>${getStudentHtml(student)}</td><td>${statusText}</td><td class="action-buttons">${actionButtons}</td>`; 
                tableBody.appendChild(row); 
            }); 
            
            document.getElementById('feeSummary').innerHTML = `<div onclick="showFeeBreakdown('collected')"><h4>Collected</h4><p class="summary-collected">‚Çπ${totalCollected}</p></div><div onclick="showFeeBreakdown('due')"><h4>Due (${dueCount} students)</h4><p class="summary-due">‚Çπ${totalDueAmount}</p></div>`; 
            searchTable('searchFees', 'feeTable'); 
        }

        async function generatePaymentReceipt(studentId, monthStr) { 
            const student = students.find(s => s.id === studentId); 
            const feeRecord = fees[monthStr]?.[studentId]; 
            if (!student || !feeRecord) return; 
            
            const { jsPDF } = window.jspdf; 
            const doc = new jsPDF({ orientation: 'portrait', unit: 'mm', format: [105, 148] }); 
            
            if (instituteLogo) { 
                doc.saveGraphicsState(); 
                doc.setGState(new doc.GState({ opacity: 0.08 })); 
                const imgDim = 80; const pageWidth = 105; const pageHeight = 148; 
                doc.addImage(instituteLogo, 'JPEG', (pageWidth - imgDim) / 2, (pageHeight - imgDim) / 2, imgDim, imgDim); 
                doc.restoreGraphicsState(); 
            } 
            
            doc.setDrawColor(0); doc.setLineWidth(0.5); doc.rect(5, 5, 95, 138); 
            let y = 15; 
            
            if (instituteLogo) { doc.addImage(instituteLogo, 'JPEG', 42.5, 8, 20, 20); y = 32; } 
            
            doc.setFontSize(13); doc.setFont("helvetica", "bold"); 
            const titleLines = doc.splitTextToSize(INSTITUTE_NAME, 90); 
            doc.text(titleLines, 52.5, y, {align: "center"}); 
            y += (titleLines.length * 5) + 2; 
            
            doc.setFontSize(11); doc.setFont("helvetica", "normal"); 
            doc.text("PAYMENT RECEIPT", 52.5, y, {align: "center"}); 
            doc.setLineWidth(0.2); doc.line(30, y+1, 75, y+1); y += 10; 
            
            const labelX = 12; const valueX = 48; const lineH = 7; 
            doc.setFontSize(10); 
            
            doc.setFont("helvetica", "normal"); doc.text(`Receipt No:`, labelX, y); 
            const rNo = feeRecord.receiptNo || "LEGACY-" + Math.floor(new Date(feeRecord.date).getTime()/10000).toString().slice(-4);
            doc.setFont("helvetica", "bold"); doc.text(`${rNo}`, valueX, y); y += lineH; 
            
            doc.setFont("helvetica", "normal"); doc.text(`Date:`, labelX, y); 
            const paymentDate = feeRecord.date ? new Date(feeRecord.date).toLocaleDateString('en-IN') : new Date().toLocaleDateString('en-IN');
            doc.setFont("helvetica", "bold"); doc.text(`${paymentDate}`, valueX, y); y += lineH; 
            
            doc.setFont("helvetica", "normal"); doc.text(`Student Name:`, labelX, y); 
            doc.setFont("helvetica", "bold"); doc.text(student.name, valueX, y); y += lineH; 
            
            doc.setFont("helvetica", "normal"); doc.text(`Class/Instrument:`, labelX, y); 
            doc.setFont("helvetica", "bold"); doc.text(student.class || 'N/A', valueX, y); y += lineH; 
            
            doc.setFont("helvetica", "normal"); doc.text(`Fees For Month:`, labelX, y); 
            doc.setFont("helvetica", "bold"); doc.text(formatMonthYear(monthStr), valueX, y); y += lineH; 
            
            doc.setFont("helvetica", "normal"); doc.text(`Payment Mode:`, labelX, y); 
            doc.setFont("helvetica", "bold"); doc.text(feeRecord.mode || 'Cash', valueX, y); y += lineH; 
            
            if (feeRecord.transactionId) { 
                doc.setFont("helvetica", "normal"); doc.text(`Transaction ID:`, labelX, y); 
                doc.setFont("helvetica", "bold"); 
                const txnLines = doc.splitTextToSize(feeRecord.transactionId, 50); 
                doc.text(txnLines, valueX, y); y += (txnLines.length * 5) + 2; 
            } else { y += 2; }
            
            y += 2; doc.setDrawColor(200); doc.setFillColor(245, 247, 250);
            doc.rect(10, y, 85, 12, 'FD'); 
            doc.setTextColor(0); doc.setFontSize(11); doc.setFont("helvetica", "normal"); 
            doc.text(`Amount Received:`, 15, y+8); 
            doc.setFontSize(14); doc.setFont("helvetica", "bold"); 
            doc.text(`Rs. ${feeRecord.amount}/-`, 90, y+8, {align: 'right'}); 
            
            let sigBaseY = 135; 
            if (authorizedSignature) { doc.addImage(authorizedSignature, 'PNG', 55, sigBaseY - 16, 35, 12); } 
            
            doc.setFontSize(9); doc.setFont("helvetica", "bold"); 
            doc.text(`Authorized Signature`, 72, sigBaseY, {align:"center"}); 
            doc.setFont("helvetica", "italic"); 
            doc.text(`(${MY_NAME})`, 72, sigBaseY + 4, {align:"center"}); 

            const fileName = `Receipt_${student.name.replace(/\s+/g, '_')}_${monthStr}.pdf`; 
            if (navigator.canShare && navigator.share) { 
                const pdfBlob = doc.output('blob'); const file = new File([pdfBlob], fileName, { type: 'application/pdf' }); 
                if (navigator.canShare({ files: [file] })) { try { await navigator.share({ files: [file], title: 'Fee Receipt', text: `Payment receipt for ${student.name}` }); } catch (err) { doc.save(fileName); } } else { doc.save(fileName); } 
            } else { doc.save(fileName); } 
        }

        async function generateIDCard() { 
            const name = document.getElementById('modalStudentName').textContent; 
            const serial = document.getElementById('modalSerialNo').textContent; 
            const student = students.find(s => s.serial_no == serial); 
            if (!student) return; 
            
            const issueDateInput = document.getElementById('idCardIssueDate').value; 
            const endDateInput = document.getElementById('idCardEndDate').value; 
            const issueDateStr = issueDateInput ? new Date(issueDateInput).toLocaleDateString('en-IN') : 'N/A'; 
            const endDateStr = endDateInput ? new Date(endDateInput).toLocaleDateString('en-IN') : null; 
            const dobStr = student.dob ? new Date(student.dob).toLocaleDateString('en-IN') : '-'; 
            
            const { jsPDF } = window.jspdf; 
            const doc = new jsPDF({ orientation: 'landscape', unit: 'mm', format: [86, 54] }); 
            
            // Blue Sidebar
            doc.setFillColor(24, 90, 157); doc.rect(0, 0, 30, 54, 'F'); 
            
            // Photo Logic with Black Border
            if (student.photo) { 
                doc.addImage(student.photo, 'JPEG', 5, 12, 20, 20); 
                // Draw Black Border around photo
                doc.setDrawColor(0, 0, 0); 
                doc.setLineWidth(0.5);
                doc.rect(5, 12, 20, 20);
            } else { 
                doc.setFillColor(200, 200, 200); doc.circle(15, 22, 10, 'F'); 
                doc.setFontSize(8); doc.text("No Photo", 15, 22, {align: 'center'}); 
            } 

            // --- STUDENT SIGNATURE CODE REMOVED FROM HERE ---
            
            if (instituteLogo) { 
                doc.saveGraphicsState(); doc.setGState(new doc.GState({ opacity: 0.1 })); 
                doc.addImage(instituteLogo, 'JPEG', 40, 9, 36, 36); doc.restoreGraphicsState(); 
            } 
            
            doc.setTextColor(0, 0, 0); doc.setFontSize(7); doc.setFont("helvetica", "bold"); 
            const headerLines = doc.splitTextToSize(INSTITUTE_NAME, 50); 
            doc.text(headerLines, 58, 5, {align: "center"}); 
            doc.setDrawColor(24, 90, 157); doc.line(35, 12, 80, 12); 
            
            let yText = 16; const labelX = 35; const valX = 48; 
            const addField = (label, val) => { doc.setFont("helvetica", "bold"); doc.text(label, labelX, yText); doc.setFont("helvetica", "normal"); doc.text(val, valX, yText); yText += 3.5; };
            addField("Name:", student.name); addField("ID No:", student.serial_no.toString()); addField("Class:", student.class || '-'); addField("Phone:", student.phone || '-');
            
            doc.setFont("helvetica", "bold"); doc.text("Addr:", labelX, yText); doc.setFont("helvetica", "normal"); 
            const addrLines = doc.splitTextToSize(student.address || '-', 35); doc.text(addrLines, valX, yText); yText += (addrLines.length * 3) + 1; 
            
            doc.setFont("helvetica", "bold"); doc.text("DOB:", labelX, yText); doc.setFont("helvetica", "normal"); doc.text(dobStr, valX, yText); yText += 3.5; 
            
            doc.setFontSize(6); doc.setFont("helvetica", "bold"); 
            let validText = `Issued: ${issueDateStr}`; if (endDateStr) validText += ` | Valid: ${endDateStr}`; doc.text(validText, 35, yText); 

            if (authorizedSignature) { doc.addImage(authorizedSignature, 'PNG', 65, 36, 18, 6); } 
            
            doc.setFontSize(6); doc.setFont("helvetica", "bold"); doc.text("Auth. Signature:", 83, 43, {align: "right"}); 
            doc.setFont("helvetica", "italic"); doc.text("Srikanta Banerjee", 83, 46, {align: "right"}); 
            
            doc.setFillColor(67, 206, 162); doc.rect(30, 49, 56, 5, 'F'); 
            doc.setTextColor(255, 255, 255); doc.setFontSize(6); doc.setFont("helvetica", "bold"); doc.text("AUTHORIZED STUDENT CARD", 58, 52.5, {align: "center"}); 

            const fileName = `ID_Card_${student.name}.pdf`; 
            if (navigator.canShare && navigator.share) { 
                const pdfBlob = doc.output('blob'); const file = new File([pdfBlob], fileName, { type: 'application/pdf' }); 
                if (navigator.canShare({ files: [file] })) { try { await navigator.share({ files: [file], title: 'Student ID Card', text: `ID Card for ${student.name}` }); } catch (err) { doc.save(fileName); } } else { doc.save(fileName); } 
            } else { doc.save(fileName); } 
        }
        // ‡¶è‡¶á ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®‡¶ü‡¶ø ‡¶¶‡¶ø‡ßü‡ßá ‡¶Ü‡¶ó‡ßá‡¶∞ renderAttendance ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®‡¶ü‡¶ø ‡¶¨‡¶¶‡¶≤‡ßá ‡¶¶‡¶ø‡¶®
function renderAttendance() { 
    const date = document.getElementById('attendanceDate').value;
    const tableBody = document.querySelector('#attendanceTable tbody'); 
    tableBody.innerHTML = ''; 
    if (!date) return; 

    // ‡¶ü‡¶æ‡¶á‡¶Æ ‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ (‡¶Ø‡¶¶‡¶ø ‡¶®‡¶æ ‡¶•‡¶æ‡¶ï‡ßá)
    const timeInput = document.getElementById('attendanceTime');
    if(!timeInput.value) {
       const now = new Date(); 
       const hours = now.getHours().toString().padStart(2, '0'); 
       const mins = now.getMinutes().toString().padStart(2, '0'); 
       timeInput.value = `${hours}:${mins}`;
    }

    students.filter(s => s.status?.isActive).forEach(student => { 
        const entry = attendance[date]?.[student.id];
        
        // ‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶∏ ‡¶è‡¶¨‡¶Ç ‡¶®‡ßã‡¶ü ‡¶¨‡ßá‡¶∞ ‡¶ï‡¶∞‡¶æ
        const status = (typeof entry === 'object' && entry !== null) ? entry.status : entry; 
        const note = (typeof entry === 'object' && entry?.note) ? entry.note : '';
        
        const statusText = status === 'present' ? 'Present' : (status === 'absent' ? 'Absent' : 'Not Marked');
        const statusClass = status === 'present' ? 'status-present' : (status === 'absent' ? 'status-absent' : ''); 
        
        // ‡¶®‡ßã‡¶ü ‡¶•‡¶æ‡¶ï‡¶≤‡ßá ‡¶¨‡¶æ‡¶ü‡¶®‡ßá‡¶∞ ‡¶∞‡¶ô ‡¶π‡¶≤‡ßÅ‡¶¶ ‡¶π‡¶¨‡ßá
        const noteBtnColor = note ? 'btn-warning' : 'btn-secondary';
       const noteIcon = 'fas fa-pencil-alt';

        const row = document.createElement('tr');
        
        // ‡¶®‡ßã‡¶ü ‡¶•‡¶æ‡¶ï‡¶≤‡ßá ‡¶®‡¶æ‡¶Æ‡ßá‡¶∞ ‡¶®‡¶ø‡¶ö‡ßá ‡¶¶‡ßá‡¶ñ‡¶æ‡¶¨‡ßá
        const noteDisplay = note ? `<div style="font-size:11px; color:#d97706; margin-top:2px; margin-left:55px;">üìù ${note}</div>` : '';

// renderAttendance function er vitore row.innerHTML er ongsho ti erokom hobe:

row.innerHTML = `
    <td>
        ${getStudentHtml(student)}
        <div style="font-size:11px; color:#d97706; margin-top:2px; margin-left:55px;">
            ${note ? 'üìù ' + note : ''}
        </div>
    </td>
    <td class="${statusClass}">${statusText}</td>
    <td class="action-buttons">
        <button class="btn-success" onclick="markAttendance(${student.id}, 'present')">P</button>
        
        <button class="btn-danger" onclick="markAttendance(${student.id}, 'absent')">A</button>
        
        <button class="${noteBtnColor}" onclick="addAttendanceNote(${student.id})" title="Edit Note">
            <i class="${noteIcon}"></i>
        </button>

        <button class="btn-secondary" onclick="markAttendance(${student.id}, 'clear')">X</button>
    </td>`;
        tableBody.appendChild(row);
    }); 
    searchTable('searchAttendance', 'attendanceTable'); 
}

        function loadStudentsList() { 
            const activeList = document.getElementById('activeStudentsList');
            const inactiveList = document.getElementById('inactiveStudentsList');
            activeList.innerHTML = ''; inactiveList.innerHTML = '';
            
            students.forEach(student => { 
                const statusBtnText = student.status?.isActive ? 'Deactivate' : 'Activate'; 
                const hasGlobalDue = checkGlobalDues(student.id); 
                
                let rowClass = '';
                if (!student.status?.isActive) rowClass = 'inactive-student';
                if (student.status?.isActive && hasGlobalDue) rowClass += ' has-dues-alert'; 
                
                let timeDisplay = ''; 
                if(student.class_time) { 
                    const [h, m] = student.class_time.split(':'); const ampm = h >= 12 ? 'PM' : 'AM'; const h12 = h % 12 || 12; timeDisplay = `${h12}:${m} ${ampm}`; 
                } 
                const dayTimeStr = (student.class_day || student.class_time) ? `<br><span class="student-time-sub">${student.class_day || ''} ${timeDisplay}</span>` : ''; 
                
                const row = document.createElement('tr');
                if (rowClass) row.className = rowClass;
                
                row.innerHTML = `
                    <td>${student.serial_no}</td>
                    <td>${getStudentHtml(student)}</td>
                    <td>${student.class || 'N/A'}${dayTimeStr}</td>
                    <td>‚Çπ${student.fee_amount || DEFAULT_FEE}</td>
                    <td style="min-width: 160px;">${getAllContactButtons(student)}</td>
                    <td>${student.status?.isActive ? 'Active' : 'Inactive'}</td>
                    <td class="action-buttons">
                        <button class="${student.status?.isActive ? 'btn-info' : 'btn-success'}" onclick="openStatusChangeModal(${student.id}, ${!student.status?.isActive})">${statusBtnText}</button> 
                        <button class="btn-warning" onclick="openEditStudentModal(${student.id})">Edit</button>
                    </td>`;
                
                if(student.status?.isActive) { activeList.appendChild(row); } else { inactiveList.appendChild(row); }
            }); 
        }

        // ‡¶è‡¶á ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®‡¶ü‡¶ø ‡¶¶‡¶ø‡ßü‡ßá ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶™‡ßÅ‡¶∞‡¶®‡ßã markAttendance ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®‡¶ü‡¶ø ‡¶∞‡¶ø‡¶™‡ßç‡¶≤‡ßá‡¶∏ ‡¶ï‡¶∞‡ßÅ‡¶®
function markAttendance(studentId, status) {
    const date = document.getElementById('attendanceDate').value; 
    if (!date) { Swal.fire('Alert','Please select a date.', 'warning'); return; } 
    
    if (!attendance[date]) attendance[date] = {}; 
    
    // ‡ßß. ‡¶Ü‡¶ó‡ßá ‡¶•‡ßá‡¶ï‡ßá ‡¶ï‡ßã‡¶®‡ßã ‡¶®‡ßã‡¶ü ‡¶¨‡¶æ ‡¶°‡ßá‡¶ü‡¶æ ‡¶Ü‡¶õ‡ßá ‡¶ï‡¶ø‡¶®‡¶æ ‡¶§‡¶æ ‡¶¶‡ßá‡¶ñ‡¶æ
    const currentEntry = attendance[date][studentId];
    
    // ‡¶Ø‡¶¶‡¶ø ‡¶Ü‡¶ó‡ßá‡¶∞ ‡¶°‡ßá‡¶ü‡¶æ ‡¶Ö‡¶¨‡¶ú‡ßá‡¶ï‡ßç‡¶ü ‡¶π‡ßü ‡¶§‡¶¨‡ßá ‡¶®‡ßã‡¶ü ‡¶®‡ßá‡¶¨, ‡¶∏‡ßç‡¶ü‡ßç‡¶∞‡¶ø‡¶Ç ‡¶π‡¶≤‡ßá (‡¶™‡ßÅ‡¶∞‡¶®‡ßã ‡¶≠‡¶æ‡¶∞‡ßç‡¶∏‡¶®) ‡¶®‡ßã‡¶ü ‡¶®‡ßá‡¶á
    let existingNote = '';
    if (typeof currentEntry === 'object' && currentEntry !== null && currentEntry.note) {
        existingNote = currentEntry.note;
    }

    if (status === 'clear') { 
        // ‡ß®. ‡¶Ø‡¶¶‡¶ø ‡¶®‡ßã‡¶ü ‡¶•‡¶æ‡¶ï‡ßá, ‡¶§‡¶¨‡ßá ‡¶Ö‡¶¨‡¶ú‡ßá‡¶ï‡ßç‡¶ü ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶ï‡¶∞‡¶¨‡ßã ‡¶®‡¶æ, ‡¶∂‡ßÅ‡¶ß‡ßÅ ‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶∏ ‡¶®‡¶æ‡¶≤ (null) ‡¶ï‡¶∞‡¶¨‡ßã
        if (existingNote) {
            attendance[date][studentId] = { 
                status: null,  // ‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶∏ ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶æ ‡¶π‡¶≤‡ßã
                time: '', 
                note: existingNote // ‡¶®‡ßã‡¶ü‡¶ü‡¶ø ‡¶∞‡ßá‡¶ñ‡ßá ‡¶¶‡ßá‡¶ì‡ßü‡¶æ ‡¶π‡¶≤‡ßã
            };
        } else {
            // ‡¶®‡ßã‡¶ü ‡¶®‡¶æ ‡¶•‡¶æ‡¶ï‡¶≤‡ßá ‡¶™‡ßÅ‡¶∞‡ßã‡¶ü‡¶æ ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü
            delete attendance[date][studentId]; 
        }
    } else {
        // ‡ß©. P ‡¶¨‡¶æ A ‡¶ö‡¶æ‡¶™‡¶≤‡ßá ‡¶®‡¶§‡ßÅ‡¶® ‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶∏‡ßá‡¶∞ ‡¶∏‡¶æ‡¶•‡ßá ‡¶™‡ßÅ‡¶∞‡¶®‡ßã ‡¶®‡ßã‡¶ü‡¶ü‡¶ø ‡¶Ü‡¶¨‡¶æ‡¶∞ ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶¨‡ßá
        const timeInput = document.getElementById('attendanceTime').value; 
        let timeToSave = timeInput;
        if (!timeToSave) { 
            const now = new Date(); 
            const hours = now.getHours().toString().padStart(2, '0'); 
            const mins = now.getMinutes().toString().padStart(2, '0'); 
            timeToSave = `${hours}:${mins}`; 
        }
        
        attendance[date][studentId] = { 
            status: status, 
            time: timeToSave,
            note: existingNote // ‡¶™‡ßÅ‡¶∞‡¶®‡ßã ‡¶®‡ßã‡¶ü‡¶ü‡¶ø ‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶Ü‡¶¨‡¶æ‡¶∞ ‡¶¨‡¶∏‡¶ø‡ßü‡ßá ‡¶¶‡ßá‡¶ì‡ßü‡¶æ ‡¶π‡¶≤‡ßã
        }; 
    }
    
    saveData().then(() => renderAttendance()); 
}
        // ‡¶®‡ßã‡¶ü ‡¶≤‡ßá‡¶ñ‡¶æ‡¶∞ ‡¶™‡¶™-‡¶Ü‡¶™ ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®
async function addAttendanceNote(studentId) {
    const date = document.getElementById('attendanceDate').value;
    if (!date) { Swal.fire('Alert', 'Please select a date first.', 'warning'); return; }
    
    const currentEntry = attendance[date]?.[studentId] || {};
    const existingNote = currentEntry.note || '';

    const { value: text } = await Swal.fire({
        title: 'Class Progress Note',
        input: 'textarea',
        inputLabel: '‡¶Ü‡¶ú ‡¶ï‡ßç‡¶≤‡¶æ‡¶∏‡ßá ‡¶ï‡¶ø ‡¶∂‡ßá‡¶ñ‡¶æ‡¶®‡ßã ‡¶π‡¶≤‡ßã?',
        inputValue: existingNote,
        placeholder: '‡¶Ø‡ßá‡¶Æ‡¶®: C Major Scale ‡¶∂‡ßá‡¶ñ‡¶æ‡¶®‡ßã ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá...',
        showCancelButton: true,
        confirmButtonText: 'Save Note',
        confirmButtonColor: 'var(--primary)',
        allowOutsideClick: false // ‡¶è‡¶á ‡¶≤‡¶æ‡¶á‡¶®‡¶ü‡¶ø ‡¶¨‡¶æ‡¶á‡¶∞‡ßá ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ‡¶¨‡¶®‡ßç‡¶ß ‡¶ï‡¶∞‡¶¨‡ßá
    });

    if (text !== undefined) {
        if (!attendance[date]) attendance[date] = {};
        
        attendance[date][studentId] = {
            ...currentEntry, 
            note: text
        };
        
        await saveData();
        renderAttendance();

        if (text.trim() !== "") {
            const student = students.find(s => s.id === studentId);
            const safeNote = text.replace(/'/g, "\\'").replace(/"/g, '&quot;');
            
            Swal.fire({
                title: 'Note Saved!',
                html: `
                    <p style="font-size:14px; color:#666;">Do you want to send this note to <b>${student.name}</b>?</p>
                    <div style="display:flex; gap:10px; justify-content:center; margin-top:15px;">
                        <button class="btn-whatsapp" onclick="sendNoteAction('wa', ${studentId}, '${safeNote}', '${date}')" style="padding:10px 20px !important; font-size:14px;">
                            <i class="fab fa-whatsapp"></i> WhatsApp
                        </button>
                        <button class="btn-sms" onclick="sendNoteAction('sms', ${studentId}, '${safeNote}', '${date}')" style="padding:10px 20px !important; font-size:14px;">
                            <i class="fas fa-sms"></i> SMS
                        </button>
                    </div>
                `,
                icon: 'success',
                showCloseButton: false, 
                showConfirmButton: true,
                confirmButtonText: 'Close',
                confirmButtonColor: '#d33',
                allowOutsideClick: false // ‡¶è‡¶á ‡¶≤‡¶æ‡¶á‡¶®‡¶ü‡¶ø ‡¶¨‡¶æ‡¶á‡¶∞‡ßá ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ‡¶¨‡¶®‡ßç‡¶ß ‡¶ï‡¶∞‡¶¨‡ßá
            });
        } else {
            const Toast = Swal.mixin({ toast: true, position: 'top-end', showConfirmButton: false, timer: 2000 });
            Toast.fire({ icon: 'success', title: 'Note cleared' });
        }
    }
}
        function unmarkFee(studentId, month) { 
    Swal.fire({ 
        title: 'Unmark Payment?', 
        text: "Mark fee as unpaid?", 
        icon: 'warning', 
        showCancelButton: true, 
        confirmButtonText: 'Yes',
        cancelButtonColor: '#d33',
        allowOutsideClick: false // ‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶®‡¶ø‡¶Ç ‡¶™‡¶™-‡¶Ü‡¶™ ‡¶¨‡¶æ‡¶á‡¶∞‡ßá ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ‡¶ï‡¶∞‡¶≤‡ßá ‡¶¨‡¶®‡ßç‡¶ß ‡¶π‡¶¨‡ßá ‡¶®‡¶æ
    }).then(async (result) => { 
        if (result.isConfirmed && fees[month]?.[studentId]) { 
            delete fees[month][studentId]; 
            await saveData(); 
            loadAllData(); 
            Swal.fire({
                title: 'Success', 
                text: 'Payment removed.', 
                icon: 'success',
                confirmButtonColor: '#3085d6',
                allowOutsideClick: false // ‡¶∏‡¶æ‡¶ï‡¶∏‡ßá‡¶∏ ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú ‡¶¨‡¶æ‡¶á‡¶∞‡ßá ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ‡¶ï‡¶∞‡¶≤‡ßá ‡¶¨‡¶®‡ßç‡¶ß ‡¶π‡¶¨‡ßá ‡¶®‡¶æ
            }); 
        } 
    }); 
}
        
        function openFeeModal(studentId, month, isEdit = false) { 
            const modal = document.getElementById('feeModal'), amountInput = document.getElementById('feeAmount'), dateInput = document.getElementById('feeDate'); 
            document.getElementById('feeStudentId').value = studentId; document.getElementById('feeRecordMonth').value = month; 
            const txnInput = document.getElementById('transactionId'); 
            if (isEdit) { 
                const record = fees[month][studentId]; document.getElementById('feeModalTitle').textContent = 'Edit Fee Payment'; amountInput.value = record.amount; txnInput.value = record.transactionId || ''; 
            } else { 
                const student = students.find(s => s.id === studentId); document.getElementById('feeModalTitle').textContent = 'Record Fee Payment'; amountInput.value = student.fee_amount || DEFAULT_FEE; txnInput.value = ''; 
            } 
            dateInput.valueAsDate = new Date(); modal.style.display = 'flex'; 
        }
        
        function openEditStudentModal(id) { 
    const student = students.find(s => s.id === id); 
    if(!student) return; 

    // --- ‡¶è‡¶á ‡¶≤‡¶æ‡¶á‡¶®‡¶ü‡¶ø ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶® ---
    isPhotoDeletedInEdit = false; // ‡¶Æ‡¶°‡¶æ‡¶≤ ‡¶ñ‡ßã‡¶≤‡¶æ‡¶∞ ‡¶∏‡¶Æ‡ßü ‡¶∞‡¶ø‡¶∏‡ßá‡¶ü
    // -------------------------

    document.getElementById('editStudentId').value = student.id; 
    document.getElementById('editStudentName').value = student.name; 
    // ... ‡¶¨‡¶æ‡¶ï‡¶ø ‡¶ï‡ßã‡¶° ‡¶Ü‡¶ó‡ßá‡¶∞ ‡¶Æ‡¶§‡ßã‡¶á ‡¶•‡¶æ‡¶ï‡¶¨‡ßá ...
    document.getElementById('editStudentDOB').value = student.dob || ""; 
    
    currentEditPhotoBase64 = null; 
    
    // ‡¶õ‡¶¨‡¶ø ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶≤‡¶ú‡¶ø‡¶ï
    if(student.photo) { 
        document.getElementById('editPhotoPreview').src = student.photo; 
    } else { 
        document.getElementById('editPhotoPreview').src = 'https://via.placeholder.com/100?text=No+Photo'; 
    } 
    
    document.getElementById('editStudentModal').style.display = 'flex'; 
}
       async function saveStudentChanges() { 
    const id = parseInt(document.getElementById('editStudentId').value);
    // ‡¶á‡¶®‡¶°‡ßá‡¶ï‡ßç‡¶∏ ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßá ‡¶¨‡ßá‡¶∞ ‡¶ï‡¶∞‡¶æ
    const studentIndex = students.findIndex(s => s.id === id); 
    const student = students[studentIndex];
    
    if(!student) return; 
    
    // ‡¶°‡¶æ‡¶ü‡¶æ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ
    student.name = document.getElementById('editStudentName').value.trim(); 
    if(!student.name) { Swal.fire('Error','Name required.', 'error'); return; } 

    student.class = document.getElementById('editStudentClass').value;
    student.class_day = document.getElementById('editStudentDay').value;
    student.class_time = document.getElementById('editStudentTime').value;
    student.fee_amount = parseFloat(document.getElementById('editStudentFee').value);
    student.phone = document.getElementById('editPhone').value;
    student.guardian = document.getElementById('editGuardianName').value;
    student.email = document.getElementById('editStudentEmail').value;
    student.address = document.getElementById('editAddress').value;
    student.dob = document.getElementById('editStudentDOB').value;
    
    // ‡¶õ‡¶¨‡¶ø ‡¶≤‡¶ú‡¶ø‡¶ï
    if(currentEditPhotoBase64) { 
        student.photo = currentEditPhotoBase64; 
    } else if (isPhotoDeletedInEdit) {
        student.photo = null;
    }
    
    // ‡¶∏‡¶ø‡¶ó‡¶®‡ßá‡¶ö‡¶æ‡¶∞ ‡¶≤‡¶ú‡¶ø‡¶ï
    if(currentStudentSignature) {
        student.student_signature = currentStudentSignature;
    }

    // ‡ßß. ‡¶≤‡ßã‡¶ï‡¶æ‡¶≤ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü
    students[studentIndex] = student;

    // ‡ß®. ‡¶°‡¶æ‡¶ü‡¶æ‡¶¨‡ßá‡¶∏ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü (Specific Document)
    await db.collection(COLLECTION_NAME).doc(DOC_ID).collection('students').doc(String(id)).set(student);
    
    closeModal('editStudentModal'); 
    loadAllData(); 
    Swal.fire('Saved', 'Details updated successfully.', 'success'); 
}
function showStudentDetails(studentId) { 
    const student = students.find(s => s.id === studentId); 
    if (!student) return; 
    currentlyViewingStudentId = studentId;

    document.getElementById('modalStudentName').textContent = student.name; 
    document.getElementById('modalSerialNo').textContent = student.serial_no; 
    document.getElementById('modalClass').textContent = student.class || 'N/A'; 
    document.getElementById('modalDayTime').textContent = (student.class_day || '') + " " + (student.class_time || ''); 
    document.getElementById('modalFeeAmount').textContent = `‚Çπ${student.fee_amount || DEFAULT_FEE}`; 
    document.getElementById('modalGuardianName').textContent = student.guardian || 'N/A'; 
    document.getElementById('modalPhone').innerHTML = student.phone ? `${student.phone}` : 'N/A'; 
    document.getElementById('modalEmail').innerHTML = student.email ? `${student.email}` : 'N/A'; 
    document.getElementById('modalAddress').textContent = student.address || 'N/A'; 
    document.getElementById('modalDOB').textContent = student.dob ? new Date(student.dob).toLocaleDateString('en-IN') : 'N/A'; 
    document.getElementById('modalJoiningDate').textContent = new Date(student.joining_date).toLocaleDateString('en-IN'); 
    
    const modalImg = document.getElementById('modalStudentPhoto'); 
    if(student.photo) { modalImg.src = student.photo; modalImg.style.display = 'inline-block'; } 
    else { modalImg.src = 'https://via.placeholder.com/100?text=No+Photo'; } 

    // --- NEW SIGNATURE BUTTON LOGIC START ---
    // ‡¶Ü‡¶ó‡ßá‡¶∞ ‡¶ï‡ßã‡¶°‡ßá ‡¶á‡¶Æ‡ßá‡¶ú ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡ßá‡¶®‡ßç‡¶° ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶Ö‡¶Ç‡¶∂‡¶ü‡¶ø ‡¶¨‡¶æ‡¶¶ ‡¶¶‡ßá‡¶ì‡ßü‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá
    // ‡¶è‡¶ñ‡¶® ‡¶¨‡¶æ‡¶ü‡¶® ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï‡ßá‡¶∞ ‡¶≤‡¶ú‡¶ø‡¶ï ‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá
    // ‚úÖ NEW: ‡¶¨‡¶æ‡¶ü‡¶® ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï‡ßá‡¶∞ ‡¶≤‡¶ú‡¶ø‡¶ï (‡¶™‡¶™-‡¶Ü‡¶™ ‡¶â‡¶™‡¶∞‡ßá ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®‡ßã‡¶∞ ‡¶´‡¶ø‡¶ï‡ßç‡¶∏ ‡¶∏‡¶π)
    const viewSigBtn = document.getElementById('btnViewSignature');
    if (viewSigBtn) {
        viewSigBtn.onclick = function() {
            if (student.student_signature) {
                // ‡¶∏‡¶ø‡¶ó‡¶®‡ßá‡¶ö‡¶æ‡¶∞ ‡¶•‡¶æ‡¶ï‡¶≤‡ßá
                Swal.fire({
                    title: 'Digital Signature',
                    text: student.name,
                    imageUrl: student.student_signature,
                    imageWidth: 300,
                    imageAlt: 'Signature',
                    confirmButtonText: 'Close',
                    background: '#fff',
                    // üëá ‡¶™‡¶™-‡¶Ü‡¶™ ‡¶∏‡¶¨‡¶æ‡¶∞ ‡¶â‡¶™‡¶∞‡ßá ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®‡ßã‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶è‡¶á ‡¶¶‡ßÅ‡¶ü‡¶ø ‡¶≤‡¶æ‡¶á‡¶®
                    position: 'center',
                    target: 'body'
                });
            } else {
                // ‡¶∏‡¶ø‡¶ó‡¶®‡ßá‡¶ö‡¶æ‡¶∞ ‡¶®‡¶æ ‡¶•‡¶æ‡¶ï‡¶≤‡ßá
                Swal.fire({
                    title: 'No Signature Found',
                    text: 'This student has not added a digital signature yet.',
                    icon: 'warning',
                    confirmButtonText: 'Okay',
                    // üëá ‡¶™‡¶™-‡¶Ü‡¶™ ‡¶∏‡¶¨‡¶æ‡¶∞ ‡¶â‡¶™‡¶∞‡ßá ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®‡ßã‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶è‡¶á ‡¶¶‡ßÅ‡¶ü‡¶ø ‡¶≤‡¶æ‡¶á‡¶®
                    position: 'center',
                    target: 'body'
                });
            }
        };
    }
    // --- NEW SIGNATURE BUTTON LOGIC END ---
    
    const historyList = document.getElementById('modalStatusHistory'); historyList.innerHTML = ''; 
    if (student.status.history && student.status.history.length > 0) { 
        student.status.history.forEach(entry => { const color = entry.status === 'Active' ? 'green' : 'red'; historyList.innerHTML += `<li><strong style="color:${color};">${entry.status}</strong> on ${new Date(entry.date).toLocaleDateString('en-IN')}<br><em style="font-size:0.9em;color:var(--text-muted);">Note: ${entry.note || 'No note'}</em></li>`; }); 
    } else { historyList.innerHTML = '<li>No history found.</li>'; } 
    
    const yearSelect = document.getElementById('detailsFilterYear'); const monthSelect = document.getElementById('detailsFilterMonth'); yearSelect.innerHTML = ''; monthSelect.innerHTML = '';
    const currentYear = new Date().getFullYear(); const joinYear = new Date(student.joining_date).getFullYear();
    for(let y = currentYear; y >= joinYear; y--) { const opt = document.createElement('option'); opt.value = y; opt.text = y; yearSelect.appendChild(opt); }
    const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
    monthNames.forEach((m, idx) => { const opt = document.createElement('option'); opt.value = idx + 1; opt.text = m; if(idx === new Date().getMonth()) opt.selected = true; monthSelect.appendChild(opt); });
    renderStudentDetailsHistory();
    document.getElementById('exportPdfBtn').onclick = () => exportStudentDetailsAsPDF(studentId); 
    renderStudentNotes(studentId);
    document.getElementById('studentDetailsModal').style.display = 'flex'; 
}
        function renderStudentDetailsHistory() {
    if(!currentlyViewingStudentId) return;
    const student = students.find(s => s.id === currentlyViewingStudentId); if(!student) return;
    
    const selectedYear = parseInt(document.getElementById('detailsFilterYear').value);
    const selectedMonth = parseInt(document.getElementById('detailsFilterMonth').value);
    
    // --- ATTENDANCE SECTION ---
    const presentList = document.getElementById('modalPresentList'), absentList = document.getElementById('modalAbsentList'); 
    presentList.innerHTML = absentList.innerHTML = ''; 
    
    Object.keys(attendance).sort().reverse().forEach(date => { 
        const d = new Date(date);
        if(d.getFullYear() === selectedYear && (d.getMonth() + 1) === selectedMonth) {
            const entry = attendance[date]?.[student.id];
            if(entry) {
                const dayName = d.toLocaleDateString('en-IN', { weekday: 'long' });
                let timeStr = ''; let status = entry;
                if(typeof entry === 'object' && entry !== null) {
                    status = entry.status;
                    if(entry.time) { const [h, m] = entry.time.split(':'); const ampm = h >= 12 ? 'PM' : 'AM'; const h12 = h % 12 || 12; timeStr = ` (${h12}:${m} ${ampm})`; }
                }
                const formattedDate = `${d.toLocaleDateString('en-IN')} (${dayName})${timeStr}`;
                if (status === 'present') { presentList.innerHTML += `<li style="padding:2px 0; border-bottom:1px solid #f9f9f9;">${formattedDate}</li>`; } 
                else if (status === 'absent') { absentList.innerHTML += `<li style="padding:2px 0; border-bottom:1px solid #f9f9f9;">${formattedDate}</li>`; }
            }
        }
    }); 
    
    if(!presentList.innerHTML) presentList.innerHTML = '<li>No records found</li>'; 
    if(!absentList.innerHTML) absentList.innerHTML = '<li>No records found</li>'; 
    
    // --- FEES SECTION (Updated for Transaction ID) ---
    const paidList = document.getElementById('modalPaidList'); 
    paidList.innerHTML = ''; 

    for (let i = 1; i <= 12; i++) {
        const monthNum = i.toString().padStart(2, '0');
        const monthStr = `${selectedYear}-${monthNum}`;
        const monthName = new Date(selectedYear, i - 1).toLocaleString('default', { month: 'short' });
        
        let content = '';
        let style = 'padding: 8px 0; border-bottom: 1px solid #eee; font-size: 12px; display: flex; justify-content: space-between; align-items: flex-start;';

        if(wasStudentActiveDuringMonth(student, monthStr)) {
             const feeRecord = fees[monthStr]?.[student.id]; 
             
             if (feeRecord?.status === 'paid') { 
                 // Payment Mode
                 let modeInfo = feeRecord.mode ? ` <span style="color:#666; font-size:11px;">(${feeRecord.mode})</span>` : '';
                 
                 // Transaction ID display logic
                 let txnDisplay = '';
                 if(feeRecord.transactionId) {
                     txnDisplay = `<div style="font-size:10px; color:#4f46e5; margin-top:2px;">Txn: ${feeRecord.transactionId}</div>`;
                 }

                 content = `
                    <div style="flex:1;">
                        <strong>${monthName}:</strong> <span style="color:var(--success);">Paid ‚Çπ${feeRecord.amount}</span>${modeInfo}
                        ${txnDisplay}
                    </div>
                    <div style="font-size:10px; color:gray; text-align:right;">
                        ${new Date(feeRecord.date).toLocaleDateString('en-IN')}
                    </div>
                 `;
             } 
             else if (isMonthDue(monthStr)) { 
                 content = `<span><strong>${monthName}:</strong> <span style="color:var(--danger); font-weight:bold;">Due</span></span>`;
                 style += ' background-color: rgba(239, 68, 68, 0.05);'; 
             }
             else { 
                 const today = new Date();
                 const checkDate = new Date(selectedYear, i, 0);
                 if (checkDate > today) {
                     content = `<span style="color:gray;">${monthName}: Upcoming</span>`;
                 } else {
                     content = `<span>${monthName}: Pending/Not Due</span>`;
                 }
             }
        } else {
             content = `<span style="color:#ccc;">${monthName}: Inactive</span>`;
        }

        paidList.innerHTML += `<li style="${style}">${content}</li>`;
    }
}
        
        function resetApp() { 
            Swal.fire({ title: 'Are you sure?', text: "This will permanently delete ALL data!", icon: 'warning', showCancelButton: true, confirmButtonColor: '#d33', confirmButtonText: 'Yes, Reset Everything!' }).then(async (result) => { 
                if (result.isConfirmed) { await dbClear(); localStorage.clear(); Swal.fire('Deleted!', 'Application has been reset. Reloading...', 'success').then(() => { window.location.reload(); }); } 
            }) 
        }
        function closeModal(modalId) { document.getElementById(modalId).style.display = 'none'; }
        async function exportToExcel() {
    // ‡ßß. ‡¶∏‡ßç‡¶ü‡ßÅ‡¶°‡ßá‡¶®‡ßç‡¶ü ‡¶≤‡¶ø‡¶∏‡ßç‡¶ü ‡¶°‡¶æ‡¶ü‡¶æ ‡¶§‡ßà‡¶∞‡¶ø
    const studentData = students.map(s => ({
        ID: s.serial_no,
        Name: s.name,
        Class: s.class,
        Fee: s.fee_amount,
        Phone: s.phone,
        Guardian: s.guardian,
        Status: s.status?.isActive ? 'Active' : 'Inactive',
        JoiningDate: s.joining_date
    }));

    // ‡ß®. ‡¶´‡¶ø ‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶° ‡¶°‡¶æ‡¶ü‡¶æ ‡¶§‡ßà‡¶∞‡¶ø
    const feeData = [];
    Object.keys(fees).forEach(month => {
        Object.keys(fees[month]).forEach(studentId => {
            const s = students.find(st => st.id == studentId);
            if (s) {
                const rec = fees[month][studentId];
                feeData.push({
                    Month: month,
                    StudentName: s.name,
                    Amount: rec.amount,
                    Date: rec.date,
                    Mode: rec.mode,
                    TxnID: rec.transactionId || ''
                });
            }
        });
    });

    // ‡ß©. ‡¶è‡¶ü‡ßá‡¶®‡ßç‡¶°‡ßá‡¶®‡ßç‡¶∏ ‡¶ì ‡¶®‡ßã‡¶ü ‡¶°‡¶æ‡¶ü‡¶æ ‡¶§‡ßà‡¶∞‡¶ø
    const attendData = [];
    Object.keys(attendance).forEach(date => {
        Object.keys(attendance[date]).forEach(studentId => {
            const s = students.find(st => st.id == studentId);
            if (s) {
                const entry = attendance[date][studentId];
                const status = (typeof entry === 'object') ? entry.status : entry;
                const note = (typeof entry === 'object') ? entry.note : '';
                attendData.push({
                    Date: date,
                    StudentName: s.name,
                    Status: status,
                    ProgressNote: note // ‡¶ï‡ßç‡¶≤‡¶æ‡¶∏‡ßá‡¶∞ ‡¶®‡ßã‡¶ü ‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶•‡¶æ‡¶ï‡¶¨‡ßá
                });
            }
        });
    });

    // ‡ß™. ‡¶è‡¶ï‡ßç‡¶∏‡ßá‡¶≤ ‡¶´‡¶æ‡¶á‡¶≤ ‡¶ú‡ßá‡¶®‡¶æ‡¶∞‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ
    const wb = XLSX.utils.book_new();
    
    const wsStudents = XLSX.utils.json_to_sheet(studentData);
    XLSX.utils.book_append_sheet(wb, wsStudents, "Students List");

    const wsFees = XLSX.utils.json_to_sheet(feeData);
    XLSX.utils.book_append_sheet(wb, wsFees, "Fee Records");

    const wsAttend = XLSX.utils.json_to_sheet(attendData);
    XLSX.utils.book_append_sheet(wb, wsAttend, "Attendance & Notes");

    // ‡ß´. ‡¶´‡¶æ‡¶á‡¶≤ ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶Ö‡¶™‡¶∂‡¶® (File Picker / Save As)
    const fileName = `MusicClass_Data_${new Date().toISOString().split('T')[0]}.xlsx`;

    try {
        // ‡¶Ü‡¶ß‡ßÅ‡¶®‡¶ø‡¶ï ‡¶¨‡ßç‡¶∞‡¶æ‡¶â‡¶ú‡¶æ‡¶∞‡ßá ‡¶´‡ßã‡¶≤‡ßç‡¶°‡¶æ‡¶∞ ‡¶¨‡ßá‡¶õ‡ßá ‡¶®‡ßá‡¶ì‡ßü‡¶æ‡¶∞ ‡¶Ö‡¶™‡¶∂‡¶® ‡¶Ü‡¶∏‡¶¨‡ßá (Desktop & Some Mobiles)
        if (window.showSaveFilePicker) {
            const handle = await window.showSaveFilePicker({
                suggestedName: fileName,
                types: [{
                    description: 'Excel File',
                    accept: { 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet': ['.xlsx'] },
                }],
            });
            const writable = await handle.createWritable();
            const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
            await writable.write(wbout);
            await writable.close();
            Swal.fire('Success', 'Excel file exported successfully!', 'success');
        } else {
            // ‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤ ‡¶¨‡¶æ ‡¶™‡ßÅ‡¶∞‡¶®‡ßã ‡¶¨‡ßç‡¶∞‡¶æ‡¶â‡¶ú‡¶æ‡¶∞‡ßá ‡¶∏‡¶∞‡¶æ‡¶∏‡¶∞‡¶ø ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶° ‡¶π‡¶¨‡ßá
            // (‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤‡ßá ‡¶∏‡¶æ‡¶ß‡¶æ‡¶∞‡¶£‡¶§ ‡¶è‡¶ü‡¶ø Downloads ‡¶´‡ßã‡¶≤‡ßç‡¶°‡¶æ‡¶∞‡ßá ‡¶Ø‡¶æ‡ßü, ‡¶Ø‡¶¶‡¶ø ‡¶®‡¶æ ‡¶¨‡ßç‡¶∞‡¶æ‡¶â‡¶ú‡¶æ‡¶∞ ‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏‡ßá "Ask where to save files" ‡¶Ö‡¶® ‡¶•‡¶æ‡¶ï‡ßá)
            XLSX.writeFile(wb, fileName);
            Swal.fire('Success', 'File downloaded successfully to your Downloads folder.', 'success');
        }
    } catch (err) {
        // ‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶Ø‡¶¶‡¶ø ‡¶ï‡ßç‡¶Ø‡¶æ‡¶®‡¶∏‡ßá‡¶≤ ‡¶ï‡¶∞‡ßá ‡¶¶‡ßá‡ßü ‡¶¨‡¶æ ‡¶è‡¶∞‡¶∞ ‡¶π‡ßü
        if (err.name !== 'AbortError') {
            console.error(err);
            // ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ï‡¶Ü‡¶™ ‡¶π‡¶ø‡¶∏‡ßá‡¶¨‡ßá ‡¶∏‡¶∞‡¶æ‡¶∏‡¶∞‡¶ø ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶°
            XLSX.writeFile(wb, fileName);
        }
    }
}
// ‡ßß. ‡¶∏‡ßç‡¶ü‡ßÅ‡¶°‡ßá‡¶®‡ßç‡¶ü‡ßá‡¶∞ ‡¶∏‡¶¨ ‡¶®‡ßã‡¶ü ‡¶¨‡ßá‡¶∞ ‡¶ï‡¶∞‡ßá ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®‡ßã‡¶∞ ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®
function renderStudentNotes(studentId) {
    const listContainer = document.getElementById('modalNotesList');
    listContainer.innerHTML = '';
    
    let allNotes = [];
    
    Object.keys(attendance).forEach(date => {
        const entry = attendance[date][studentId];
        if (entry && typeof entry === 'object' && entry.note && entry.note.trim() !== "") {
            allNotes.push({
                date: date,
                note: entry.note,
                status: entry.status
            });
        }
    });

    allNotes.sort((a, b) => new Date(b.date) - new Date(a.date));

    if (allNotes.length === 0) {
        listContainer.innerHTML = '<li style="padding: 10px; text-align: center; color: var(--text-muted); font-size: 12px;">No notes found.</li>';
        return;
    }

    allNotes.forEach(item => {
        const d = new Date(item.date);
        const dateStr = d.toLocaleDateString('en-IN', { day: 'numeric', month: 'short', year: '2-digit' });
        
        const li = document.createElement('li');
        li.style.cssText = "padding: 8px 10px; border-bottom: 1px solid var(--border-color); font-size: 12px;";
        
        // ‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶¨‡¶ï‡ßç‡¶∏‡¶ü‡¶ø ‡¶∏‡¶∞‡¶ø‡ßü‡ßá ‡¶∂‡ßÅ‡¶ß‡ßÅ ‡¶ü‡ßá‡¶ï‡ßç‡¶∏‡¶ü ‡¶∞‡¶æ‡¶ñ‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá
        li.innerHTML = `
            <div style="display:flex; justify-content:space-between; margin-bottom:4px;">
                <span style="font-weight:bold; color:var(--primary); font-size: 13px;">${dateStr}</span>
            </div>
            <div style="color:var(--text-main); line-height:1.5;">${item.note}</div>
        `;
        listContainer.appendChild(li);
    });
}

// ‡ß®. ‡¶®‡ßã‡¶ü ‡¶∏‡¶æ‡¶∞‡ßç‡¶ö/‡¶´‡¶ø‡¶≤‡ßç‡¶ü‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®
function filterStudentNotes() {
    const input = document.getElementById('noteSearchInput');
    const filter = input.value.toUpperCase();
    const ul = document.getElementById('modalNotesList');
    const li = ul.getElementsByTagName('li');

    for (let i = 0; i < li.length; i++) {
        const textValue = li[i].textContent || li[i].innerText;
        if (textValue.toUpperCase().indexOf(filter) > -1) {
            li[i].style.display = "";
        } else {
            li[i].style.display = "none";
        }
    }
}
// ‡¶è‡¶á ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®‡¶ü‡¶ø ‡¶Æ‡¶ø‡¶∏‡¶ø‡¶Ç ‡¶õ‡¶ø‡¶≤, ‡¶§‡¶æ‡¶á ‡¶™‡¶ø‡¶°‡¶ø‡¶è‡¶´ ‡¶π‡¶ö‡ßç‡¶õ‡¶ø‡¶≤ ‡¶®‡¶æ‡•§ ‡¶è‡¶ü‡¶ø ‡¶®‡¶ø‡¶ö‡ßá ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®:
function addWatermarkAndSignatureToPdf(doc) {
    const pageCount = doc.getNumberOfPages();
    const pageWidth = doc.internal.pageSize.getWidth();
    const pageHeight = doc.internal.pageSize.getHeight();

    for (let i = 1; i <= pageCount; i++) {
        doc.setPage(i);

        // ‡ßß. ‡¶≤‡ßã‡¶ó‡ßã ‡¶ì‡ßü‡¶æ‡¶ü‡¶æ‡¶∞‡¶Æ‡¶æ‡¶∞‡ßç‡¶ï (Watermark)
        if (instituteLogo) {
            doc.saveGraphicsState();
            doc.setGState(new doc.GState({ opacity: 0.1 })); // ‡¶π‡¶æ‡¶≤‡¶ï‡¶æ ‡¶Ö‡¶™‡¶æ‡¶∏‡¶ø‡¶ü‡¶ø
            const imgDim = 80; // ‡¶≤‡ßã‡¶ó‡ßã‡¶∞ ‡¶∏‡¶æ‡¶á‡¶ú
            doc.addImage(instituteLogo, 'JPEG', (pageWidth - imgDim) / 2, (pageHeight - imgDim) / 2, imgDim, imgDim);
            doc.restoreGraphicsState();
        }

        // ‡ß®. ‡¶´‡ßÅ‡¶ü‡¶æ‡¶∞ ‡¶è‡¶¨‡¶Ç ‡¶∏‡¶ø‡¶ó‡¶®‡ßá‡¶ö‡¶æ‡¶∞ (Footer & Signature)
        const footerY = pageHeight - 20;

        // ‡¶™‡ßá‡¶ú ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞
        doc.setFontSize(8);
        doc.setTextColor(100);
        doc.setFont("helvetica", "normal");
        doc.text(`Page ${i} of ${pageCount}`, pageWidth / 2, footerY + 10, { align: 'center' });

        // ‡¶ú‡ßá‡¶®‡¶æ‡¶∞‡ßá‡¶ü‡ßá‡¶° ‡¶°‡ßá‡¶ü (‡¶¨‡¶æ‡¶Æ ‡¶¶‡¶ø‡¶ï‡ßá)
        const dateStr = new Date().toLocaleDateString('en-IN');
        doc.text(`Generated: ${dateStr}`, 15, footerY + 10);

        // ‡¶∏‡¶ø‡¶ó‡¶®‡ßá‡¶ö‡¶æ‡¶∞ (‡¶°‡¶æ‡¶® ‡¶¶‡¶ø‡¶ï‡ßá)
        if (authorizedSignature) {
            doc.addImage(authorizedSignature, 'PNG', pageWidth - 50, footerY - 10, 35, 12);
            doc.text("Authorized Signature", pageWidth - 15, footerY + 5, { align: "right" });
        }
    }
}
// ‡¶®‡ßã‡¶ü ‡¶∏‡ßá‡¶®‡ßç‡¶° ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®
function sendNoteAction(type, studentId, note, rawDate) {
    const student = students.find(s => s.id === studentId);
    if (!student) {
        Swal.fire('Error', 'Student not found!', 'error');
        return;
    }

    // ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ ‡¶´‡¶∞‡¶Æ‡ßç‡¶Ø‡¶æ‡¶ü ‡¶ï‡¶∞‡¶æ (DD/MM/YYYY)
    const dateObj = new Date(rawDate);
    const dateStr = dateObj.toLocaleDateString('en-IN');

    // ‡¶∏‡¶æ‡¶¨‡¶ú‡ßá‡¶ï‡ßç‡¶ü ‡¶¨‡¶æ ‡¶ï‡ßç‡¶≤‡¶æ‡¶∏ (‡¶Ø‡¶¶‡¶ø ‡¶®‡¶æ ‡¶•‡¶æ‡¶ï‡ßá ‡¶§‡¶¨‡ßá 'Music' ‡¶¨‡¶∏‡¶¨‡ßá)
    const subject = student.class ? student.class : 'Music';

    // ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶¶‡ßá‡¶ì‡ßü‡¶æ ‡¶®‡¶ø‡¶∞‡ßç‡¶¶‡¶ø‡¶∑‡ßç‡¶ü ‡¶´‡¶∞‡¶Æ‡ßç‡¶Ø‡¶æ‡¶ü ‡¶Ö‡¶®‡ßÅ‡¶Ø‡¶æ‡ßü‡ßÄ ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú ‡¶¨‡¶°‡¶ø
    const msgBody = `Dear ${student.name},\n\n` +
                    `Here is the note for today's ${subject} class (${dateStr}):\n\n` +
                    `"${note}"\n\n` +
                    `Regards,\n` +
                    `Srikanta Banerjee\n` +
                    `(Guitar, Bass Guitar, Piano, Keyboard, Mandolin Classes)`;
    
    // WhatsApp ‡¶¨‡¶æ SMS ‡¶™‡¶æ‡¶†‡¶æ‡¶®‡ßã
    if (type === 'wa') {
        let cleanPhone = student.phone.replace(/[^0-9]/g, '');
        // ‡¶á‡¶®‡ßç‡¶°‡¶ø‡¶Ø‡¶º‡¶æ‡¶® ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø 91 ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶æ
        if (cleanPhone.length === 10) cleanPhone = '91' + cleanPhone;
        
        window.open(`https://wa.me/${cleanPhone}?text=${encodeURIComponent(msgBody)}`, '_blank');
    } else if (type === 'sms') {
        window.open(`sms:${student.phone}?body=${encodeURIComponent(msgBody)}`, '_self');
    }
}
// ‡¶è‡¶á ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®‡¶ü‡¶ø ‡¶∏‡ßç‡¶ï‡ßç‡¶∞‡¶ø‡¶™‡ßç‡¶ü‡ßá‡¶∞ ‡¶∂‡ßá‡¶∑‡ßá ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®
function handleSignUp() {
    const email = document.getElementById('loginEmail').value;
    const password = document.getElementById('loginPassword').value;
    const errorMsg = document.getElementById('loginError');

    if (!email || !password) {
        errorMsg.textContent = "Email and password required for Sign Up!";
        errorMsg.style.display = 'block';
        return;
    }
    if (password.length < 6) {
        errorMsg.textContent = "Password must be at least 6 characters.";
        errorMsg.style.display = 'block';
        return;
    }

    const loginBtn = document.querySelector('#loginOverlay button:last-of-type');
    const originalText = loginBtn.innerHTML;
    loginBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating...';

    auth.createUserWithEmailAndPassword(email, password)
        .then((userCredential) => {
            Swal.fire('Success', 'Account Created! Logging in...', 'success');
        })
        .catch((error) => {
            console.error(error);
            errorMsg.textContent = "Error: " + error.message;
            errorMsg.style.display = 'block';
            loginBtn.innerHTML = originalText;
        });
}
        
    </script>
</body>
</html>
