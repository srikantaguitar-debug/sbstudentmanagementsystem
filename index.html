<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Music Classes - Pro Student Manager v25.4 (Txn History)</title>
    
    <link rel="manifest" href="manifest.json">
    
    <meta name="theme-color" content="#4f46e5">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Music Manager">
    <link rel="apple-touch-icon" href="icon-192.png">

    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        /* CSS SAME AS BEFORE */
        :root {
            --primary: #4f46e5; /* Indigo */
            --primary-dark: #4338ca;
            --secondary: #64748b;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --info: #3b82f6;
            --pink: #ec4899; /* For Birthday */
            --bg-body: #f3f4f6;
            --bg-card: #ffffff;
            --text-main: #1f2937;
            --text-muted: #6b7280;
            --radius: 12px;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-hover: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        body { 
            font-family: 'Poppins', sans-serif; 
            background-color: var(--bg-body); 
            color: var(--text-main); 
            margin: 0; 
            padding: 0; 
            -webkit-font-smoothing: antialiased;
        }

        /* --- CONTAINER & HEADER --- */
        .container { 
            width: 95%; 
            max-width: 1400px; 
            margin: 30px auto; 
            background-color: transparent; 
        }
        
        header { 
            background: var(--bg-card);
            color: var(--text-main); 
            padding: 20px 30px; 
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            display: flex; 
            align-items: center; 
            justify-content: center;
            position: relative;
            margin-bottom: 25px;
            border-left: 5px solid var(--primary);
        }
        
        header h1 { 
            margin: 0; 
            font-size: 22px; 
            font-weight: 600; 
            text-align: center; 
            width: 100%; 
            color: var(--primary-dark);
        }

        #headerLogo { 
            position: absolute; 
            left: 25px; 
            top: 50%; 
            transform: translateY(-50%);
            max-height: 60px; 
            max-width: 80px;
            object-fit: contain;
            display: none; 
        }

        /* --- TABS --- */
        .tab-buttons { 
            display: flex; 
            flex-wrap: wrap; 
            background-color: var(--bg-card); 
            border-radius: var(--radius); 
            padding: 8px; 
            box-shadow: var(--shadow);
            margin-bottom: 25px;
            gap: 5px;
        }
        
        .tab-button { 
            flex-grow: 1; 
            padding: 12px 20px; 
            border: none; 
            background: transparent; 
            cursor: pointer; 
            font-size: 14px; 
            font-weight: 500; 
            color: var(--text-muted); 
            border-radius: 8px;
            transition: all 0.3s ease;
            font-family: 'Poppins', sans-serif;
        }
        
        .tab-button:hover { 
            background-color: #f1f5f9; 
            color: var(--primary);
        }
        
        .tab-button.active { 
            background-color: var(--primary); 
            color: white; 
            box-shadow: 0 4px 6px rgba(79, 70, 229, 0.3);
        }
        
        .tab-content { 
            background: var(--bg-card);
            border-radius: var(--radius);
            padding: 30px; 
            box-shadow: var(--shadow);
            display: none; 
            animation: fadeIn 0.3s ease-in-out;
        }
        
        .tab-content.active { display: block; }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* --- FORMS --- */
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; }
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: 500; font-size: 14px; color: var(--text-muted); }
        
        input, select, textarea { 
            width: 100%; 
            padding: 12px 15px; 
            border: 1px solid #e2e8f0; 
            border-radius: 8px; 
            font-family: 'Poppins', sans-serif;
            font-size: 14px;
            background-color: #f9fafb;
            transition: all 0.3s;
            box-sizing: border-box;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary);
            background-color: #fff;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }

        .search-bar { position: relative; margin-bottom: 25px; }
        .search-bar input { padding-left: 40px; border-radius: 50px; }
        .search-bar::before {
            content: '\f002'; /* FontAwesome Search */
            font-family: "Font Awesome 6 Free";
            font-weight: 900;
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-muted);
        }
        
        /* --- BUTTONS --- */
        button, .btn-like { 
            padding: 10px 18px; 
            color: white; 
            border: none; 
            border-radius: 6px; 
            cursor: pointer; 
            font-size: 13px; 
            font-weight: 500;
            text-decoration: none; 
            display: inline-flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s, box-shadow 0.2s; 
            margin-right: 5px; 
            margin-bottom: 5px; 
            font-family: 'Poppins', sans-serif;
            letter-spacing: 0.3px;
        }
        
        button:hover, .btn-like:hover { transform: translateY(-1px); box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        button:active { transform: translateY(0); }

        .btn-primary { background-color: var(--primary); } 
        .btn-success { background-color: var(--success); } 
        .btn-danger { background-color: var(--danger); } 
        .btn-warning { background-color: var(--warning); color: white; } 
        .btn-secondary { background-color: var(--secondary); } 
        .btn-info { background-color: var(--info); }
        .btn-pink { background-color: var(--pink); }
        
        .btn-google { background-color: #4285F4; gap: 8px; }
        
        /* Small Action Buttons */
        .btn-whatsapp, .btn-call, .btn-sms, .btn-mail, .btn-receipt {
            font-size: 11px !important; padding: 6px 10px !important; border-radius: 4px;
        }
        .btn-whatsapp { background-color: #25D366; }
        .btn-call { background-color: #059669; }
        .btn-sms { background-color: #d97706; color: white; }
        .btn-mail { background-color: #2563eb; }
        .btn-receipt { background-color: #7c3aed; }
        
        /* --- TABLES --- */
        table { 
            width: 100%; 
            border-collapse: separate; 
            border-spacing: 0; 
            margin-top: 20px; 
            width: 100%;
        }
        
        th { 
            background-color: #f8fafc; 
            color: var(--text-muted);
            font-weight: 600;
            text-transform: uppercase;
            font-size: 12px;
            letter-spacing: 0.05em;
            padding: 15px;
            text-align: left;
            border-bottom: 2px solid #e2e8f0;
        }
        
        td { 
            padding: 15px; 
            border-bottom: 1px solid #f1f5f9; 
            vertical-align: middle; 
            font-size: 14px;
        }

        tr:last-child td { border-bottom: none; }
        tr:hover td { background-color: #f8fafc; }

        .student-name-link { color: var(--primary); font-weight: 600; text-decoration: none; }
        .student-name-link:hover { text-decoration: underline; }
        .student-phone-sub { font-size: 12px; color: var(--text-muted); margin-top: 2px; }
        .student-time-sub { font-size: 11px; color: var(--info); font-weight: 600; background: #eff6ff; padding: 2px 6px; border-radius: 4px; display: inline-block; margin-top: 4px; }

        /* Row Status Colors - MORE FADED FOR INACTIVE */
        .inactive-student { 
            opacity: 0.5 !important; 
            filter: grayscale(100%); 
            background-color: #f3f4f6 !important; 
        }
        
        /* Status Indicators on Rows */
        .paid { background-color: #ecfdf5 !important; } /* Light Green */
        .paid td:first-child { border-left: 4px solid var(--success); }
        
        .unpaid { background-color: #fef2f2 !important; } /* Light Red */
        .unpaid td:first-child { border-left: 4px solid var(--danger); }
        
        .pending { background-color: #fffbeb !important; } /* Light Yellow */
        .pending td:first-child { border-left: 4px solid var(--warning); }

        /* Attendance Status Text */
        .status-present { color: var(--success); font-weight: bold; }
        .status-absent { color: var(--danger); font-weight: bold; }
        
        .has-dues-alert { 
            background-color: #fee2e2 !important; 
            border-left: 4px solid #dc2626; 
        }
        
        /* Student Photo */
        .student-thumb { 
            width: 45px; height: 45px; 
            border-radius: 50%; 
            object-fit: cover; 
            margin-right: 15px; 
            border: 2px solid white; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.1); 
        }
        .student-cell { display: flex; align-items: center; }

        /* --- DASHBOARD --- */
        .summary-box { 
            display: flex; 
            justify-content: space-between; 
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            padding: 20px; 
            border-radius: var(--radius); 
            margin-top: 20px; 
            text-align: center; 
        }
        .summary-box > div { flex: 1; border-right: 1px solid rgba(0,0,0,0.05); }
        .summary-box > div:last-child { border-right: none; }
        .summary-box h4 { margin: 0 0 8px 0; font-size: 13px; text-transform: uppercase; color: var(--text-muted); letter-spacing: 0.5px; }
        .summary-box p { margin: 0; font-size: 24px; font-weight: 700; }
        
        /* Clickable stats */
        .clickable-stat { cursor: pointer; transition: background 0.2s; }
        .clickable-stat:hover { background-color: rgba(0,0,0,0.03); }

        .summary-collected { color: var(--success); } 
        .summary-due { color: var(--danger); } 
        .summary-total { color: var(--primary); }
        
        .dashboard-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); 
            gap: 25px; 
            margin-top: 20px;
        }
        
        .dashboard-card { 
            background: white; 
            border-radius: var(--radius); 
            padding: 25px; 
            box-shadow: var(--shadow); 
            border-top: 4px solid var(--primary); /* Accent top border */
            transition: transform 0.3s;
        }
        .dashboard-card:hover { transform: translateY(-3px); box-shadow: var(--shadow-hover); }
        .dashboard-card h3 { margin-top: 0; font-size: 18px; color: var(--text-main); margin-bottom: 20px; padding-bottom: 10px; border-bottom: 1px solid #f1f5f9; }

        /* Birthday Animation */
        .birthday-card { border-top-color: var(--pink) !important; background: linear-gradient(to bottom, #fff, #fff1f2); }
        .birthday-icon { animation: bounce 2s infinite; color: var(--pink); }
        @keyframes bounce { 0%, 20%, 50%, 80%, 100% {transform: translateY(0);} 40% {transform: translateY(-10px);} 60% {transform: translateY(-5px);} }

        .chart-container { height: 220px; position: relative; }
        
        .class-strength-list { list-style: none; padding: 0; margin: 0; }
        .class-strength-list li { 
            padding: 10px 15px; 
            border-radius: 6px; 
            margin-bottom: 5px; 
            cursor: pointer; 
            display: flex; 
            justify-content: space-between; 
            background: #f8fafc;
        }
        .class-strength-list li:hover { background-color: #e0e7ff; color: var(--primary); }

        /* --- MODALS --- */
        .modal { 
            display: none; position: fixed; z-index: 1000; 
            left: 0; top: 0; width: 100%; height: 100%; 
            overflow: auto; 
            background-color: rgba(15, 23, 42, 0.6); /* Darker blur overlay */
            backdrop-filter: blur(4px);
        }
        
        .modal-content { 
            background-color: #fff; 
            margin: 5% auto; 
            padding: 30px; 
            border: none; 
            width: 90%; max-width: 700px; 
            border-radius: 16px; 
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            position: relative; 
            animation: modalSlideIn 0.3s ease;
        }
        
        @keyframes modalSlideIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }

        .close-button { 
            color: #94a3b8; 
            float: right; 
            font-size: 28px; 
            font-weight: bold; 
            position: absolute; 
            top: 15px; right: 25px; 
            cursor: pointer; 
            transition: color 0.2s;
        }
        .close-button:hover { color: var(--danger); }
        
        .modal h2 { margin-top: 0; color: var(--primary); font-size: 22px; }

        .modal-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-top: 20px; }
        .modal-section ul { list-style-type: none; padding: 0; max-height: 200px; overflow-y: auto; border: 1px solid #f1f5f9; border-radius: 8px; }
        .modal-section ul li { padding: 10px 15px; border-bottom: 1px solid #f1f5f9; font-size: 13px; }
        .modal-section ul li:last-child { border-bottom: none; }
        
        .modal-section h4 { background: #f1f5f9; padding: 10px; margin: 0 0 10px 0; border-radius: 6px; font-size: 14px; }

        /* --- PHOTO PICKER STYLING --- */
        #photoPreviewBox {
            background-color: #f1f5f9;
            transition: border-color 0.3s, background-color 0.3s;
            position: relative;
        }
        #photoPreviewBox:hover {
            border-color: var(--primary) !important;
            background-color: #eef2ff;
        }
        #photoPreviewBox img { border-radius: 50%; }

        /* --- SECURITY PIN UI (Modern Lock Screen) --- */
        #securityOverlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, #1e1b4b 0%, #312e81 100%);
            z-index: 9999; flex-direction: column; align-items: center; justify-content: center; color: white;
        }
        .security-title { font-size: 24px; font-weight: 300; margin-bottom: 30px; letter-spacing: 2px; text-transform: uppercase; opacity: 0.9; }
        .pin-display { font-size: 16px; margin-bottom: 20px; color: #a5b4fc; font-weight: 300; }
        
        .pin-pad { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; max-width: 320px; }
        .pin-btn {
            width: 75px; height: 75px; border-radius: 50%;
            background: rgba(255, 255, 255, 0.1); 
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white; font-size: 24px; font-weight: 300;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: all 0.2s; user-select: none;
            backdrop-filter: blur(5px);
        }
        .pin-btn:hover { background: rgba(255, 255, 255, 0.25); transform: scale(1.05); }
        .pin-btn:active { transform: scale(0.95); }
        
        .pin-btn.action-btn { font-size: 20px; }
        .pin-btn.red { background-color: rgba(239, 68, 68, 0.2); border-color: #ef4444; color: #fca5a5; }
        .pin-btn.green { background-color: rgba(16, 185, 129, 0.2); border-color: #10b981; color: #6ee7b7; }
        
        .pin-dots { display: flex; gap: 15px; margin-bottom: 40px; height: 20px; }
        .pin-dot { width: 16px; height: 16px; border-radius: 50%; border: 2px solid #6366f1; background: transparent; transition: all 0.2s; }
        .pin-dot.filled { background: #818cf8; border-color: #818cf8; box-shadow: 0 0 10px #818cf8; }
        
        .close-pin { position: absolute; top: 30px; right: 30px; font-size: 36px; cursor: pointer; color: white; opacity: 0.5; transition: opacity 0.3s; }
        .close-pin:hover { opacity: 1; }

        /* --- RESPONSIVE --- */
        @media (max-width: 768px) {
            header { flex-direction: column; text-align: center; padding: 15px; }
            header h1 { margin-top: 5px; font-size: 18px; }
            #headerLogo { position: static; transform: none; margin-bottom: 10px; display: block !important; }
            
            .tab-buttons { flex-direction: column; }
            .tab-button { border-radius: 6px; text-align: left; padding: 15px; }
            
            .modal-content { width: 95%; margin: 10% auto; padding: 20px; }
            .modal-grid { grid-template-columns: 1fr; }
            
            .action-buttons { display: flex; flex-wrap: wrap; gap: 5px; }
            
            /* Make tables scrollable or card-like on tiny screens */
            table { display: block; overflow-x: auto; white-space: nowrap; }
        }
    </style>
</head>
<body>

    <div id="securityOverlay">
        <span class="close-pin" onclick="closePinScreen()">&times;</span>
        <div class="security-title"><i class="fas fa-lock"></i> Security Check</div>
        <div class="pin-display">Enter your 4-digit PIN</div>
        <div class="pin-dots" id="pinDots">
            <div class="pin-dot"></div><div class="pin-dot"></div><div class="pin-dot"></div><div class="pin-dot"></div>
        </div>
        <div class="pin-pad">
            <div class="pin-btn" onclick="pressPin('1')">1</div>
            <div class="pin-btn" onclick="pressPin('2')">2</div>
            <div class="pin-btn" onclick="pressPin('3')">3</div>
            <div class="pin-btn" onclick="pressPin('4')">4</div>
            <div class="pin-btn" onclick="pressPin('5')">5</div>
            <div class="pin-btn" onclick="pressPin('6')">6</div>
            <div class="pin-btn" onclick="pressPin('7')">7</div>
            <div class="pin-btn" onclick="pressPin('8')">8</div>
            <div class="pin-btn" onclick="pressPin('9')">9</div>
            <div class="pin-btn action-btn red" onclick="pressPin('C')"><i class="fas fa-times"></i></div>
            <div class="pin-btn" onclick="pressPin('0')">0</div>
            <div class="pin-btn action-btn green" onclick="submitPin()"><i class="fas fa-check"></i></div>
        </div>
    </div>

    <div class="container">
        <header>
            <img id="headerLogo" src="" alt="Logo">
            <h1><i class="fas fa-music"></i> Guitar, Bass Guitar, Piano, Keyboard, Mandolin Classes</h1>
        </header>
        
        <div class="tab-buttons">
            <button class="tab-button active" onclick="openTab('attendance')"><i class="fas fa-calendar-check"></i> Attendance</button>
            <button class="tab-button" onclick="openTab('fees')">Monthly Fees</button>
            <button class="tab-button" onclick="openTab('studentMgmt')"><i class="fas fa-user-graduate"></i> Students</button>
            <button class="tab-button" onclick="openTab('dashboard')"><i class="fas fa-chart-pie"></i> Dashboard</button>
            <button class="tab-button" onclick="openTab('reports')"><i class="fas fa-file-alt"></i> Reports</button>
            <button class="tab-button" onclick="openTab('settings')"><i class="fas fa-cog"></i> Settings</button>
        </div>
        
        <div id="attendance" class="tab-content active">
            <div class="form-group"><label for="attendanceDate">Date:</label><input type="date" id="attendanceDate"></div>
            <div class="search-bar"><input type="search" id="searchAttendance" onkeyup="searchTable('searchAttendance', 'attendanceTable')" placeholder="Search by Name, Phone or Day..."></div>
            <div style="overflow-x: auto;">
                <table id="attendanceTable"><thead><tr><th>Student Details</th><th>Current Status</th><th>Mark Attendance</th></tr></thead><tbody></tbody></table>
            </div>
        </div>

        <div id="fees" class="tab-content">
            <div class="form-group"><label for="feeMonth">Select Month:</label><input type="month" id="feeMonth"></div>
            <div class="search-bar"><input type="search" id="searchFees" onkeyup="searchTable('searchFees', 'feeTable')" placeholder="Search by Name, Phone or Day..."></div>
            <div id="feeSummary" class="summary-box"></div>
            <div style="overflow-x: auto;">
                <table id="feeTable"><thead><tr><th>Student Details</th><th>Payment Status</th><th>Actions</th></tr></thead><tbody></tbody></table>
            </div>
        </div>

        <div id="studentMgmt" class="tab-content">
            <div class="dashboard-card" style="margin-bottom: 30px; border-top-color: var(--success);">
                <h3><i class="fas fa-user-plus"></i> Add New Student</h3>
                <div class="form-grid">
                    <div class="form-group" style="grid-row: span 3; text-align: center;">
                        <label>Student Photo</label>
                        <input type="file" id="addStudentCamera" accept="image/*" capture="environment" onchange="handlePhotoSelection(this, 'add')" style="display:none;">
                        <input type="file" id="addStudentGallery" accept="image/*" onchange="handlePhotoSelection(this, 'add')" style="display:none;">
                        
                        <div id="photoPreviewBox" onclick="openPhotoSourceModal('add')" style="width: 130px; height: 130px; border: 2px dashed #cbd5e1; border-radius: 50%; margin: auto; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; overflow: hidden; background-color: #f8fafc;">
                            <span id="photoPlaceholder" style="font-size: 12px; color: var(--text-muted); text-align: center;"><i class="fas fa-camera fa-2x" style="margin-bottom:5px; display:block;"></i>Tap to Add</span>
                            <img id="photoPreview" src="" style="width: 100%; height: 100%; object-fit: cover; display: none;">
                        </div>
                    </div>
                    
                    <div class="form-group"><label for="studentName">Student Name:</label><input type="text" id="studentName" placeholder="Full Name"></div>
                    <div class="form-group"><label for="studentClass">Class/Instrument:</label><input type="text" id="studentClass" placeholder="e.g., Guitar"></div>
                    
                    <div class="form-group">
                        <label for="studentDay">Class Day:</label>
                        <select id="studentDay">
                            <option value="">Select Day</option>
                            <option value="Sunday">Sunday</option>
                            <option value="Monday">Monday</option>
                            <option value="Tuesday">Tuesday</option>
                            <option value="Wednesday">Wednesday</option>
                            <option value="Thursday">Thursday</option>
                            <option value="Friday">Friday</option>
                            <option value="Saturday">Saturday</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="studentTime">Class Time:</label>
                        <input type="time" id="studentTime">
                    </div>

                    <div class="form-group"><label for="studentFee">Monthly Fee (₹):</label><input type="number" id="studentFee" placeholder="e.g., 500"></div>
                    <div class="form-group"><label for="studentEmail">Email Address:</label><input type="email" id="studentEmail" placeholder="example@email.com"></div>
                    <div class="form-group"><label for="guardianName">Guardian's Name:</label><input type="text" id="guardianName" placeholder="Parent/Guardian"></div>
                    <div class="form-group"><label for="phone">Phone Number:</label><input type="tel" id="phone" placeholder="10-digit Number"></div>
                    <div class="form-group"><label for="address">Address:</label><input type="text" id="address" placeholder="Full Address"></div>
                    <div class="form-group"><label for="studentDOB">Date of Birth:</label><input type="date" id="studentDOB"></div>
                </div>
                <button class="btn-success" onclick="addStudent()" style="width: 100%; margin-top: 15px; padding: 12px; font-size: 15px;"><i class="fas fa-save"></i> Add Student</button>
            </div>

            <h3>All Students List</h3>
            <div class="search-bar"><input type="search" id="searchStudents" onkeyup="searchTable('searchStudents', 'studentListTable')" placeholder="Search student..."></div>
            <div style="overflow-x: auto;">
                <table id="studentListTable"><thead><tr><th>ID</th><th>Name & Info</th><th>Class Info</th><th>Fee</th><th>Quick Contact</th><th>Status</th><th>Actions</th></tr></thead><tbody id="allStudentsList"></tbody></table>
            </div>
        </div>

        <div id="dashboard" class="tab-content">
            <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap: wrap; gap: 10px;">
                <h2><i class="fas fa-tachometer-alt"></i> Dashboard Overview</h2>
                <button class="btn-primary" onclick="exportDashboardPDF()"><i class="fas fa-file-pdf"></i> Export Stats PDF</button>
            </div>
            
            <div id="birthdayAlertBox" class="dashboard-card birthday-card" style="display: none; grid-column: 1 / -1;">
                <h3 style="color: var(--pink);"><i class="fas fa-birthday-cake birthday-icon"></i> Today's Birthday!</h3>
                <div id="birthdayList"></div>
            </div>

            <div class="dashboard-grid">
                <div class="dashboard-card">
                    <h3>Financials (Current Month)</h3>
                    <div class="chart-container">
                        <canvas id="financeChart"></canvas>
                    </div>
                    <div id="financeOverviewNumbers" class="summary-box" style="margin-top: 10px; padding: 10px; background: #f8f9fa; font-size: 0.9em;">
                    </div>
                </div>
                <div class="dashboard-card">
                    <h3>Student Statistics</h3>
                    <div id="studentStatsSummary" class="summary-box"></div>
                </div>
                <div class="dashboard-card">
                    <h3>Class Strength</h3>
                    <ul id="classStrengthList" class="class-strength-list"></ul>
                </div>
                <div class="dashboard-card">
                    <h3>Yearly Summary</h3>
                    <div id="dashboardYearlySummary" class="summary-box"></div>
                </div>
                <div class="dashboard-card" style="grid-column: 1 / -1;">
                    <h3><i class="fas fa-exclamation-circle" style="color: var(--danger);"></i> Due Fees Alert</h3>
                    <p id="dueFeeMessage" style="color: var(--text-muted);"></p>
                    <table id="dueFeeTable"><thead><tr><th>Student</th><th>Action</th></tr></thead><tbody></tbody></table>
                </div>
            </div>
        </div>

        <div id="reports" class="tab-content">
            <h2><i class="fas fa-print"></i> Generate Reports</h2>
            <div class="dashboard-card">
                <div class="form-grid">
                    <div class="form-group"><label for="reportType">Report Type</label><select id="reportType" onchange="toggleReportInputs()"><option value="monthly">Monthly Report</option><option value="yearly">Yearly Report</option></select></div>
                    <div class="form-group" id="reportMonth-group"><label for="reportMonth">Select Month</label><input type="month" id="reportMonth"></div>
                    <div class="form-group" id="reportYear-group" style="display: none;"><label for="reportYear">Select Year</label><input type="number" id="reportYear" placeholder="e.g., 2023"></div>
                </div>
                <button class="btn-primary" onclick="generateReport()"><i class="fas fa-table"></i> Generate View</button>
                
                <button id="exportReportBtn" class="btn-primary" style="display:none; margin-top:15px;" onclick="exportReportPDF()"><i class="fas fa-file-pdf"></i> Download Report PDF</button>
            </div>
            
            <div id="reportSummary" class="summary-box" style="display: none;"></div>
            <table id="reportTable" style="display: none;"><thead></thead><tbody></tbody></table>
        </div>

        <div id="settings" class="tab-content">
            <h2><i class="fas fa-sliders-h"></i> App Settings</h2>
            
            <div class="dashboard-grid">
                <div class="dashboard-card">
                    <h3>Institute Logo</h3>
                    <p style="font-size: 13px; color: var(--text-muted);">Upload logo for Header & Receipts.</p>
                    <input type="file" id="instituteLogoInput" accept="image/*" onchange="saveInstituteLogo(this)">
                    <div style="margin-top: 15px; text-align: center;">
                        <img id="logoPreview" src="" style="max-height: 80px; display: none; border: 1px solid #ddd; padding: 5px; border-radius: 5px;">
                        <button class="btn-danger" onclick="removeLogo()" style="font-size: 12px; display: none; margin-top: 5px;" id="removeLogoBtn">Remove</button>
                    </div>
                </div>

                <div class="dashboard-card">
                    <h3>Authorized Signature</h3>
                    <p style="font-size: 13px; color: var(--text-muted);">Upload signature for Receipts & ID Cards.</p>
                    <input type="file" id="authSigInput" accept="image/*" onchange="saveAuthSignature(this)">
                    <div style="margin-top: 15px; text-align: center;">
                        <img id="authSigPreview" src="" style="max-height: 60px; display: none; border: 1px solid #ddd; padding: 5px; border-radius: 5px;">
                        <button class="btn-danger" onclick="removeAuthSignature()" style="font-size: 12px; display: none; margin-top: 5px;" id="removeAuthSigBtn">Remove</button>
                    </div>
                </div>

                <div class="dashboard-card">
                    <h3>Security</h3>
                    <div class="form-group">
                        <label>Update Access PIN</label>
                        <input type="password" id="newAppPin" placeholder="New 4-Digit PIN" maxlength="4" style="margin-bottom: 10px;">
                        <button class="btn-info" onclick="changeAppPin()">Update PIN</button>
                    </div>
                </div>

                <div class="dashboard-card">
                    <h3>Data Backup</h3>
                    <p style="font-size: 13px; color: var(--text-muted);">Download your data and save it to Google Drive safely.</p>
                    <button class="btn-primary btn-google" onclick="secureAction(exportData)">
                        <i class="fab fa-google-drive"></i> Download & Open Drive
                    </button>
                </div>
                <div class="dashboard-card">
                    <h3>Import / Reset</h3>
                    <p style="font-size: 13px; color: var(--text-muted);">Restore from backup or reset app.</p>
                    <button class="btn-warning" onclick="secureAction(() => document.getElementById('importFile').click())"><i class="fas fa-file-upload"></i> Import JSON</button>
                    <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importData(event)">
                    <hr style="margin: 15px 0; border: 0; border-top: 1px solid #eee;">
                    <button class="btn-danger" onclick="secureAction(resetApp)"><i class="fas fa-trash"></i> Factory Reset</button>
                </div>
            </div>
        </div>
    </div>

    <div id="studentDetailsModal" class="modal"><div class="modal-content"><span class="close-button" onclick="closeModal('studentDetailsModal')">&times;</span><h2 id="modalStudentName"></h2><div class="modal-grid"><div><div style="text-align:center; margin-bottom:15px;"><img id="modalStudentPhoto" src="" style="width:100px; height:100px; border-radius:50%; border:3px solid white; box-shadow: 0 4px 6px rgba(0,0,0,0.1); object-fit:cover;"></div><p><strong>Serial No:</strong> <span id="modalSerialNo"></span></p><p><strong>Class:</strong> <span id="modalClass"></span></p><p><strong>Day/Time:</strong> <span id="modalDayTime"></span></p><p><strong>Monthly Fee:</strong> <span id="modalFeeAmount"></span></p><p><strong>Guardian:</strong> <span id="modalGuardianName"></span></p><p><strong>Phone:</strong> <span id="modalPhone"></span></p><p><strong>Email:</strong> <span id="modalEmail"></span></p><p><strong>Address:</strong> <span id="modalAddress"></span></p><p><strong>Date of Birth:</strong> <span id="modalDOB"></span></p><p><strong>Joining Date:</strong> <span id="modalJoiningDate"></span></p></div><div class="modal-section" style="grid-column: 2; grid-row: 1 / span 2;"><h4>Status History</h4><ul id="modalStatusHistory"></ul></div></div><hr style="border:0; border-top:1px solid #eee; margin: 20px 0;"><div class="modal-grid"><div class="modal-section"><h4>Attendance Records</h4><ul id="modalPresentList"></ul><h4>Absence Records</h4><ul id="modalAbsentList"></ul></div><div class="modal-section"><h4>Paid Fees</h4><ul id="modalPaidList"></ul></div></div>
        <div class="modal-footer" style="margin-top:20px; text-align: right; display: flex; flex-wrap: wrap; justify-content: flex-end; gap: 10px; align-items: center; background: #f8fafc; padding: 15px; border-radius: 8px;">
            <div style="text-align: left;">
                <label style="font-size: 11px; margin-bottom: 2px;">ID Issue Date:</label>
                <input type="date" id="idCardIssueDate" style="padding: 5px; font-size: 12px; width: 130px;">
            </div>
            <div style="text-align: left;">
                <label style="font-size: 11px; margin-bottom: 2px;">ID End Date (Optional):</label>
                <input type="date" id="idCardEndDate" style="padding: 5px; font-size: 12px; width: 130px;">
            </div>
            <button class="btn-info" onclick="generateIDCard()"><i class="fas fa-id-card"></i> ID Card</button> 
            <button class="btn-primary" id="exportPdfBtn"><i class="fas fa-file-pdf"></i> Export PDF</button>
        </div>
    </div></div>
    
    <div id="classStudentsModal" class="modal"><div class="modal-content"><span class="close-button" onclick="closeModal('classStudentsModal')">&times;</span><h2 id="classStudentsTitle"></h2><table id="classStudentsTable"><thead><tr><th>Serial No.</th><th>Name</th><th>Contact</th></tr></thead><tbody></tbody></table></div></div>
    
    <div id="statusChangeModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal('statusChangeModal')">&times;</span>
            <h2 id="statusChangeTitle"></h2>
            <input type="hidden" id="statusChangeStudentId">
            <input type="hidden" id="statusChangeToActive">
            
            <div class="form-group">
                <label for="statusDate">Date of Change:</label>
                <input type="date" id="statusDate">
            </div>

            <div class="form-group">
                <label for="statusNote">Note (Optional):</label>
                <textarea id="statusNote" rows="3" placeholder="Reason for status change..."></textarea>
            </div>
            <button class="btn-primary" onclick="saveStatusChange()">Confirm Change</button>
        </div>
    </div>
    
    <div id="photoSourceModal" class="modal" style="z-index: 2000;">
        <div class="modal-content" style="max-width: 320px; text-align: center; top: 20%;">
            <span class="close-button" onclick="closeModal('photoSourceModal')">&times;</span>
            <h3>Select Photo Source</h3>
            <p style="color: var(--text-muted); margin-bottom: 20px;">Choose how you want to add the photo:</p>
            <div style="display: flex; flex-direction: column; gap: 15px;">
                <button class="btn-primary" style="padding: 15px; font-size: 16px; display: flex; align-items: center; justify-content: center; gap: 10px;" onclick="triggerCamera()">
                    <i class="fas fa-camera"></i> Open Camera
                </button>
                <button class="btn-info" style="padding: 15px; font-size: 16px; display: flex; align-items: center; justify-content: center; gap: 10px;" onclick="triggerGallery()">
                    <i class="fas fa-images"></i> Open Gallery
                </button>
            </div>
        </div>
    </div>

    <div id="editStudentModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal('editStudentModal')">&times;</span>
            <h2>Edit Student Details</h2>
            <input type="hidden" id="editStudentId">
            
            <input type="file" id="editStudentCamera" accept="image/*" capture="environment" onchange="handlePhotoSelection(this, 'edit')" style="display:none;">
            <input type="file" id="editStudentGallery" accept="image/*" onchange="handlePhotoSelection(this, 'edit')" style="display:none;">

            <div class="form-group" style="text-align: center; margin-bottom: 20px;">
                <label>Update Photo</label>
                <div onclick="openPhotoSourceModal('edit')" style="width: 100px; height: 100px; margin: 0 auto 10px auto; border-radius: 50%; overflow: hidden; border: 3px solid #e2e8f0; cursor: pointer; background: #fafafa; display: flex; align-items: center; justify-content: center; position: relative;">
                    <img id="editPhotoPreview" src="" style="width: 100%; height: 100%; object-fit: cover;">
                    <div style="position: absolute; bottom: 0; background: rgba(0,0,0,0.5); width: 100%; color: white; font-size: 10px;">EDIT</div>
                </div>
            </div>

            <div class="form-grid">
                <div class="form-group"><label for="editStudentName">Student Name:</label><input type="text" id="editStudentName"></div>
                <div class="form-group"><label for="editStudentClass">Class:</label><input type="text" id="editStudentClass"></div>
                <div class="form-group"><label for="editStudentDay">Class Day:</label><select id="editStudentDay"><option value="">Select Day</option><option value="Sunday">Sunday</option><option value="Monday">Monday</option><option value="Tuesday">Tuesday</option><option value="Wednesday">Wednesday</option><option value="Thursday">Thursday</option><option value="Friday">Friday</option><option value="Saturday">Saturday</option></select></div>
                <div class="form-group"><label for="editStudentTime">Class Time:</label><input type="time" id="editStudentTime"></div>
                <div class="form-group"><label for="editStudentFee">Monthly Fee (₹):</label><input type="number" id="editStudentFee"></div>
                <div class="form-group"><label for="editStudentEmail">Email Address:</label><input type="email" id="editStudentEmail"></div>
                <div class="form-group"><label for="editGuardianName">Guardian's Name:</label><input type="text" id="editGuardianName"></div>
                <div class="form-group"><label for="editPhone">Phone Number:</label><input type="tel" id="editPhone"></div>
                <div class="form-group"><label for="editAddress">Address:</label><input type="text" id="editAddress"></div>
                <div class="form-group"><label for="editStudentDOB">Date of Birth:</label><input type="date" id="editStudentDOB"></div>
            </div>
            <button class="btn-primary" onclick="saveStudentChanges()" style="margin-top: 20px; width: 100%;">Save Changes</button>
        </div>
    </div>
    
    <div id="feeModal" class="modal">
        <div class="modal-content" style="max-width: 400px;">
            <span class="close-button" onclick="closeModal('feeModal')">&times;</span>
            <h2 id="feeModalTitle"></h2>
            <input type="hidden" id="feeStudentId">
            <input type="hidden" id="feeRecordMonth">
            <div class="form-group">
                <label for="feeAmount">Amount (₹):</label>
                <input type="number" id="feeAmount" placeholder="500" style="font-size: 1.2em; font-weight: bold;">
            </div>
            <div class="form-group">
                <label for="paymentMode">Payment Mode:</label>
                <select id="paymentMode">
                    <option value="Cash">Cash</option>
                    <option value="Online">Online (UPI/Bank)</option>
                </select>
            </div>
            <div class="form-group">
                <label for="transactionId">Transaction ID (Optional):</label>
                <input type="text" id="transactionId" placeholder="UPI Ref No. / Txn ID">
            </div>
            <div class="form-group">
                <label for="feeDate">Payment Date:</label>
                <input type="date" id="feeDate">
            </div>
            <button class="btn-primary" onclick="saveFee()" style="width: 100%;">Save Record</button>
        </div>
    </div>
    
    <script>
        // --- PWA SERVICE WORKER REGISTRATION ---
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./serviceWorker.js')
                    .then(registration => {
                        console.log('Service Worker registered with scope:', registration.scope);
                    })
                    .catch(error => {
                        console.log('Service Worker registration failed:', error);
                    });
            });
        }

        // --- INDEXED DB WRAPPER ---
        const DB_NAME = 'MusicClassManagerDB';
        const DB_VERSION = 1;
        const STORE_NAME = 'appData';
        let db;

        function openDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                request.onupgradeneeded = (event) => {
                    db = event.target.result;
                    if (!db.objectStoreNames.contains(STORE_NAME)) {
                        db.createObjectStore(STORE_NAME);
                    }
                };
                request.onsuccess = (event) => {
                    db = event.target.result;
                    resolve(db);
                };
                request.onerror = (event) => {
                    reject('Database error: ' + event.target.errorCode);
                };
            });
        }

        function dbGet(key) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([STORE_NAME], 'readonly');
                const store = transaction.objectStore(STORE_NAME);
                const request = store.get(key);
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        function dbSet(key, value) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([STORE_NAME], 'readwrite');
                const store = transaction.objectStore(STORE_NAME);
                const request = store.put(value, key);
                request.onsuccess = () => resolve();
                request.onerror = () => reject(request.error);
            });
        }

        function dbDelete(key) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([STORE_NAME], 'readwrite');
                const store = transaction.objectStore(STORE_NAME);
                const request = store.delete(key);
                request.onsuccess = () => resolve();
                request.onerror = () => reject(request.error);
            });
        }

        function dbClear() {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([STORE_NAME], 'readwrite');
                const store = transaction.objectStore(STORE_NAME);
                const request = store.clear();
                request.onsuccess = () => resolve();
                request.onerror = () => reject(request.error);
            });
        }
        
        // --- END INDEXED DB ---

        document.addEventListener('DOMContentLoaded', async () => {
            await openDB(); // Initialize IndexedDB
            
            // MIGRATION LOGIC: If data exists in LocalStorage but not IndexedDB, move it.
            let existingPin = await dbGet('app_pin');
            if (!existingPin) {
                const lsPin = localStorage.getItem('app_pin');
                if(lsPin) {
                    // Migrate data
                    await dbSet('app_pin', lsPin);
                    if(localStorage.getItem('students')) await dbSet('students', JSON.parse(localStorage.getItem('students')));
                    if(localStorage.getItem('attendance')) await dbSet('attendance', JSON.parse(localStorage.getItem('attendance')));
                    if(localStorage.getItem('fees')) await dbSet('fees', JSON.parse(localStorage.getItem('fees')));
                    if(localStorage.getItem('studentSerialCounter')) await dbSet('studentSerialCounter', localStorage.getItem('studentSerialCounter'));
                    if(localStorage.getItem('instituteLogo')) await dbSet('instituteLogo', localStorage.getItem('instituteLogo'));
                    if(localStorage.getItem('authorizedSignature')) await dbSet('authorizedSignature', localStorage.getItem('authorizedSignature'));
                    if(localStorage.getItem('lastBackupDate')) await dbSet('lastBackupDate', localStorage.getItem('lastBackupDate'));
                    
                    Swal.fire('System Update', 'Your data has been successfully migrated to the new database system.', 'success');
                } else {
                    await dbSet('app_pin', '1234');
                }
            }

            await loadInstituteLogo();
            await loadAuthSignature(); 
            secureAction(() => { initApp(); checkBackupStatus(); }, true);
            document.querySelector('.close-pin').style.display = 'none';
        });

        async function initApp() {
            const now = new Date();
            document.getElementById('attendanceDate').valueAsDate = now;
            const currentMonthStr = `${now.getFullYear()}-${(now.getMonth() + 1).toString().padStart(2, '0')}`;
            document.getElementById('feeMonth').value = currentMonthStr;
            document.getElementById('reportMonth').value = currentMonthStr;
            document.getElementById('reportYear').value = now.getFullYear();
            
            document.getElementById('idCardIssueDate').valueAsDate = now;

            // Load from DB
            const sData = await dbGet('students');
            students = (sData || []).map(migrateStudentData);
            attendance = (await dbGet('attendance')) || {};
            fees = (await dbGet('fees')) || {};
            studentSerialCounter = parseInt(await dbGet('studentSerialCounter')) || 1;
            
            loadAllData();
            document.getElementById('attendanceDate').addEventListener('change', renderAttendance);
            document.getElementById('feeMonth').addEventListener('change', renderFees);
        }
        
        async function checkBackupStatus() {
            const lastBackup = await dbGet('lastBackupDate');
            if (!lastBackup) { Swal.fire({ title: 'Backup Warning', text: 'Apni ekhono backup nen ni. Data safe rakhte ekhuni backup nin.', icon: 'warning', confirmButtonText: 'Okay' }); } 
            else { const daysDiff = (new Date() - new Date(lastBackup)) / (1000 * 60 * 60 * 24); if (daysDiff > 7) { Swal.fire({ title: 'Backup Reminder', text: `Pray ${Math.floor(daysDiff)} din hoye geche backup nen ni. Please backup file download kore Google Drive e upload korun.`, icon: 'warning', confirmButtonText: 'Okay' }); } }
        }

        const INSTITUTE_NAME = "Guitar, Bass Guitar, Piano, Keyboard, Mandolin Classes";
        const MY_NAME = "Srikanta Banerjee";
        const DEFAULT_FEE = 500, DUE_DATE = 10;
        let students = [], attendance = {}, fees = {}, studentSerialCounter = 1;
        let financeChartInstance = null;
        
        let instituteLogo = null;
        let authorizedSignature = null;

        async function saveInstituteLogo(input) {
            const file = input.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = new Image();
                    img.onload = async function() {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        const maxWidth = 200;
                        const scaleSize = maxWidth / img.width;
                        canvas.width = maxWidth;
                        canvas.height = img.height * scaleSize;
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        const logoBase64 = canvas.toDataURL('image/jpeg', 0.8);
                        await dbSet('instituteLogo', logoBase64);
                        await loadInstituteLogo();
                        Swal.fire('Success', 'Logo saved!', 'success');
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        }
        
        async function loadInstituteLogo() {
            instituteLogo = await dbGet('instituteLogo');
            const img = document.getElementById('logoPreview');
            const headerLogo = document.getElementById('headerLogo');
            const btn = document.getElementById('removeLogoBtn');
            
            if (instituteLogo) {
                img.src = instituteLogo;
                img.style.display = 'block';
                btn.style.display = 'inline-block';
                headerLogo.src = instituteLogo;
                headerLogo.style.display = 'block';
            } else {
                img.style.display = 'none';
                btn.style.display = 'none';
                headerLogo.style.display = 'none';
            }
        }
        
        async function removeLogo() {
            await dbDelete('instituteLogo');
            instituteLogo = null;
            await loadInstituteLogo();
        }

        async function saveAuthSignature(input) {
            const file = input.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = new Image();
                    img.onload = async function() {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        const maxWidth = 150; 
                        const scaleSize = maxWidth / img.width;
                        canvas.width = maxWidth;
                        canvas.height = img.height * scaleSize;
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        const sigBase64 = canvas.toDataURL('image/png'); 
                        await dbSet('authorizedSignature', sigBase64);
                        await loadAuthSignature();
                        Swal.fire('Success', 'Signature saved!', 'success');
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        }

        async function loadAuthSignature() {
            authorizedSignature = await dbGet('authorizedSignature');
            const img = document.getElementById('authSigPreview');
            const btn = document.getElementById('removeAuthSigBtn');
            
            if (authorizedSignature) {
                img.src = authorizedSignature;
                img.style.display = 'block';
                btn.style.display = 'inline-block';
            } else {
                img.style.display = 'none';
                btn.style.display = 'none';
            }
        }

        async function removeAuthSignature() {
            await dbDelete('authorizedSignature');
            authorizedSignature = null;
            await loadAuthSignature();
        }

        /**
         * Returns the effective date from which the student is considered "active"
         * for fee calculation purposes (i.e., the joining date or the date of last activation).
         * @param {Object} student 
         * @returns {Date}
         */
        function getFeeCalculationStartDate(student) {
            if (!student.status.isActive) {
                // If currently inactive, no fee calculation should happen for the future.
                return new Date(2099, 0, 1); // A date far in the future
            }

            let effectiveDate = new Date(student.joining_date);

            // Find the most recent 'Active' status change date
            if (student.status.history && student.status.history.length > 0) {
                const lastActiveEntry = student.status.history.find(entry => entry.status === 'Active');
                if (lastActiveEntry) {
                    const lastActiveDate = new Date(lastActiveEntry.date);
                    // The actual joining date is the earliest 'Active' date.
                    // If the student was deactivated and then reactivated, the lastActiveDate is the one we care about.
                    
                    // We need to check if there was a subsequent 'Inactive' status *after* the joining date
                    const wasDeactivated = student.status.history.some(entry => 
                        entry.status === 'Inactive' && new Date(entry.date) > new Date(student.joining_date)
                    );

                    if (wasDeactivated) {
                        // If student was deactivated at some point, find the *latest* Active entry.
                        // The array is unshifted, so the latest active entry is the first one that is 'Active'
                        // unless the first entry is 'Inactive', which means the user is currently inactive (handled above)
                        
                        // We are already checking if the student is currently active.
                        // So, the latest 'Active' date is the correct one to start the calculation from.
                        const lastReactivationEntry = student.status.history.find(entry => entry.status === 'Active');
                        if (lastReactivationEntry && new Date(lastReactivationEntry.date) > effectiveDate) {
                            effectiveDate = new Date(lastReactivationEntry.date);
                        }
                    }
                }
            }

            // For fee calculation, we are interested in the month. Set to the 1st day of the effective month.
            effectiveDate.setDate(1);
            effectiveDate.setHours(0, 0, 0, 0);

            return effectiveDate;
        }

        /**
         * Checks if the student has any overall dues before the current month.
         * The check must only include months where the student was marked 'Active'
         * @param {number} studentId 
         * @returns {boolean}
         */
        function checkGlobalDues(studentId) {
            const s = students.find(x => x.id === studentId);
            if (!s) return false;

            const feeStartDate = getFeeCalculationStartDate(s);
            
            const now = new Date();
            const currentYear = now.getFullYear();
            const currentMonthIndex = now.getMonth();
            const today = now.getDate();
            
            // Loop through all relevant months from joining/reactivation up to the current month (or previous month for lookback)
            let iterDate = new Date(feeStartDate.getFullYear(), feeStartDate.getMonth(), 1);

            while (iterDate <= now) {
                const y = iterDate.getFullYear();
                const m = iterDate.getMonth() + 1;
                const monthStr = `${y}-${m.toString().padStart(2, '0')}`;
                const checkMonth = new Date(y, m - 1, DUE_DATE + 1); // Check after DUE_DATE of this month

                // Check if the student was ACTIVE during this month
                if (wasStudentActiveDuringMonth(s, monthStr)) {
                    
                    // 1. Check for Dues in Previous Months (before current month)
                    if (y < currentYear || (y === currentYear && m - 1 < currentMonthIndex)) {
                        if (fees[monthStr]?.[studentId]?.status !== 'paid') {
                            return true; // Found an unpaid previous month where they were active
                        }
                    }
                    // 2. Check for Dues in Current Month (if today is past the due date)
                    else if (y === currentYear && m - 1 === currentMonthIndex && today > DUE_DATE) {
                        if (fees[monthStr]?.[studentId]?.status !== 'paid') {
                            return true; // Found an unpaid current month after due date
                        }
                    }
                }

                iterDate.setMonth(iterDate.getMonth() + 1);
            }

            return false;
        }

        /**
         * Gets a list of months that are currently due for the student.
         * Only includes months where the student was marked 'Active'.
         * @param {number} studentId 
         * @returns {string[]} List of due months (formatted as 'Month Year')
         */
        function getDueMonthsList(studentId) {
            const s = students.find(x => x.id === studentId);
            if (!s) return [];
            
            const dueMonths = [];
            const now = new Date();
            const feeStartDate = getFeeCalculationStartDate(s);

            let iterDate = new Date(feeStartDate.getFullYear(), feeStartDate.getMonth(), 1);

            while (iterDate <= now) {
                const y = iterDate.getFullYear();
                const m = iterDate.getMonth() + 1;
                const monthStr = `${y}-${m.toString().padStart(2, '0')}`;

                // Only check for due if the student was active that month AND the month is actually due
                if (wasStudentActiveDuringMonth(s, monthStr) && isMonthDue(monthStr) && fees[monthStr]?.[studentId]?.status !== 'paid') {
                    dueMonths.push(formatMonthYear(monthStr));
                }

                iterDate.setMonth(iterDate.getMonth() + 1);
            }
            return dueMonths;
        }

        /**
         * Checks if the student was "Active" at any point during the given month (monthStr).
         * @param {object} student 
         * @param {string} monthStr - YYYY-MM format
         * @returns {boolean}
         */
        function wasStudentActiveDuringMonth(student, monthStr) {
            if (!student.status.history || student.status.history.length === 0) {
                // Should not happen, but fallback to joining date check
                const joinDate = new Date(student.joining_date);
                const [year, month] = monthStr.split('-').map(Number);
                const monthStart = new Date(year, month - 1, 1);
                const monthEnd = new Date(year, month, 0); // Last day of the month
                return joinDate <= monthEnd;
            }

            const [year, month] = monthStr.split('-').map(Number);
            const monthStart = new Date(year, month - 1, 1);
            const monthEnd = new Date(year, month, 0, 23, 59, 59); // End of the month

            let wasActive = false;

            // Iterate through status history entries
            for (let i = 0; i < student.status.history.length; i++) {
                const entry = student.status.history[i];
                const entryDate = new Date(entry.date);
                const nextEntry = student.status.history[i - 1]; // History is unshifted (newest first)
                
                // Determine the end date of this status period
                const statusEndDate = nextEntry ? new Date(nextEntry.date) : new Date(2099, 0, 1); 
                statusEndDate.setDate(statusEndDate.getDate() - 1); // Status ends the day before the next status starts
                
                if (entry.status === 'Active') {
                    // Check for overlap between the 'Active' period and the target month
                    // Active period starts on entryDate and ends on statusEndDate (or a long time if it's the current status)
                    const activePeriodStart = entryDate;
                    const activePeriodEnd = statusEndDate;
                    
                    // Check for overlap: [monthStart, monthEnd] and [activePeriodStart, activePeriodEnd]
                    const overlap = Math.max(monthStart.getTime(), activePeriodStart.getTime()) <= Math.min(monthEnd.getTime(), activePeriodEnd.getTime());

                    if (overlap) {
                        wasActive = true;
                        break;
                    }
                }
            }

            return wasActive;
        }
        
        function getDueMsg(student, month) {
            const amount = student.fee_amount || DEFAULT_FEE;
            const monthName = formatMonthYear(month);
            const cls = student.class || 'Music';
            return `Dear ${student.name}, This is a friendly reminder that your fee of ₹${amount} for ${monthName} for your ${cls} class is due. Please pay as soon as possible. Thank you. From ${MY_NAME} (${INSTITUTE_NAME}).`;
        }

        function getPaidMsg(student, month, amount, txnId) {
            const monthName = formatMonthYear(month);
            const cls = student.class || 'Music';
            let msg = `Dear ${student.name}, Your fee of ₹${amount} for ${monthName} for your ${cls} class has been received by ${MY_NAME} (${INSTITUTE_NAME}).`;
            if(txnId) {
                msg += ` Transaction ID: ${txnId}.`;
            }
            msg += ` Thank you.`;
            return msg;
        }

        function sendMsg(type, studentId, month, amount = 0, isDue = true) {
            const student = students.find(s => s.id === studentId);
            if(!student) return;
            
            let txnId = "";
            if (!isDue && fees[month] && fees[month][studentId]) {
                txnId = fees[month][studentId].transactionId || "";
            }

            const msgBody = isDue ? getDueMsg(student, month) : getPaidMsg(student, month, amount, txnId);
            
            if(type === 'wa') {
                let cleanPhone = student.phone.replace(/[^0-9]/g, ''); 
                if(cleanPhone.length === 10) cleanPhone = '91' + cleanPhone;
                window.open(`https://wa.me/${cleanPhone}?text=${encodeURIComponent(msgBody)}`, '_blank');
            } else if (type === 'sms') {
                window.open(`sms:${student.phone}?body=${encodeURIComponent(msgBody)}`, '_self');
            } else if (type === 'mail') {
                const subject = isDue ? "Fee Reminder" : "Payment Receipt";
                window.open(`mailto:${student.email}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(msgBody)}`, '_self');
            }
        }

        function sendGeneralMsg(type, studentId) {
            const student = students.find(s => s.id === studentId);
            if(!student) return;
            
            const msgBody = `Hello ${student.name}, Hope you are doing well. Just connecting regarding the music classes updates. From Srikanta Banerjee (Guitar, Bass Guitar, Piano, Keyboard, Mandolin Classes.)`;

            if(type === 'wa') {
                let cleanPhone = student.phone.replace(/[^0-9]/g, ''); 
                if(cleanPhone.length === 10) cleanPhone = '91' + cleanPhone;
                window.open(`https://wa.me/${cleanPhone}?text=${encodeURIComponent(msgBody)}`, '_blank');
            } else if (type === 'sms') {
                window.open(`sms:${student.phone}?body=${encodeURIComponent(msgBody)}`, '_self');
            } else if (type === 'mail') {
                window.open(`mailto:${student.email}?subject=${encodeURIComponent("Music Class Info")}&body=${encodeURIComponent(msgBody)}`, '_self');
            }
        }

        function sendBirthdayWish(type, studentId) {
            const student = students.find(s => s.id === studentId);
            if(!student) return;
            const msgBody = `Happy Birthday ${student.name}! Wishing you a fantastic day filled with music and joy. Best wishes from Srikanta Banerjee (Guitar, Bass Guitar, Piano, Keyboard, Mandolin Classes).`;

            if(type === 'wa') {
                let cleanPhone = student.phone.replace(/[^0-9]/g, ''); 
                if(cleanPhone.length === 10) cleanPhone = '91' + cleanPhone;
                window.open(`https://wa.me/${cleanPhone}?text=${encodeURIComponent(msgBody)}`, '_blank');
            } else if (type === 'sms') {
                window.open(`sms:${student.phone}?body=${encodeURIComponent(msgBody)}`, '_self');
            } else if (type === 'mail') {
                window.open(`mailto:${student.email}?subject=${encodeURIComponent("Happy Birthday!")}&body=${encodeURIComponent(msgBody)}`, '_self');
            }
        }

        let pendingAction = null, pinInput = "";
        
        function secureAction(callback, isInit = false) { 
            pendingAction = callback; pinInput = ""; updatePinDots(); 
            document.querySelector('.close-pin').style.display = isInit ? 'none' : 'block'; 
            document.getElementById('securityOverlay').style.display = 'flex'; 
        }
        
        function closePinScreen() { document.getElementById('securityOverlay').style.display = 'none'; pendingAction = null; pinInput = ""; }
        function pressPin(key) { if (key === 'C') pinInput = ""; else if (pinInput.length < 4) pinInput += key; updatePinDots(); }
        function updatePinDots() { document.querySelectorAll('.pin-dot').forEach((dot, index) => { index < pinInput.length ? dot.classList.add('filled') : dot.classList.remove('filled'); }); }
        
        async function submitPin() { 
            const currentPin = await dbGet('app_pin');
            if (pinInput === currentPin) { 
                document.getElementById('securityOverlay').style.display = 'none'; 
                if (pendingAction) pendingAction(); 
                pendingAction = null; pinInput = ""; 
            } else { alert("Incorrect PIN"); pinInput = ""; updatePinDots(); } 
        }

        async function changeAppPin() {
            const newPin = document.getElementById('newAppPin').value;
            if (newPin.length === 4 && !isNaN(newPin)) {
                await dbSet('app_pin', newPin); Swal.fire('Success', 'PIN changed successfully.', 'success'); document.getElementById('newAppPin').value = '';
            } else { Swal.fire('Error', 'PIN must be 4 digits.', 'error'); }
        }

        async function addStudent() { 
            const name = document.getElementById('studentName').value; 
            const className = document.getElementById('studentClass').value; 
            const day = document.getElementById('studentDay').value;
            const time = document.getElementById('studentTime').value;
            const fee = parseFloat(document.getElementById('studentFee').value) || DEFAULT_FEE; 
            const email = document.getElementById('studentEmail').value;
            const guardian = document.getElementById('guardianName').value;
            const phone = document.getElementById('phone').value;
            const address = document.getElementById('address').value;
            const dob = document.getElementById('studentDOB').value;

            if (name.trim() === '') { Swal.fire('Error', 'Name is required.', 'error'); return; } 
            
            const newStudent = { 
                id: Date.now(), 
                serial_no: studentSerialCounter++, 
                name, class: className, class_day: day, class_time: time,
                fee_amount: fee, email, guardian, phone, address,
                dob: dob, 
                photo: currentPhotoBase64,
                joining_date: new Date().toISOString().split('T')[0], 
                status: { isActive: true, history: [{ status: 'Active', date: new Date().toISOString().split('T')[0], note: 'Joined' }] } 
            }; 
            students.push(newStudent); await saveData(); 
            
            // Reset Inputs
            document.getElementById('studentName').value = ''; document.getElementById('studentClass').value = ''; 
            document.getElementById('studentFee').value = ''; document.getElementById('studentEmail').value = ''; 
            document.getElementById('guardianName').value = ''; document.getElementById('phone').value = ''; 
            document.getElementById('address').value = ''; document.getElementById('studentDOB').value = '';
            document.getElementById('studentDay').value = ''; document.getElementById('studentTime').value = '';
            document.getElementById('photoPreview').style.display = 'none';
            document.getElementById('photoPlaceholder').style.display = 'block';
            currentPhotoBase64 = null;
            document.getElementById('addStudentCamera').value = '';
            document.getElementById('addStudentGallery').value = '';
            
            loadAllData(); 
            Swal.fire('Success', 'Student added successfully!', 'success'); 
        }

        async function saveData() { 
            await dbSet('students', students); 
            await dbSet('attendance', attendance); 
            await dbSet('fees', fees); 
            await dbSet('studentSerialCounter', studentSerialCounter); 
        }
        
        function loadAllData() { renderDashboard(); loadStudentsList(); renderAttendance(); renderFees(); }
        
        async function exportData() {
            const data = { students, attendance, fees, studentSerialCounter };
            const jsonStr = JSON.stringify(data);
            const defaultDate = new Date().toISOString().split('T')[0];
            const defaultName = `music_class_backup_${defaultDate}.json`;

            try {
                if (window.showSaveFilePicker) {
                    const handle = await window.showSaveFilePicker({
                        suggestedName: defaultName,
                        types: [{ description: 'JSON Backup File', accept: { 'application/json': ['.json'] }, }],
                    });
                    const writable = await handle.createWritable();
                    await writable.write(jsonStr);
                    await writable.close();
                } else {
                    const { value: fileName } = await Swal.fire({
                        title: 'Backup File Name',
                        input: 'text',
                        inputValue: defaultName,
                        text: 'Enter a name for your backup file:',
                        showCancelButton: true
                    });
                    if (!fileName) return;
                    const blob = new Blob([jsonStr], { type: "application/json" });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = fileName.endsWith('.json') ? fileName : fileName + '.json';
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                }
                await dbSet('lastBackupDate', new Date().toISOString());
                Swal.fire({
                    title: 'Backup Saved!',
                    html: '<p>Backup file saved successfully. Ekhon file ti <b>Google Drive</b> e upload kore rakhun.</p>',
                    icon: 'success',
                    showCancelButton: true,
                    confirmButtonText: 'Open Google Drive',
                    cancelButtonText: 'Close'
                }).then((result) => { if (result.isConfirmed) { window.open('https://drive.google.com', '_blank'); } });
            } catch (err) { if (err.name !== 'AbortError') { console.error(err); Swal.fire('Error', 'Failed to save backup.', 'error'); } }
        }
        
        function openTab(tabName) { document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active')); document.querySelectorAll('.tab-button').forEach(button => button.classList.remove('active')); document.getElementById(tabName).classList.add('active'); event.currentTarget.classList.add('active'); if(tabName === 'dashboard') renderDashboard(); }
        function migrateStudentData(student) { 
            if (student.status && !student.status.history) { const oldNote = student.status.note || 'Legacy data'; const oldDate = student.status.isActive ? student.status.last_active_date : student.status.last_inactive_date || student.joining_date; student.status.history = [{ status: student.status.isActive ? 'Active' : 'Inactive', date: oldDate, note: oldNote }]; } 
            if (student.fee_amount === undefined) { student.fee_amount = DEFAULT_FEE; } 
            if (!student.photo) student.photo = null; 
            if (!student.dob) student.dob = null; 
            return student; 
        }
        
        // --- PHOTO SELECTION LOGIC ---
        let currentPhotoBase64 = null;
        let currentEditPhotoBase64 = null;
        let photoSelectionContext = 'add';

        function openPhotoSourceModal(context) {
            photoSelectionContext = context;
            document.getElementById('photoSourceModal').style.display = 'block';
        }

        function triggerCamera() {
            closeModal('photoSourceModal');
            const id = photoSelectionContext === 'add' ? 'addStudentCamera' : 'editStudentCamera';
            document.getElementById(id).click();
        }

        function triggerGallery() {
            closeModal('photoSourceModal');
            const id = photoSelectionContext === 'add' ? 'addStudentGallery' : 'editStudentGallery';
            document.getElementById(id).click();
        }

        function handlePhotoSelection(input, context) {
            const file = input.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = new Image();
                    img.onload = function() {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        const maxWidth = 150;
                        const scaleSize = maxWidth / img.width;
                        canvas.width = maxWidth;
                        canvas.height = img.height * scaleSize;
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        const base64 = canvas.toDataURL('image/jpeg', 0.7);
                        
                        if (context === 'add') {
                            currentPhotoBase64 = base64;
                            document.getElementById('photoPreview').src = base64;
                            document.getElementById('photoPreview').style.display = 'block';
                            document.getElementById('photoPlaceholder').style.display = 'none';
                        } else {
                            currentEditPhotoBase64 = base64;
                            document.getElementById('editPhotoPreview').src = base64;
                        }
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        }

        async function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const json = e.target.result;
                    let importedData = JSON.parse(json);
                    
                    if (!importedData || !Array.isArray(importedData.students)) {
                        throw new Error("Invalid Data Format");
                    }

                    Swal.fire({
                        title: 'Overwrite Data?',
                        text: "This will replace all current data.",
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonText: 'Yes, Import'
                    }).then(async (result) => {
                        if (result.isConfirmed) {
                            students = (importedData.students || []).map(migrateStudentData);
                            attendance = importedData.attendance || {};
                            fees = importedData.fees || {};
                            studentSerialCounter = importedData.studentSerialCounter || (students.length + 1);
                            await saveData(); 
                            loadAllData(); 
                            Swal.fire('Success', 'Data imported successfully!', 'success');
                        }
                    });
                } catch (error) {
                    console.error(error);
                    Swal.fire('Error', 'Failed to load backup file. Please check the file.', 'error');
                } finally {
                    event.target.value = null; 
                }
            };
            reader.readAsText(file);
        }

        function openStatusChangeModal(id, toActive) { 
            document.getElementById('statusChangeStudentId').value = id; 
            document.getElementById('statusChangeToActive').value = toActive; 
            document.getElementById('statusChangeTitle').textContent = toActive ? 'Activate Student' : 'Deactivate Student'; 
            document.getElementById('statusDate').valueAsDate = new Date();
            document.getElementById('statusNote').value = ''; 
            document.getElementById('statusChangeModal').style.display = 'block'; 
        }

        async function saveStatusChange() { 
            const id = parseInt(document.getElementById('statusChangeStudentId').value);
            const toActive = document.getElementById('statusChangeToActive').value === 'true';
            const note = document.getElementById('statusNote').value.trim(); 
            const statusDate = document.getElementById('statusDate').value;

            if (!statusDate) { Swal.fire('Error', 'Please select a date.', 'error'); return; }

            const student = students.find(s => s.id === id); 
            if (student) { 
                student.status.isActive = toActive; 
                student.status.history.unshift({ 
                    status: toActive ? 'Active' : 'Inactive', 
                    date: statusDate, 
                    note: note || (toActive ? 'Re-activated' : 'Deactivated') 
                }); 
                await saveData(); 
                loadAllData(); 
                closeModal('statusChangeModal'); 
                Swal.fire('Updated', `Status changed.`, 'success'); 
            } 
        }
        
        function getStudentHtml(student) { 
            const photoSrc = student.photo ? student.photo : 'https://via.placeholder.com/40?text=S'; 
            const phoneText = student.phone ? `<span class="student-phone-sub">${student.phone}</span>` : '';
            const dayText = student.class_day ? `<span class="student-time-sub" style="font-size:10px; color:#666;">${student.class_day}</span>` : '';
            
            return `<div class="student-cell">
                      <img src="${photoSrc}" class="student-thumb">
                      <div>
                        <span class="student-name-link" onclick="showStudentDetails(${student.id})">${student.name}</span>
                        ${phoneText}
                        ${dayText}
                      </div>
                    </div>`; 
        }

        function isMonthDue(monthStr) { const now = new Date(); now.setHours(0,0,0,0); const [year, month] = monthStr.split('-').map(Number); const firstDayOfMonth = new Date(year, month - 1, 1); if (firstDayOfMonth > now) return false; const currentYear = now.getFullYear(), currentMonthIndex = now.getMonth(), currentDay = now.getDate(); if (year < currentYear) return true; if (year === currentYear && month - 1 < currentMonthIndex) return true; return year === currentYear && month - 1 === currentMonthIndex && currentDay > DUE_DATE; }
        function formatMonthYear(monthStr) { const [year, month] = monthStr.split('-'); const date = new Date(year, month - 1); return date.toLocaleString('en-US', { month: 'long', year: 'numeric' }); }
        
        function getContactButtons(studentId, month) {
            const student = students.find(s => s.id === studentId); if (!student) return 'N/A'; let b = '';
            // Only check if the month is due AND the student was active during that month
            const isDue = month && isMonthDue(month) && wasStudentActiveDuringMonth(student, month) && !(fees[month]?.[student.id]?.status === 'paid');
            if (student.phone || student.email) {
                if(isDue) {
                    b += `<button class="btn-whatsapp" onclick="sendMsg('wa', ${student.id}, '${month}')">WhatsApp</button>`;
                    b += `<button class="btn-sms" onclick="sendMsg('sms', ${student.id}, '${month}')">SMS</button>`;
                    b += `<button class="btn-mail" onclick="sendMsg('mail', ${student.id}, '${month}')">Email</button>`;
                    b += `<a href="tel:${student.phone}" class="btn-like btn-call">Call</a>`;
                } else {
                   b += `<a href="tel:${student.phone}" class="btn-like btn-call">Call</a>`; 
                }
            }
            return b || 'N/A';
        }

        function getAllContactButtons(student) {
            let b = '';
            if (student.phone) {
                b += `<a href="tel:${student.phone}" class="btn-like btn-call">Call</a>`;
                b += `<button class="btn-whatsapp" onclick="sendGeneralMsg('wa', ${student.id})">WhatsApp</button>`;
                b += `<button class="btn-sms" onclick="sendGeneralMsg('sms', ${student.id})">SMS</button>`;
            }
            if (student.email) {
                b += `<button class="btn-mail" onclick="sendGeneralMsg('mail', ${student.id})">Mail</button>`;
            }
            return b || 'N/A';
        }

        function showCategoryList(type) {
            const list = students.filter(s => type === 'active' ? s.status.isActive : !s.status.isActive);
            document.getElementById('classStudentsTitle').textContent = type === 'active' ? 'Active Students' : 'Inactive Students';
            const tableBody = document.querySelector('#classStudentsTable tbody');
            tableBody.innerHTML = '';
            if(list.length === 0) { tableBody.innerHTML = '<tr><td colspan="3" style="text-align:center; padding:20px;">No students found.</td></tr>'; } else {
                list.forEach(s => { tableBody.innerHTML += `<tr><td>${s.serial_no}</td><td>${getStudentHtml(s)}</td><td>${getAllContactButtons(s)}</td></tr>`; });
            }
            document.getElementById('classStudentsModal').style.display = 'block';
        }
        
        function checkBirthday(dobString) {
            if (!dobString) return false;
            const today = new Date();
            const dob = new Date(dobString);
            return today.getDate() === dob.getDate() && today.getMonth() === dob.getMonth();
        }

        function renderDashboard() { 
            const activeStudents = students.filter(s => s.status.isActive); 
            document.getElementById('studentStatsSummary').innerHTML = `
                <div class="clickable-stat" onclick="showCategoryList('active')"><h4>Active</h4><p class="summary-collected">${activeStudents.length}</p></div>
                <div class="clickable-stat" onclick="showCategoryList('inactive')"><h4>Inactive</h4><p class="summary-due">${students.length - activeStudents.length}</p></div>
                <div><h4>Total</h4><p class="summary-total">${students.length}</p></div>
            `; 
            
            // --- Birthday Logic ---
            const birthdayBox = document.getElementById('birthdayAlertBox');
            const birthdayList = document.getElementById('birthdayList');
            const birthdayStudents = activeStudents.filter(s => checkBirthday(s.dob));
            
            if (birthdayStudents.length > 0) {
                birthdayList.innerHTML = '';
                birthdayStudents.forEach(s => {
                    birthdayList.innerHTML += `
                        <div style="display:flex; align-items:center; justify-content:space-between; background:#fff; padding:10px; border-radius:8px; margin-bottom:5px; border:1px solid #ffe4e6;">
                            <div style="display:flex; align-items:center;">
                                <img src="${s.photo || 'https://via.placeholder.com/40?text=S'}" style="width:40px; height:40px; border-radius:50%; margin-right:10px; object-fit:cover;">
                                <div><strong>${s.name}</strong><br><span style="font-size:11px; color:#666;">${s.class || 'Student'}</span></div>
                            </div>
                            <div style="display:flex; gap:5px;">
                                <button class="btn-whatsapp btn-like" onclick="sendBirthdayWish('wa', ${s.id})"><i class="fab fa-whatsapp"></i></button>
                                <button class="btn-sms btn-like" onclick="sendBirthdayWish('sms', ${s.id})"><i class="fas fa-sms"></i></button>
                                <button class="btn-mail btn-like" onclick="sendBirthdayWish('mail', ${s.id})"><i class="fas fa-envelope"></i></button>
                            </div>
                        </div>
                    `;
                });
                birthdayBox.style.display = 'block';
            } else {
                birthdayBox.style.display = 'none';
            }
            
            const classCounts = activeStudents.reduce((acc, student) => { const className = student.class || 'Unassigned'; acc[className] = (acc[className] || 0) + 1; return acc; }, {}); 
            const classListEl = document.getElementById('classStrengthList'); classListEl.innerHTML = ''; 
            Object.entries(classCounts).sort().forEach(([className, count]) => { classListEl.innerHTML += `<li onclick="showClassStudents('${className}')"><strong>${className}:</strong> <span>${count} students</span></li>`; }); 
            
            let monthlyCollected = 0, monthlyDueAmount = 0, yearlyCollected = 0, yearlyDueAmount = 0; 
            const currentYear = new Date().getFullYear(), currentMonthStr = `${currentYear}-${(new Date().getMonth() + 1).toString().padStart(2, '0')}`; 
            
            students.forEach(student => {
                const feeStartDate = getFeeCalculationStartDate(student);
                // Loop through all 12 months of the year
                for (let i = 0; i < 12; i++) { 
                    const monthStr = `${currentYear}-${(i + 1).toString().padStart(2, '0')}`; 
                    
                    // Only consider for dues if student was active during this month and after effective joining/reactivation date
                    if (wasStudentActiveDuringMonth(student, monthStr)) {
                        if (fees[monthStr]?.[student.id]?.status === 'paid') { 
                            if (monthStr === currentMonthStr) monthlyCollected += fees[monthStr][student.id].amount; 
                            yearlyCollected += fees[monthStr][student.id].amount; 
                        } else if (isMonthDue(monthStr)) { 
                            const studentFee = student.fee_amount || DEFAULT_FEE; 
                            if (monthStr === currentMonthStr) monthlyDueAmount += studentFee; 
                            yearlyDueAmount += studentFee; 
                        } 
                    }
                }
            });
            
            document.getElementById('dashboardYearlySummary').innerHTML = `<div><h4>Collected</h4><p class="summary-collected">₹${yearlyCollected}</p></div><div><h4>Due</h4><p class="summary-due">₹${yearlyDueAmount}</p></div>`; 
            document.getElementById('financeOverviewNumbers').innerHTML = `<div><h4>Collected</h4><p class="summary-collected">₹${monthlyCollected}</p></div><div><h4>Due</h4><p class="summary-due">₹${monthlyDueAmount}</p></div>`;
            
            const dueTableBody = document.querySelector('#dueFeeTable tbody'); 
            const dueMessageEl = document.getElementById('dueFeeMessage'); 
            dueTableBody.innerHTML = '';
            
            const defaulters = students.map(s => {
                return { student: s, months: getDueMonthsList(s.id) };
            }).filter(item => item.months.length > 0);

            if (defaulters.length === 0) {
                 dueMessageEl.textContent = "No pending dues.";
            } else {
                 dueMessageEl.textContent = `(${defaulters.length}) students have pending dues.`;
                 defaulters.forEach(item => {
                     const monthsStr = item.months.join(", ");
                     const studentHtml = getStudentHtml(item.student);
                     const dueDisplay = `<div style="margin-top:5px; font-size:11px; color:#dc2626; font-weight:600; line-height:1.4;">Due: ${monthsStr}</div>`;
                     
                     // We need to pass the most recent due month for the messaging buttons
                     const latestDueMonth = item.months.length > 0 ? getMonthStrFromFormat(item.months[0]) : currentMonthStr; 
                     
                     dueTableBody.innerHTML += `
                        <tr>
                            <td>
                                ${studentHtml}
                                ${dueDisplay}
                            </td>
                            <td class="action-buttons">
                                ${getContactButtons(item.student.id, latestDueMonth)}
                            </td>
                        </tr>`; 
                 });
            }
            
            const ctx = document.getElementById('financeChart').getContext('2d'); if (financeChartInstance) financeChartInstance.destroy();
            financeChartInstance = new Chart(ctx, { type: 'doughnut', data: { labels: ['Collected', 'Due'], datasets: [{ data: [monthlyCollected, monthlyDueAmount], backgroundColor: ['#28a745', '#dc3545'], hoverOffset: 4 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' }, title: { display: true, text: `Summary for ${formatMonthYear(currentMonthStr)}` } } } });
        }
        
        // Utility to convert 'Month Year' back to 'YYYY-MM'
        function getMonthStrFromFormat(formattedMonth) {
            const parts = formattedMonth.split(' ');
            if (parts.length !== 2) return null;
            const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
            const monthIndex = monthNames.findIndex(name => name === parts[0]);
            if (monthIndex === -1) return null;
            const month = (monthIndex + 1).toString().padStart(2, '0');
            const year = parts[1];
            return `${year}-${month}`;
        }


        function exportDashboardPDF() {
            const activeStudents = students.filter(s => s.status.isActive);
            const currentYear = new Date().getFullYear();
            const currentMonthStr = `${currentYear}-${(new Date().getMonth() + 1).toString().padStart(2, '0')}`;
            let monthlyCollected = 0, monthlyDueAmount = 0, yearlyCollected = 0, yearlyDueAmount = 0;
            
            students.forEach(student => {
                for (let i = 0; i < 12; i++) {
                    const monthStr = `${currentYear}-${(i + 1).toString().padStart(2, '0')}`;
                    
                    if (wasStudentActiveDuringMonth(student, monthStr)) {
                        if (fees[monthStr]?.[student.id]?.status === 'paid') {
                            if (monthStr === currentMonthStr) monthlyCollected += fees[monthStr][student.id].amount;
                            yearlyCollected += fees[monthStr][student.id].amount;
                        } else if (isMonthDue(monthStr)) {
                            const studentFee = student.fee_amount || DEFAULT_FEE;
                            if (monthStr === currentMonthStr) monthlyDueAmount += studentFee;
                            yearlyDueAmount += studentFee;
                        }
                    }
                }
            });
            
            const classCounts = activeStudents.reduce((acc, student) => { const className = student.class || 'Unassigned'; acc[className] = (acc[className] || 0) + 1; return acc; }, {});
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            let y = 20;
            doc.setFontSize(18); doc.setFont("helvetica", "bold"); doc.text(INSTITUTE_NAME, 105, y, {align: "center"}); y += 10;
            doc.setFontSize(14); doc.text("Complete Dashboard Report", 105, y, {align: "center"}); y += 8;
            doc.setFontSize(10); doc.setFont("helvetica", "normal"); doc.text(`Generated: ${new Date().toLocaleDateString('en-IN')}`, 105, y, {align: "center"}); y += 15;
            doc.setFontSize(12); doc.setFont("helvetica", "bold"); doc.text("Student Statistics", 15, y); y += 7;
            doc.setFontSize(11); doc.setFont("helvetica", "normal");
            doc.text(`Total Students: ${students.length}`, 20, y); y += 6;
            doc.text(`Active Students: ${activeStudents.length}`, 20, y); y += 6;
            doc.text(`Inactive Students: ${students.length - activeStudents.length}`, 20, y); y += 12;
            doc.setFontSize(12); doc.setFont("helvetica", "bold"); doc.text("Financial Overview", 15, y); y += 7;
            doc.setFontSize(11); doc.setFont("helvetica", "normal");
            doc.text(`Current Month (${formatMonthYear(currentMonthStr)}) Collected: Rs. ${monthlyCollected}`, 20, y); y += 6;
            doc.text(`Current Month Due: Rs. ${monthlyDueAmount}`, 20, y); y += 6;
            doc.text(`Yearly Collected: Rs. ${yearlyCollected}`, 20, y); y += 6;
            doc.text(`Yearly Due: Rs. ${yearlyDueAmount}`, 20, y); y += 12;
            doc.setFontSize(12); doc.setFont("helvetica", "bold"); doc.text("Class Strength", 15, y); y += 7;
            doc.setFontSize(11); doc.setFont("helvetica", "normal");
            Object.entries(classCounts).sort().forEach(([className, count]) => { doc.text(`${className}: ${count} students`, 20, y); y += 6; });
            doc.save(`Dashboard_Full_Report_${currentMonthStr}.pdf`);
        }

        function generateReport() { 
            const type = document.getElementById('reportType').value;
            const summaryEl = document.getElementById('reportSummary');
            const tableEl = document.getElementById('reportTable');
            const tableHead = tableEl.querySelector('thead');
            const tableBody = tableEl.querySelector('tbody');
            const exportBtn = document.getElementById('exportReportBtn');

            tableHead.innerHTML = ''; tableBody.innerHTML = ''; 
            summaryEl.style.display = 'flex'; tableEl.style.display = 'table'; 
            exportBtn.style.display = 'inline-block'; 

            let totalCollected = 0, totalDue = 0; 
            
            if (type === 'monthly') { 
                const month = document.getElementById('reportMonth').value; 
                if (!month) { Swal.fire('Alert','Please select a month.', 'warning'); return; } 
                tableHead.innerHTML = `<tr><th>Student Name</th><th>Status</th><th>Amount</th><th>Action</th></tr>`; 
                const monthIsDue = isMonthDue(month); 
                
                students.forEach(student => { 
                    // Only show if student was active during this month
                    if (!wasStudentActiveDuringMonth(student, month)) return;
                    
                    const feeRecord = fees[month]?.[student.id]; 
                    let status = 'Pending', amount = `₹0`, rowClass = 'pending'; 
                    if (feeRecord?.status === 'paid') { 
                        status = `Paid on ${new Date(feeRecord.date).toLocaleDateString('en-IN')}`; 
                        amount = `₹${feeRecord.amount}`; 
                        rowClass = 'paid'; 
                        totalCollected += feeRecord.amount; 
                    } else if (monthIsDue) { 
                        status = 'Due'; 
                        const studentFee = student.fee_amount || DEFAULT_FEE; 
                        amount = `₹${studentFee}`; 
                        rowClass = 'unpaid'; 
                        totalDue += studentFee; 
                    } 
                    tableBody.innerHTML += `<tr class="${rowClass}"><td>${getStudentHtml(student)}</td><td>${status}</td><td>${amount}</td><td class="action-buttons">${status === 'Due' ? getContactButtons(student.id, month) : ''}</td></tr>`; 
                }); 
                summaryEl.innerHTML = `<div><h4>Total Collected</h4><p class="summary-collected">₹${totalCollected}</p></div><div><h4>Total Due</h4><p class="summary-due">₹${totalDue}</p></div>`; 
            } 
            else if (type === 'yearly') { 
                const year = document.getElementById('reportYear').value; 
                if (!year) { Swal.fire('Alert', 'Please enter a year.', 'warning'); return; } 
                tableHead.innerHTML = `<tr><th>Student Name</th><th>Total Paid</th><th>Months Due</th></tr>`; 
                
                students.forEach(student => { 
                    let studentTotalPaid = 0, studentMonthsDue = 0; 
                    for(let i=0; i<12; i++) { 
                        const monthStr = `${year}-${(i+1).toString().padStart(2, '0')}`; 
                        
                        if (wasStudentActiveDuringMonth(student, monthStr)) {
                            if (fees[monthStr]?.[student.id]?.status === 'paid') { 
                                studentTotalPaid += fees[monthStr][student.id].amount; 
                            } else if (isMonthDue(monthStr)) { // Only count as due if it's currently due
                                studentMonthsDue++; 
                            } 
                        }
                    } 
                    totalCollected += studentTotalPaid; 
                    totalDue += studentMonthsDue * (student.fee_amount || DEFAULT_FEE); 
                    tableBody.innerHTML += `<tr><td>${getStudentHtml(student)}</td><td>₹${studentTotalPaid}</td><td>${studentMonthsDue}</td></tr>`; 
                }); 
                summaryEl.innerHTML = `<div><h4>Total Collected</h4><p class="summary-collected">₹${totalCollected}</p></div><div><h4>Total Due</h4><p class="summary-due">₹${totalDue}</p></div>`; 
            } 
        }

        function exportReportPDF() {
            const type = document.getElementById('reportType').value;
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            let y = 20;
            doc.setFontSize(16); doc.setFont("helvetica", "bold"); doc.text(INSTITUTE_NAME, 105, y, {align: "center"}); y += 10;
            if (type === 'monthly') {
                const month = document.getElementById('reportMonth').value;
                if(!month) return;
                doc.setFontSize(12); doc.text(`Monthly Report: ${formatMonthYear(month)}`, 105, y, {align: "center"}); y += 15;
                doc.setFontSize(10); doc.setFont("helvetica", "bold");
                doc.text("Student Name", 15, y); doc.text("Status", 80, y); doc.text("Amount", 150, y);
                doc.line(15, y+2, 195, y+2); y += 8;
                const monthIsDue = isMonthDue(month);
                let totalCollected = 0, totalDue = 0;
                doc.setFont("helvetica", "normal");
                students.forEach(student => {
                    if (!wasStudentActiveDuringMonth(student, month)) return;
                    const feeRecord = fees[month]?.[student.id];
                    let status = 'Pending', amount = '0';
                    if (feeRecord?.status === 'paid') { status = `Paid (${feeRecord.mode || 'Cash'})`; amount = `${feeRecord.amount}`; totalCollected += feeRecord.amount; } 
                    else if (monthIsDue) { status = 'Due'; const f = student.fee_amount || DEFAULT_FEE; amount = `${f}`; totalDue += f; }
                    doc.text(student.name, 15, y); doc.text(status, 80, y); doc.text(amount, 150, y); y += 6;
                    if(y > 280) { doc.addPage(); y = 20; }
                });
                y += 5; doc.line(15, y, 195, y); y += 8;
                doc.setFont("helvetica", "bold"); doc.text(`Total Collected: ${totalCollected}`, 15, y); doc.text(`Total Due: ${totalDue}`, 80, y);
                doc.save(`Monthly_Report_${month}.pdf`);
            } else if (type === 'yearly') {
                const year = document.getElementById('reportYear').value;
                if(!year) return;
                doc.setFontSize(12); doc.text(`Yearly Report: ${year}`, 105, y, {align: "center"}); y += 15;
                doc.setFontSize(10); doc.setFont("helvetica", "bold");
                doc.text("Student Name", 15, y); doc.text("Total Paid", 100, y); doc.text("Months Due", 150, y);
                doc.line(15, y+2, 195, y+2); y += 8;
                let totalCollected = 0;
                doc.setFont("helvetica", "normal");
                students.forEach(student => {
                    let studentTotal = 0, dueMonths = 0;
                    for(let i=0; i<12; i++) {
                        const m = `${year}-${(i+1).toString().padStart(2, '0')}`;
                        if (wasStudentActiveDuringMonth(student, m)) {
                            if(fees[m]?.[student.id]?.status === 'paid') studentTotal += fees[m][student.id].amount;
                            else if(isMonthDue(m)) dueMonths++;
                        }
                    }
                    totalCollected += studentTotal;
                    doc.text(student.name, 15, y); doc.text(`${studentTotal}`, 100, y); doc.text(`${dueMonths}`, 150, y); y += 6;
                    if(y > 280) { doc.addPage(); y = 20; }
                });
                y += 5; doc.line(15, y, 195, y); y += 8;
                doc.setFont("helvetica", "bold"); doc.text(`Grand Total Collected: ${totalCollected}`, 15, y);
                doc.save(`Yearly_Report_${year}.pdf`);
            }
        }
        
        function searchTable(inputId, tableId) { 
            const input = document.getElementById(inputId), filter = input.value.toUpperCase(), table = document.getElementById(tableId), tr = table.getElementsByTagName("tr"); 
            for (let i = 1; i < tr.length; i++) { 
                const rowText = tr[i].textContent || tr[i].innerText; 
                if (rowText.toUpperCase().indexOf(filter) > -1) { tr[i].style.display = ""; } else { tr[i].style.display = "none"; } 
            } 
        }
        
        async function saveFee() { 
            const studentId = parseInt(document.getElementById('feeStudentId').value), month = document.getElementById('feeRecordMonth').value, amount = parseFloat(document.getElementById('feeAmount').value), date = document.getElementById('feeDate').value;
            const mode = document.getElementById('paymentMode').value;
            const txnId = document.getElementById('transactionId').value.trim();

            if (isNaN(amount) || amount <= 0) { Swal.fire('Error','Invalid amount.', 'error'); return; } if (!date) { Swal.fire('Error','Select date.', 'error'); return; } 
            if (!fees[month]) fees[month] = {}; 
            fees[month][studentId] = { status: 'paid', amount, date, mode: mode, transactionId: txnId }; 
            await saveData(); closeModal('feeModal'); 
            Swal.fire({ 
                title: 'Payment Recorded!', 
                html: `<p>What would you like to do?</p>
                       <div style="display:flex; gap:5px; justify-content:center; flex-wrap:wrap;">
                         <button class="btn-like btn-receipt" onclick="generatePaymentReceipt(${studentId}, '${month}')">Receipt</button>
                         <button class="btn-like btn-whatsapp" onclick="sendMsg('wa', ${studentId}, '${month}', ${amount}, false)">WhatsApp</button>
                         <button class="btn-like btn-sms" onclick="sendMsg('sms', ${studentId}, '${month}', ${amount}, false)">SMS</button>
                         <button class="btn-like btn-mail" onclick="sendMsg('mail', ${studentId}, '${month}', ${amount}, false)">Email</button>
                       </div>`,
                icon: 'success', showConfirmButton: false, showCloseButton: true 
            }); 
            loadAllData(); 
        }

        function renderFees() { 
            const selectedMonth = document.getElementById('feeMonth').value, tableBody = document.querySelector('#feeTable tbody'); 
            tableBody.innerHTML = ''; if (!selectedMonth) return; 
            let totalCollected = 0, totalDueAmount = 0, dueCount = 0; const monthIsDue = isMonthDue(selectedMonth); 
            students.forEach(student => { 
                
                // Check if student was active during this month, otherwise skip for this fee view
                const wasActive = wasStudentActiveDuringMonth(student, selectedMonth);
                if (!wasActive) return;

                const feeRecord = fees[selectedMonth]?.[student.id], isPaid = feeRecord?.status === 'paid'; 
                const hasGlobalDue = checkGlobalDues(student.id);
                let rowClass = 'pending', statusText = 'Pending'; 
                if (isPaid) { totalCollected += feeRecord.amount; rowClass = 'paid'; statusText = `Paid (₹${feeRecord.amount})`; } 
                else if (monthIsDue) { dueCount++; totalDueAmount += student.fee_amount || DEFAULT_FEE; rowClass = 'unpaid'; statusText = 'Due'; } 
                if (hasGlobalDue) rowClass += ' has-dues-alert';
                const row = document.createElement('tr'); row.className = rowClass; 
                let actionButtons = isPaid ? `<button class="btn-receipt" onclick="generatePaymentReceipt(${student.id}, '${selectedMonth}')">Receipt</button> <button class="btn-warning" onclick="openFeeModal(${student.id}, '${selectedMonth}', true)">Edit</button><button class="btn-danger" onclick="unmarkFee(${student.id}, '${selectedMonth}')">Unmark</button>` : `<button class="btn-success" onclick="openFeeModal(${student.id}, '${selectedMonth}')">Record Payment</button>` + (monthIsDue ? getContactButtons(student.id, selectedMonth) : '');
                row.innerHTML = `<td>${getStudentHtml(student)}</td><td>${statusText}</td><td class="action-buttons">${actionButtons}</td>`; tableBody.appendChild(row); 
            }); 
            document.getElementById('feeSummary').innerHTML = `<div><h4>Collected</h4><p class="summary-collected">₹${totalCollected}</p></div><div><h4>Due (${dueCount} students)</h4><p class="summary-due">₹${totalDueAmount}</p></div>`; searchTable('searchFees', 'feeTable'); 
        }

        async function generatePaymentReceipt(studentId, monthStr) {
            const student = students.find(s => s.id === studentId); const feeRecord = fees[monthStr]?.[studentId]; if (!student || !feeRecord) return;
            const { jsPDF } = window.jspdf; const doc = new jsPDF({ orientation: 'portrait', unit: 'mm', format: [105, 148] }); 
            doc.setDrawColor(0); doc.setLineWidth(0.5); doc.rect(5, 5, 95, 138);
            let y = 15;
            if (instituteLogo) { doc.addImage(instituteLogo, 'JPEG', 42.5, 10, 20, 20); y = 35; }
            doc.setFontSize(14); doc.setFont("helvetica", "bold"); const titleLines = doc.splitTextToSize(INSTITUTE_NAME, 90); doc.text(titleLines, 52.5, y, {align: "center"}); y += (titleLines.length * 6);
            doc.setFontSize(12); doc.setFont("helvetica", "normal"); doc.text("PAYMENT RECEIPT", 52.5, y, {align: "center"}); doc.line(30, y+1, 75, y+1); y += 15;
            doc.setFontSize(10); const lineH = 8; doc.text(`Receipt No:`, 10, y); doc.text(`${Date.now().toString().slice(-6)}`, 40, y); y += lineH;
            doc.text(`Date:`, 10, y); doc.text(`${new Date().toLocaleDateString('en-IN')}`, 40, y); y += lineH;
            doc.text(`Student Name:`, 10, y); doc.setFont("helvetica", "bold"); doc.text(student.name, 40, y); doc.setFont("helvetica", "normal"); y += lineH;
            doc.text(`Class:`, 10, y); doc.text(student.class || 'N/A', 40, y); y += lineH;
            doc.text(`Month:`, 10, y); doc.setFont("helvetica", "bold"); doc.text(formatMonthYear(monthStr), 40, y); doc.setFont("helvetica", "normal"); y += lineH;
            doc.text(`Payment Mode:`, 10, y); doc.text(feeRecord.mode || 'Cash', 40, y); y += lineH;
            
            // --- NEW: Display Transaction ID on Receipt ---
            if (feeRecord.transactionId) {
                doc.text(`Txn ID:`, 10, y); 
                doc.text(feeRecord.transactionId, 40, y); 
                y += lineH;
            }

            y += 5; doc.setFontSize(12); 
            doc.text(`Amount Received:`, 10, y); doc.setFontSize(16); doc.setFont("helvetica", "bold"); doc.text(`Rs. ${feeRecord.amount}/-`, 50, y); y += 20;
            
            if (authorizedSignature) {
                doc.addImage(authorizedSignature, 'PNG', 50, y - 15, 40, 15);
            }

            doc.setFontSize(9); doc.setFont("helvetica", "italic"); doc.text(`Authorized Signature`, 70, y, {align:"center"}); doc.text(`(${MY_NAME})`, 70, y+5, {align:"center"});
            const fileName = `Receipt_${student.name.replace(/\s+/g, '_')}_${monthStr}.pdf`;
            if (navigator.canShare && navigator.share) { const pdfBlob = doc.output('blob'); const file = new File([pdfBlob], fileName, { type: 'application/pdf' }); if (navigator.canShare({ files: [file] })) { try { await navigator.share({ files: [file], title: 'Fee Receipt', text: `Payment receipt for ${student.name}` }); } catch (err) { doc.save(fileName); } } else { doc.save(fileName); } } else { doc.save(fileName); }
        }

        async function generateIDCard() {
            const name = document.getElementById('modalStudentName').textContent; const serial = document.getElementById('modalSerialNo').textContent; const student = students.find(s => s.serial_no == serial); if (!student) return;
            
            const issueDateInput = document.getElementById('idCardIssueDate').value;
            const endDateInput = document.getElementById('idCardEndDate').value;
            const issueDateStr = issueDateInput ? new Date(issueDateInput).toLocaleDateString('en-IN') : 'N/A';
            const endDateStr = endDateInput ? new Date(endDateInput).toLocaleDateString('en-IN') : null;
            const dobStr = student.dob ? new Date(student.dob).toLocaleDateString('en-IN') : '-';

            const { jsPDF } = window.jspdf; const doc = new jsPDF({ orientation: 'landscape', unit: 'mm', format: [86, 54] });
            
            doc.setFillColor(24, 90, 157); doc.rect(0, 0, 30, 54, 'F'); 
            
            if (student.photo) { doc.addImage(student.photo, 'JPEG', 5, 12, 20, 20); } else { doc.setFillColor(200, 200, 200); doc.circle(15, 22, 10, 'F'); doc.setFontSize(8); doc.text("No Photo", 15, 22, {align: 'center'}); }
            
            if (instituteLogo) { doc.saveGraphicsState(); doc.setGState(new doc.GState({ opacity: 0.1 })); doc.addImage(instituteLogo, 'JPEG', 40, 9, 36, 36); doc.restoreGraphicsState(); }

            doc.setTextColor(0, 0, 0); doc.setFontSize(7); doc.setFont("helvetica", "bold"); const headerLines = doc.splitTextToSize(INSTITUTE_NAME, 50); doc.text(headerLines, 58, 5, {align: "center"}); doc.setDrawColor(24, 90, 157); doc.line(35, 12, 80, 12);
            let yText = 16; const labelX = 35; const valX = 48; doc.setFontSize(7); 
            doc.setFont("helvetica", "bold"); doc.text("Name:", labelX, yText); doc.setFont("helvetica", "normal"); doc.text(student.name, valX, yText); yText += 3.5;
            doc.setFont("helvetica", "bold"); doc.text("ID No:", labelX, yText); doc.setFont("helvetica", "normal"); doc.text(student.serial_no.toString(), valX, yText); yText += 3.5;
            doc.setFont("helvetica", "bold"); doc.text("Class:", labelX, yText); doc.setFont("helvetica", "normal"); doc.text(student.class || '-', valX, yText); yText += 3.5;
            doc.setFont("helvetica", "bold"); doc.text("Phone:", labelX, yText); doc.setFont("helvetica", "normal"); doc.text(student.phone || '-', valX, yText); yText += 3.5;
            doc.setFont("helvetica", "bold"); doc.text("Addr:", labelX, yText); doc.setFont("helvetica", "normal"); const addrLines = doc.splitTextToSize(student.address || '-', 35); doc.text(addrLines, valX, yText); 
            
            yText += (addrLines.length * 3) + 1;
            
            // --- NEW DOB ROW ---
            doc.setFont("helvetica", "bold"); doc.text("DOB:", labelX, yText); 
            doc.setFont("helvetica", "normal"); doc.text(dobStr, valX, yText);
            yText += 3.5;
            
            // --- NEW ISSUE DATE ROW ---
            doc.setFontSize(6);
            doc.setFont("helvetica", "bold");
            let validText = `Issued: ${issueDateStr}`;
            if (endDateStr) validText += ` | Valid: ${endDateStr}`;
            doc.text(validText, 35, yText);

            if (authorizedSignature) {
                doc.addImage(authorizedSignature, 'PNG', 65, 38, 18, 6); 
            }

            doc.setFontSize(6); doc.setFont("helvetica", "bold"); doc.text("Auth. Signature:", 83, 44, {align: "right"}); doc.setFont("helvetica", "italic"); doc.text("Srikanta Banerjee", 83, 47, {align: "right"});
            doc.setFillColor(67, 206, 162); doc.rect(30, 49, 56, 5, 'F'); doc.setTextColor(255, 255, 255); doc.setFontSize(6); doc.setFont("helvetica", "bold"); doc.text("AUTHORIZED STUDENT CARD", 58, 52.5, {align: "center"});
            const fileName = `ID_Card_${student.name}.pdf`;
            if (navigator.canShare && navigator.share) { const pdfBlob = doc.output('blob'); const file = new File([pdfBlob], fileName, { type: 'application/pdf' }); if (navigator.canShare({ files: [file] })) { try { await navigator.share({ files: [file], title: 'Student ID Card', text: `ID Card for ${student.name}` }); } catch (err) { doc.save(fileName); } } else { doc.save(fileName); } } else { doc.save(fileName); }
        }

        function showClassStudents(className) { document.getElementById('classStudentsTitle').textContent = `Students in ${className} Class`; const tableBody = document.querySelector('#classStudentsTable tbody'); tableBody.innerHTML = ''; const classStudents = students.filter(s => s.status.isActive && (s.class || 'Unassigned') === className); classStudents.forEach(s => { tableBody.innerHTML += `<tr><td>${s.serial_no}</td><td>${getStudentHtml(s)}</td><td>${getContactButtons(s.id)}</td></tr>`; }); document.getElementById('classStudentsModal').style.display = 'block'; }
        function exportStudentDetailsAsPDF(studentId) { const student = students.find(s => s.id === studentId); if (!student) return; const { jsPDF } = window.jspdf; const doc = new jsPDF(); let y = 15; const addLine = (text, size, weight, margin) => { doc.setFontSize(size); doc.setFont('helvetica', weight); doc.text(text, 15, y); y += margin; if (y > 280) { doc.addPage(); y = 15; } }; doc.setFontSize(22); doc.setFont('helvetica', 'bold'); doc.text(`${INSTITUTE_NAME}`, 105, y, { align: 'center' }); y += 8; if (student.photo) { doc.addImage(student.photo, 'JPEG', 160, 15, 30, 30); } doc.setFontSize(14); doc.text('Student Report', 105, y, { align: 'center' }); y += 12; addLine(`Student Name: ${student.name}`, 16, 'bold', 8); addLine(`Serial No: ${student.serial_no}`, 11, 'normal', 6); addLine(`Class: ${student.class || 'N/A'}`, 11, 'normal', 6); addLine(`Monthly Fee: ₹${student.fee_amount || DEFAULT_FEE}`, 11, 'normal', 6); addLine(`Joining Date: ${new Date(student.joining_date).toLocaleDateString('en-IN')}`, 11, 'normal', 10); addLine('Contact Information', 14, 'bold', 8); addLine(`Guardian: ${student.guardian || 'N/A'}`, 11, 'normal', 6); addLine(`Phone: ${student.phone || 'N/A'}`, 11, 'normal', 6); addLine(`Email: ${student.email || 'N/A'}`, 11, 'normal', 6); addLine(`Address: ${student.address || 'N/A'}`, 11, 'normal', 10); addLine('Status History', 14, 'bold', 8); if (student.status.history && student.status.history.length > 0) { student.status.history.forEach(entry => { addLine(`${entry.status} on ${new Date(entry.date).toLocaleDateString('en-IN')} - Note: ${entry.note || 'N/A'}`, 10, 'normal', 6); }); } else { addLine('No status history found.', 10, 'italic', 6); } y += 4; addLine('Fee Payment History', 14, 'bold', 8); let feesFound = false; Object.keys(fees).sort().forEach(month => { 
            if(wasStudentActiveDuringMonth(student, month)) {
                const feeRecord = fees[month]?.[student.id]; 
                if (feeRecord?.status === 'paid') { addLine(`${month}: ₹${feeRecord.amount} (Paid on ${new Date(feeRecord.date).toLocaleDateString('en-IN')} - ${feeRecord.mode || 'Cash'} ${feeRecord.transactionId ? '- Txn: '+feeRecord.transactionId : ''})`, 10, 'normal', 6); feesFound = true; } 
                else if (isMonthDue(month)) { addLine(`${month}: Due`, 10, 'normal', 6); feesFound = true; }
            }
        }); if (!feesFound) { addLine('No records found.', 10, 'italic', 6); } y += 4; addLine('Attendance Summary', 14, 'bold', 8); let presentCount = 0, absentCount = 0; Object.keys(attendance).forEach(date => { if (attendance[date]?.[student.id] === 'present') presentCount++; if (attendance[date]?.[student.id] === 'absent') absentCount++; }); addLine(`Total Present: ${presentCount}`, 10, 'normal', 6); addLine(`Total Absent: ${absentCount}`, 10, 'normal', 10); doc.save(`${student.name}_report.pdf`); }
        function resetApp() { Swal.fire({ title: 'Are you sure?', text: "This will permanently delete ALL data!", icon: 'warning', showCancelButton: true, confirmButtonColor: '#d33', confirmButtonText: 'Yes, Reset Everything!' }).then(async (result) => { if (result.isConfirmed) { await dbClear(); localStorage.clear(); students = []; attendance = {}; fees = {}; studentSerialCounter = 1; loadAllData(); Swal.fire('Deleted!', 'Application has been reset.', 'success'); } }) }
        function toggleReportInputs() { const type = document.getElementById('reportType').value; document.getElementById('reportMonth-group').style.display = type === 'monthly' ? 'block' : 'none'; document.getElementById('reportYear-group').style.display = type === 'yearly' ? 'block' : 'none'; }
        
        function loadStudentsList() { 
            const listBody = document.getElementById('allStudentsList'); listBody.innerHTML = ''; 
            students.forEach(student => { 
                const statusBtnText = student.status.isActive ? 'Deactivate' : 'Activate'; 
                const hasGlobalDue = checkGlobalDues(student.id);
                let rowClass = student.status.isActive ? '' : 'inactive-student'; 
                if (student.status.isActive && hasGlobalDue) rowClass += ' has-dues-alert';
                let timeDisplay = '';
                if(student.class_time) { const [h, m] = student.class_time.split(':'); const ampm = h >= 12 ? 'PM' : 'AM'; const h12 = h % 12 || 12; timeDisplay = `${h12}:${m} ${ampm}`; }
                const dayTimeStr = (student.class_day || student.class_time) ? `<br><span class="student-time-sub">${student.class_day || ''} ${timeDisplay}</span>` : '';
                listBody.innerHTML += `<tr class="${rowClass}"><td>${student.serial_no}</td><td>${getStudentHtml(student)}</td><td>${student.class || 'N/A'}${dayTimeStr}</td><td>₹${student.fee_amount || DEFAULT_FEE}</td><td style="min-width: 160px;">${getAllContactButtons(student)}</td><td>${student.status.isActive ? 'Active' : 'Inactive'}</td><td class="action-buttons"><button class="${student.status.isActive ? 'btn-info' : 'btn-success'}" onclick="openStatusChangeModal(${student.id}, ${!student.status.isActive})">${statusBtnText}</button> <button class="btn-warning" onclick="openEditStudentModal(${student.id})">Edit</button></td></tr>`; 
            }); 
        }

        function renderAttendance() { const date = document.getElementById('attendanceDate').value, tableBody = document.querySelector('#attendanceTable tbody'); tableBody.innerHTML = ''; if (!date) return; students.filter(s => s.status.isActive).forEach(student => { const status = attendance[date]?.[student.id], statusText = status === 'present' ? 'Present' : (status === 'absent' ? 'Absent' : 'Not Marked'), statusClass = status === 'present' ? 'status-present' : (status === 'absent' ? 'status-absent' : ''); const hasGlobalDue = checkGlobalDues(student.id); const rowClass = hasGlobalDue ? 'has-dues-alert' : ''; tableBody.innerHTML += `<tr class="${rowClass}"><td>${getStudentHtml(student)}</td><td class="${statusClass}">${statusText}</td><td class="action-buttons"><button class="btn-success" onclick="markAttendance(${student.id}, 'present')">Present</button><button class="btn-danger" onclick="markAttendance(${student.id}, 'absent')">Absent</button><button class="btn-secondary" onclick="markAttendance(${student.id}, 'clear')">Clear</button></td></tr>`; }); searchTable('searchAttendance', 'attendanceTable'); }
        async function markAttendance(studentId, status) { const date = document.getElementById('attendanceDate').value; if (!date) { Swal.fire('Alert','Please select a date.', 'warning'); return; } if (!attendance[date]) attendance[date] = {}; if (status === 'clear') delete attendance[date][studentId]; else attendance[date][studentId] = status; await saveData(); renderAttendance(); }
        function unmarkFee(studentId, month) { Swal.fire({ title: 'Unmark Payment?', text: "Mark fee as unpaid?", icon: 'warning', showCancelButton: true, confirmButtonText: 'Yes' }).then(async (result) => { if (result.isConfirmed && fees[month]?.[studentId]) { delete fees[month][studentId]; await saveData(); loadAllData(); Swal.fire('Success', 'Payment removed.', 'success'); } }); }
        function openFeeModal(studentId, month, isEdit = false) { const modal = document.getElementById('feeModal'), amountInput = document.getElementById('feeAmount'), dateInput = document.getElementById('feeDate'); document.getElementById('feeStudentId').value = studentId; document.getElementById('feeRecordMonth').value = month; const txnInput = document.getElementById('transactionId'); if (isEdit) { const record = fees[month][studentId]; document.getElementById('feeModalTitle').textContent = 'Edit Fee Payment'; amountInput.value = record.amount; txnInput.value = record.transactionId || ''; } else { const student = students.find(s => s.id === studentId); document.getElementById('feeModalTitle').textContent = 'Record Fee Payment'; amountInput.value = student.fee_amount || DEFAULT_FEE; txnInput.value = ''; } dateInput.valueAsDate = new Date(); modal.style.display = 'block'; }
        function openEditStudentModal(id) { const student = students.find(s => s.id === id); if(!student) return; document.getElementById('editStudentId').value = student.id; document.getElementById('editStudentName').value = student.name; document.getElementById('editStudentClass').value = student.class; document.getElementById('editStudentDay').value = student.class_day || ""; document.getElementById('editStudentTime').value = student.class_time || ""; document.getElementById('editStudentFee').value = student.fee_amount; document.getElementById('editStudentEmail').value = student.email; document.getElementById('editGuardianName').value = student.guardian; document.getElementById('editPhone').value = student.phone; document.getElementById('editAddress').value = student.address; document.getElementById('editStudentDOB').value = student.dob || ""; currentEditPhotoBase64 = null; document.getElementById('editStudentCamera').value = ""; document.getElementById('editStudentGallery').value = ""; if(student.photo) { document.getElementById('editPhotoPreview').src = student.photo; } else { document.getElementById('editPhotoPreview').src = 'https://via.placeholder.com/100?text=No+Photo'; } document.getElementById('editStudentModal').style.display = 'block'; }
        async function saveStudentChanges() { const id = parseInt(document.getElementById('editStudentId').value), student = students.find(s => s.id === id); if(!student) return; student.name = document.getElementById('editStudentName').value.trim(); if(!student.name) { Swal.fire('Error','Student name is required.', 'error'); return; } if(currentEditPhotoBase64) { student.photo = currentEditPhotoBase64; } student.class = document.getElementById('editStudentClass').value.trim(); student.class_day = document.getElementById('editStudentDay').value; student.class_time = document.getElementById('editStudentTime').value; student.fee_amount = parseFloat(document.getElementById('editStudentFee').value) || DEFAULT_FEE; student.email = document.getElementById('editStudentEmail').value.trim(); student.guardian = document.getElementById('editGuardianName').value.trim(); student.phone = document.getElementById('editPhone').value.trim(); student.address = document.getElementById('editAddress').value.trim(); student.dob = document.getElementById('editStudentDOB').value; await saveData(); closeModal('editStudentModal'); loadAllData(); Swal.fire('Saved', 'Student details updated.', 'success'); }
        
        function showStudentDetails(studentId) { 
            const student = students.find(s => s.id === studentId); 
            if (!student) return; 
            document.getElementById('modalStudentName').textContent = student.name; 
            document.getElementById('modalSerialNo').textContent = student.serial_no; 
            document.getElementById('modalClass').textContent = student.class || 'N/A'; 
            document.getElementById('modalDayTime').textContent = (student.class_day || '') + " " + (student.class_time || ''); 
            document.getElementById('modalFeeAmount').textContent = `₹${student.fee_amount || DEFAULT_FEE}`; 
            document.getElementById('modalGuardianName').textContent = student.guardian || 'N/A'; 
            document.getElementById('modalPhone').innerHTML = student.phone ? `${student.phone}` : 'N/A'; 
            document.getElementById('modalEmail').innerHTML = student.email ? `${student.email}` : 'N/A'; 
            document.getElementById('modalAddress').textContent = student.address || 'N/A'; 
            document.getElementById('modalDOB').textContent = student.dob ? new Date(student.dob).toLocaleDateString('en-IN') : 'N/A'; 
            document.getElementById('modalJoiningDate').textContent = new Date(student.joining_date).toLocaleDateString('en-IN'); 
            
            const modalImg = document.getElementById('modalStudentPhoto'); 
            if(student.photo) { modalImg.src = student.photo; modalImg.style.display = 'inline-block'; } 
            else { modalImg.src = 'https://via.placeholder.com/100?text=No+Photo'; } 
            
            const historyList = document.getElementById('modalStatusHistory'); 
            historyList.innerHTML = ''; 
            if (student.status.history && student.status.history.length > 0) { 
                student.status.history.forEach(entry => { 
                    const color = entry.status === 'Active' ? 'green' : 'red'; 
                    historyList.innerHTML += `<li><strong style="color:${color};">${entry.status}</strong> on ${new Date(entry.date).toLocaleDateString('en-IN')}<br><em style="font-size:0.9em;color:#555;">Note: ${entry.note || 'No note'}</em></li>`; 
                }); 
            } else { historyList.innerHTML = '<li>No history found.</li>'; } 
            
            const presentList = document.getElementById('modalPresentList'), absentList = document.getElementById('modalAbsentList'); 
            presentList.innerHTML = absentList.innerHTML = ''; 
            
            Object.keys(attendance).sort().reverse().forEach(date => { 
                const dateObj = new Date(date);
                const dayName = dateObj.toLocaleDateString('en-IN', { weekday: 'long' });
                const formattedDate = `${dateObj.toLocaleDateString('en-IN')} (${dayName})`;
                
                if (attendance[date]?.[student.id] === 'present') {
                    presentList.innerHTML += `<li>${formattedDate}</li>`; 
                } else if (attendance[date]?.[student.id] === 'absent') {
                    absentList.innerHTML += `<li>${formattedDate}</li>`; 
                }
            }); 
            
            if(!presentList.innerHTML) presentList.innerHTML = '<li>No records found</li>'; 
            if(!absentList.innerHTML) absentList.innerHTML = '<li>No records found</li>'; 
            
            const paidList = document.getElementById('modalPaidList'); 
            paidList.innerHTML = ''; 
            Object.keys(fees).sort().reverse().forEach(month => { 
                if(wasStudentActiveDuringMonth(student, month)) {
                    const feeRecord = fees[month]?.[student.id]; 
                    if (feeRecord?.status === 'paid') { 
                        let txnDisplay = feeRecord.transactionId ? ` <br><span style="font-size:0.85em; color:#666;">Txn ID: ${feeRecord.transactionId}</span>` : ''; 
                        paidList.innerHTML += `<li>${month}: ₹${feeRecord.amount} (${feeRecord.mode || 'Cash'}) - ${new Date(feeRecord.date).toLocaleDateString('en-IN')}${txnDisplay}</li>`; 
                    } 
                    else if (isMonthDue(month)) { paidList.innerHTML += `<li class="unpaid">${month}: Due</li>`; }
                }
            }); 
            if(!paidList.innerHTML) paidList.innerHTML = '<li>No records found</li>'; 
            
            document.getElementById('exportPdfBtn').onclick = () => exportStudentDetailsAsPDF(studentId); 
            document.getElementById('studentDetailsModal').style.display = 'block'; 
        }

        function closeModal(modalId) { document.getElementById(modalId).style.display = 'none'; }
        window.onclick = (event) => { if (event.target.classList.contains('modal')) { event.target.style.display = 'none'; } };
    </script>
</body>
</html>